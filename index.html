/* ================== CONFIG ================== */
const API_URL = 'https://script.google.com/macros/s/AKfycbyp8hH9seYgTW_H59pcR4OpvdQbpLhH9F67oYvOQoUpDsjYsemNDgel2sMameaxTdKy/exec'; // ← THAY bằng Web App URL
const API_KEY = '';   // nếu có
const state = { page: 1, pageSize: 15, q: '', group: '' };
const APP_VERSION = '4';

/* ================== UTILS ================== */
const fmtVND = n => (Number(n) || 0).toLocaleString('vi-VN') + ' đ';
const esc = s => (s || '').replace(/&/g, '&amp;').replace(/</g, '&lt;')
                          .replace(/>/g, '&gt;').replace(/"/g, '&quot;');
function hiRes(url, w = 600) { return (url || '').replace(/=s\d+/, '=s' + w); }
function qs(extra = {}) { const p = new URLSearchParams(extra); if (API_KEY) p.set('key', API_KEY); return p.toString(); }

/* ================== CART ================== */
let cart = [];
function saveCart() { localStorage.setItem('pcg_cart', JSON.stringify(cart)); updateCartUI(); }
function loadCart() {
  const ver = localStorage.getItem('pcg_version');
  if (ver !== APP_VERSION) {
    localStorage.setItem('pcg_version', APP_VERSION);
    localStorage.removeItem('pcg_cart');
  }
  cart = JSON.parse(localStorage.getItem('pcg_cart') || '[]');
  updateCartUI();
}
function updateCartUI() {
  const box = document.getElementById('cartListSide');
  const countEl = document.getElementById('cartCount');
  if (!box || !countEl) return;

  if (!cart.length) { box.innerHTML = 'Chưa có sản phẩm.'; countEl.textContent = '0'; }
  else {
    box.innerHTML = cart.map((it, i) => `
      <div class="d-flex align-items-center gap-2 border-bottom py-2">
        <img src="${esc(it.img)}" style="width:46px;height:46px;border-radius:6px;object-fit:cover">
        <div class="flex-grow-1">
          <div>${esc(it.id)}</div>
          <div class="text-muted small">${esc(it.details || '')}</div>
          <div>${fmtVND(it.price)} × ${it.qty}</div>
        </div>
        <div class="d-flex align-items-center gap-1">
          <button class="btn btn-outline-secondary btn-sm" data-dec="${i}">-</button>
          <span>${it.qty}</span>
          <button class="btn btn-outline-secondary btn-sm" data-inc="${i}">+</button>
          <button class="btn btn-link text-danger" data-rm="${i}">✕</button>
        </div>
      </div>
    `).join('');
    const totalQty = cart.reduce((s, it) => s + it.qty, 0);
    countEl.textContent = String(totalQty);
  }
  const totalEl = document.getElementById('cartTotalSide');
  if (totalEl) totalEl.textContent = fmtVND(cart.reduce((s, it) => s + (Number(it.price) || 0) * it.qty, 0));
}

/* ================== FACTORIES (quảng cáo xưởng) ================== */
const FACTORIES = [
  { name: 'Xưởng 1 – Tem kim loại', desc: 'Men màu, mạ vàng, đúc nổi 3D', img: 'https://picsum.photos/120/120?random=11', link: 'https://temkimloai.nhanmac3a.vn/huy-hieu' },
  { name: 'Xưởng 2 – In UV',        desc: 'In chi tiết sắc nét',           img: 'https://picsum.photos/120/120?random=12', link: '#' },
  { name: 'Xưởng 3 – Đúc huy hiệu',  desc: 'Đúc nổi 3D, sản lượng lớn',     img: 'https://picsum.photos/120/120?random=13', link: '#' },
  { name: 'Xưởng 4 – In offset',     desc: 'Bao bì – hộp – tem nhãn',       img: 'https://picsum.photos/120/120?random=14', link: '#' },
  { name: 'Xưởng 5 – Quà tặng',      desc: 'Quà tặng doanh nghiệp',         img: 'https://picsum.photos/120/120?random=15', link: '#' },
];
function renderFactories() {
  const box = document.getElementById('factoryList'); if (!box) return;
  box.innerHTML = FACTORIES.map(x => `
    <div class="factory-item">
      <img src="${esc(x.img)}" alt="">
      <div class="factory-meta">
        <div class="factory-name">${esc(x.name)}</div>
        <div class="factory-desc">${esc(x.desc)}</div>
        <div class="factory-actions">
          <a class="mini" href="${esc(x.link)}" target="_blank" rel="noopener">Xem xưởng</a>
          <a class="mini" href="https://zalo.me/0936169692" target="_blank" rel="noopener">Báo giá nhanh</a>
        </div>
      </div>
    </div>
  `).join('');
}

/* ================== GROUPS (danh mục) ================== */
let builtGroups = false;
function buildGroupsOnce(groups) {
  if (builtGroups) return;
  const box = document.getElementById('categoryBox'); if (!box) return;
  const all = `<button class="cat-btn ${!state.group ? 'active' : ''}" data-group="">Tất cả</button>`;
  const btns = (groups || []).map(g => {
    const val = (g || '').trim();
    const act = (state.group || '').toLowerCase() === val.toLowerCase() ? 'active' : '';
    return `<button class="cat-btn ${act}" data-group="${esc(val)}">${esc(val)}</button>`;
  }).join('');
  box.innerHTML = all + btns;
  box.addEventListener('click', e => {
    const btn = e.target.closest('.cat-btn'); if (!btn) return;
    state.group = (btn.dataset.group || '').trim();
    box.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    state.page = 1; fetchPage();
  });
  builtGroups = true;
}

/* ================== SKELETON ================== */
function renderSkeleton(n) {
  const grid = document.getElementById('productGrid'); if (!grid) return;
  grid.innerHTML = Array.from({ length: n }).map(() => `
    <div class="cardp">
      <div class="thumb" style="background:#eee;animation:pulseSk 1.2s infinite;"></div>
      <div class="meta">
        <div class="id" style="height:12px;background:#eee;border-radius:4px"></div>
        <div class="details" style="height:10px;background:#f3f3f3;border-radius:4px;margin-top:6px"></div>
        <div class="type-badge" style="background:#f3f3f3;border-color:#f3f3f3;color:transparent">TYPE</div>
        <div class="row-meta mt-1">
          <div class="price" style="height:12px;background:#eee;border-radius:4px;width:80px"></div>
          <div class="add-btn" style="background:#e0e0e0;color:#e0e0e0">+</div>
        </div>
      </div>
    </div>
  `).join('');
}

/* ================== DATA FETCH ================== */
function fetchPage() {
  renderSkeleton(state.pageSize);
  const url = `${API_URL}?` + qs({
    action: 'list', page: state.page, pageSize: state.pageSize,
    q: state.q || '', group: state.group || ''
  });
  fetch(url, { method: 'GET' })
    .then(r => r.json())
    .then(res => render(res))
    .catch(err => {
      console.error(err);
      render({ items: [], facets: { groups: [] }, page: 1, pageSize: state.pageSize, total: 0 });
    });
}

function render(res) {
  if (res?.facets?.groups) buildGroupsOnce(res.facets.groups);
  const grid = document.getElementById('productGrid'); if (!grid) return;

  const html = (res.items || []).map(it => {
    const img = hiRes(it.img, 600);
    const full = it.full || img;
    const note = it.chuy ? `<span class="note-badge">${esc(it.chuy)}</span>` : '';
    return `
      <div class="cardp" data-full="${esc(full)}">
        ${note}
        <img class="thumb" src="${esc(img)}" loading="lazy"
             onerror="this.src='https://via.placeholder.com/600x600?text=No+Image'">
        <div class="meta">
          <div class="id">${esc(it.id)}</div>
          <div class="details" title="${esc(it.details)}">${esc(it.details)}</div>
          <div class="type-badge">${esc(it.type || '')}</div>
          <div class="row-meta mt-1">
            <div class="price">${fmtVND(it.price)}</div>
            <button class="add-btn" title="Thêm"
                    data-add='${JSON.stringify(it).replace(/'/g, "&apos;")}'>+</button>
          </div>
        </div>
      </div>`;
  }).join('');

  grid.innerHTML = html || '<div class="text-muted">Không có sản phẩm.</div>';
}

/* ================== EVENTS ================== */
// Tìm kiếm
document.getElementById('searchBtn')?.addEventListener('click', () => {
  state.q = document.getElementById('searchBox')?.value.trim() || '';
  state.page = 1; fetchPage();
});
document.getElementById('searchBox')?.addEventListener('keypress', e => {
  if (e.key === 'Enter') { state.q = e.target.value.trim(); state.page = 1; fetchPage(); }
});

// Thêm giỏ & mở ảnh
document.getElementById('productGrid')?.addEventListener('click', e => {
  const addBtn = e.target.closest('.add-btn');
  if (addBtn) {
    e.stopPropagation(); e.preventDefault();
    const it = JSON.parse(addBtn.dataset.add.replace(/&apos;/g, "'"));
    const f = cart.find(x => x.id === it.id);
    if (f) f.qty += 1;
    else cart.push({ id: it.id, details: it.details, type: it.type, price: Number(it.price) || 0, img: it.img, qty: 1 });
    saveCart(); return;
  }
  const card = e.target.closest('.cardp');
  if (card) { const full = card.dataset.full; if (full) window.open(full, '_blank'); }
});

// Cart +/-/x
document.getElementById('cartListSide')?.addEventListener('click', e => {
  const inc = e.target.closest('[data-inc]'), dec = e.target.closest('[data-dec]'), rm = e.target.closest('[data-rm]');
  if (inc || dec || rm) { e.stopPropagation(); e.preventDefault(); }
  if (inc) { cart[inc.dataset.inc].qty++; saveCart(); }
  if (dec) { const i = dec.dataset.dec; cart[i].qty--; if (cart[i].qty <= 0) cart.splice(i, 1); saveCart(); }
  if (rm) { cart.splice(rm.dataset.rm, 1); saveCart(); }
});

// Phân trang
document.getElementById('prevBtn')?.addEventListener('click', () => { if (state.page > 1) { state.page--; fetchPage(); } });
document.getElementById('nextBtn')?.addEventListener('click', () => { state.page++; fetchPage(); });

// CTA báo giá nhanh (trong cột trái)
document.getElementById('ctaQuote')?.addEventListener('click', () => window.open('https://zalo.me/0936169692', '_blank'));

/* ================== INIT ================== */
document.addEventListener('DOMContentLoaded', () => {
  renderFactories();   // quảng cáo xưởng bên trái
  loadCart();          // khởi tạo giỏ
  fetchPage();         // tải trang đầu
});
