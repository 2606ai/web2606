<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>2606AI Marketplace</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;600;800&display=swap" rel="stylesheet">
<style>
:root{ --main:#0018a8; --accent:#d4af37; --bg:#f5f6fa; }
body{font-family:'Be Vietnam Pro',sans-serif;background:var(--bg);font-size:14px;padding-top:70px}
.container-fluid{max-width:1400px;margin:auto;}
.top-banner{background:#000;color:#fff;text-align:center;padding:6px;font-weight:600}

/* Header */
.site-header{
  background:#fff;padding:10px 15px;border-bottom:1px solid #eee;
  display:flex;align-items:center;justify-content:space-between;
  box-shadow:0 2px 6px rgba(0,0,0,.05);
  position:fixed;top:0;left:0;right:0;z-index:1055;height:70px;
}
.site-header img.logo{height:45px}
.site-header .brand-title{font-weight:800;font-size:18px;color:var(--main)}

/* Sidebar */
.sidebar-box{background:#fff;padding:12px;border-radius:8px;margin-bottom:15px;box-shadow:0 2px 4px rgba(0,0,0,.05)}
.sidebar-box h6{font-weight:700;font-size:15px;margin-bottom:8px}

/* Hero slide */
.hero{margin-bottom:15px}
.hero .big img{width:100%;height:300px;object-fit:cover;border-radius:8px}
.hero .small img{width:100%;height:145px;object-fit:cover;border-radius:8px;margin-bottom:10px}

/* Danh m·ª•c */
.category-box{background:#fff;border-radius:8px;padding:10px;box-shadow:0 2px 4px rgba(0,0,0,.05)}
.category-item{
  text-align:center;padding:10px;border-radius:10px;cursor:pointer;transition:.2s
}
.category-item:hover{background:#f5f5f5}
.category-item img{width:50px;height:50px;object-fit:contain;margin-bottom:6px}
.category-item span{font-size:13px;display:block}
.category-item.active{background:#e6f0ff;border:1px solid #007bff}

/* Card s·∫£n ph·∫©m */
.cardx{border:none;border-radius:12px;background:#fff;overflow:hidden;
  transition:.2s;height:100%;box-shadow:0 2px 6px rgba(0,0,0,.08);
  display:flex;flex-direction:column;position:relative}
.cardx img.thumb{width:100%;height:180px;object-fit:cover;}
.cardx .note-badge{position:absolute;top:8px;left:8px;padding:2px 8px;border-radius:12px;
  font-size:12px;font-weight:600;color:#fff}
.cardx .meta{padding:10px;flex:1;display:flex;flex-direction:column;}
.cardx .id{font-weight:600;color:#0018a8;font-size:13px;margin-bottom:2px}
.cardx .type-badge{display:inline-block;background:#e0f0ff;color:#0056b3;
  font-size:11px;font-weight:600;padding:2px 6px;border-radius:12px;margin-bottom:4px}
.cardx .details{font-size:12px;color:#666;flex:1;margin-bottom:4px}
.cardx .price{font-weight:700;color:#d32f2f;font-size:1rem;margin-bottom:6px}
.cardx .add-btn{border:none;background:var(--main);color:#fff;border-radius:50%;width:32px;height:32px;
  font-size:18px;font-weight:bold;display:flex;align-items:center;justify-content:center;align-self:flex-end}

/* Gi·ªè h√†ng sidebar */
#cartSidebar{position:fixed;top:0;right:-400px;width:350px;height:100%;background:#fff;
  box-shadow:-3px 0 8px rgba(0,0,0,.2);transition:right .3s;z-index:1050;padding:15px;overflow:auto}
#cartSidebar.open{right:0}
.cart-item{display:flex;align-items:center;gap:8px;border-bottom:1px solid #eee;padding:8px 0}
.cart-item img{width:50px;height:50px;object-fit:cover;border-radius:4px;border:1px solid #ddd}
.cart-info{flex:1}
.cart-title{font-weight:600;font-size:13px}
.cart-actions{display:flex;align-items:center;gap:4px}
.qty-btn{width:24px;height:24px;border:1px solid #ccc;background:#f9f9f9;border-radius:4px;cursor:pointer}
.remove-btn{background:none;border:none;color:#d32f2f;font-size:16px;cursor:pointer}
.cart-footer{display:flex;justify-content:space-between;align-items:center;padding:8px 0;font-weight:600;font-size:15px}

/* Error box */
#errbox{position:fixed;bottom:8px;left:8px;right:8px;background:#ffefef;border:1px solid #e99;padding:8px;border-radius:8px;z-index:9999;display:none;white-space:pre-wrap;font-family:ui-monospace,Consolas,monospace}
</style>
</head>
<body>
  <div class="top-banner">∆Øu ƒë√£i th√°ng n√†y cho kh√°ch ƒë·∫∑t qua 2606ai.vn</div>

  <!-- Header -->
  <div class="site-header">
    <div class="d-flex align-items-center gap-2">
      <img src="https://drive.google.com/uc?export=view&id=1jXc4uRzVs6G9Tjryffg5tT98nFFeRF4Z" class="logo" alt="2606AI logo">
      <span class="brand-title">2606AI Marketplace</span>
    </div>
    <div class="d-flex gap-2">
      <button id="filterBtn" class="btn btn-outline-secondary" data-bs-toggle="offcanvas" data-bs-target="#filterPanel">‚öôÔ∏è B·ªô l·ªçc</button>
      <button id="cartBtn" class="btn btn-outline-dark">üõí Gi·ªè h√†ng <span id="cartCount">0</span></button>
    </div>
  </div>

  <div class="container-fluid my-3">
    <div class="row">
      <!-- Sidebar -->
      <div class="col-lg-3 col-md-4">
        <div class="sidebar-box">
          <h6 class="fw-bold">Quy·ªÅn l·ª£i</h6>
          <ul class="small mb-0">
            <li>‚ö° B√°o gi√° nhanh 24h</li>
            <li>üé® Thi·∫øt k·∫ø mi·ªÖn ph√≠</li>
            <li>‚úÖ QC 2 l·ªõp</li>
            <li>üöö Giao h√†ng to√†n qu·ªëc</li>
          </ul>
        </div>
        <div class="sidebar-box">
          <h6 class="fw-bold mb-2">X∆∞·ªüng ƒë·ªÅ xu·∫•t</h6>
          <div id="factoryList"></div>
        </div>
      </div>

      <!-- Content -->
      <div class="col-lg-9 col-md-8">
        <!-- Hero -->
        <div class="hero row">
          <div class="col-md-8 big"><img src="https://picsum.photos/800/300?random=1" alt=""></div>
          <div class="col-md-4 small">
            <img src="https://picsum.photos/400/145?random=2" alt="">
            <img src="https://picsum.photos/400/145?random=3" alt="">
          </div>
        </div>

        <!-- Danh m·ª•c -->
        <div class="category-box mb-3">
          <h6 class="fw-bold mb-2">DANH M·ª§C S·∫¢N PH·∫®M</h6>
          <div class="row row-cols-3 row-cols-md-6 g-2" id="categoryGrid"></div>
        </div>

        <!-- Search -->
        <div class="input-group mb-3">
          <span class="input-group-text bg-primary text-white">üîç</span>
          <input id="searchBox" class="form-control" placeholder="T√¨m s·∫£n ph·∫©m... (ID, m√¥ t·∫£)">
          <button id="searchBtn" class="btn btn-primary">T√¨m</button>
        </div>

        <!-- Grid -->
        <div id="productGrid" class="row row-cols-2 row-cols-md-3 row-cols-lg-6 g-2"></div>

        <!-- Pagination -->
        <div class="d-flex justify-content-between mt-2">
          <button id="prevBtn" class="btn btn-outline-secondary">‚Üê Tr∆∞·ªõc</button>
          <button id="nextBtn" class="btn btn-outline-secondary">Sau ‚Üí</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Gi·ªè h√†ng -->
  <div id="cartSidebar">
    <h5>Gi·ªè h√†ng</h5>
    <div id="cartList"></div>
    <div class="cart-footer"><span>T·ªïng c·ªông</span><span id="cartTotal">0 ƒë</span></div>
    <button class="btn btn-danger w-100 mb-2" id="clearCartBtn">X√≥a to√†n b·ªô</button>

    <!-- Form -->
    <div>
      <input id="buyerName" class="form-control mb-2" placeholder="H·ªç v√† t√™n">
      <input id="buyerEmail" class="form-control mb-2" placeholder="Email">
      <input id="buyerPhone" class="form-control mb-2" placeholder="S·ªë ƒëi·ªán tho·∫°i">
      <input id="buyerAddress" class="form-control mb-2" placeholder="ƒê·ªãa ch·ªâ nh·∫≠n h√†ng">
      <textarea id="buyerNote" class="form-control mb-2" placeholder="Ghi ch√∫"></textarea>
      <button class="btn btn-success w-100" id="submitOrderBtn">G·ª≠i ƒë∆°n h√†ng</button>
    </div>
  </div>

  <!-- Offcanvas Filter -->
  <div class="offcanvas offcanvas-end" tabindex="-1" id="filterPanel">
    <div class="offcanvas-header">
      <h5>B·ªô l·ªçc n√¢ng cao</h5>
      <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body">
      <h6>TYPE</h6><div id="typeBox" class="mb-3"></div>
      <h6>LO·∫†I S·∫¢N PH·∫®M</h6><div id="loaiBox" class="mb-3"></div>
      <h6>CH√ö √ù</h6><div id="noteBox" class="mb-3"></div>
    </div>
  </div>

  <div id="errbox"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" defer></script>
<script>
/* ===== Hi·ªÉn th·ªã l·ªói ƒë·ªÉ tr√°nh tr·∫Øng trang ===== */
(function(){
  const box = document.getElementById('errbox');
  function show(msg){
    box.style.display='block';
    box.textContent = '[ERROR] ' + msg;
    console.error(msg);
  }
  window.addEventListener('error', e => show(e.message + (e.filename?(' @ '+e.filename+':'+e.lineno):'')));
  window.addEventListener('unhandledrejection', e => show('Promise rejected: ' + (e.reason && e.reason.message ? e.reason.message : e.reason)));
})();

document.addEventListener('DOMContentLoaded', () => {
/* ====== API URL ====== */
const API_URL="https://script.google.com/macros/s/AKfycbz-P3biIvSq1FYSt5I4T6tLYtv5mggIwRR3ug1FIUSbuZe6HMkLazUlbRyM1IW7LxH6/exec";

const state = { page:1, pageSize:36, q:'', group:'', type:'', loai:'', note:'', category:'' };
const cart = []; const products = {};

const fmtVND = n => (Number(n)||0).toLocaleString('vi-VN') + ' ƒë';
const esc = s => (s??'').toString().replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));

/* m√†u badge ch√∫ √Ω */
function badgeColor(txt){
  if(!txt) return "#555";
  const t = txt.toLowerCase();
  if(t.includes("m·∫´u") || t.includes("sample")) return "#4caf50";
  if(t.includes("gi·∫£m") || t.includes("sale") || t.includes("km")) return "#ff9800";
  if(t.includes("g·∫•p") || t.includes("urgent")) return "#d32f2f";
  return "#555";
}

/* Card s·∫£n ph·∫©m (kh·ªõp layout c≈©) */
function productCardHtml(it){
  products[it.id] = it;
  return `<div class="col"><div class="cardx">
    ${it.note?`<span class="note-badge" style="background:${badgeColor(it.note)}">${esc(it.note)}</span>`:''}
    <a href="${esc(it.linkFull || it.img)}" target="_blank" rel="noopener">
      <img class="thumb" src="${esc(it.img)}" alt="${esc(it.id)}"
        onerror="this.src='https://via.placeholder.com/300x300?text=No+Image'">
    </a>
    <div class="meta">
      <div class="id">${esc(it.id)}</div>
      <div class="type-badge">${esc(it.type || '')}</div>
      <div class="details">${esc(it.details || '')}</div>
      <div class="price">${fmtVND(it.price)}</div>
      <button class="add-btn" data-action="add-to-cart" data-id="${esc(it.id)}">+</button>
    </div>
  </div></div>`;
}

/* Render & fetch (gi·ªØ nguy√™n logic, ch·ªâ thay c√°ch bind s·ª± ki·ªán) */
function render(res){
  const grid = document.getElementById('productGrid');
  if(!res || !res.items || res.items.length===0){
    grid.innerHTML = '<div class="text-muted">Kh√¥ng c√≥ s·∫£n ph·∫©m.</div>';
  } else {
    grid.innerHTML = res.items.map(it => productCardHtml(it)).join('');
  }

  const facets = res && res.facets ? res.facets : {};
  buildCategory(facets.groups || []);
  buildFilterBox('typeBox', facets.types || [], 'type');
  buildFilterBox('loaiBox', facets.loais || [], 'loai');
  buildFilterBox('noteBox', facets.notes || [], 'note');
}

function fetchPage(){
  const params = new URLSearchParams({
    action:'list',
    page: state.page,
    pageSize: state.pageSize,
    q: state.q,
    group: state.group,
    type: state.type,
    loai: state.loai,
    note: state.note,
    category: state.category
  });
  fetch(API_URL + '?' + params.toString())
    .then(r => r.json())
    .then(render)
    .catch(() => {
      document.getElementById('productGrid').innerHTML =
        '<div class="text-danger">Kh√¥ng t·∫£i ƒë∆∞·ª£c d·ªØ li·ªáu. Ki·ªÉm tra API_URL ho·∫∑c quy·ªÅn truy c·∫≠p Web App.</div>';
    });
}

/* Danh m·ª•c (kh·ªëi √¥ tr√≤n nh∆∞ c≈©) */
function buildCategory(items){
  const grid=document.getElementById("categoryGrid");
  grid.innerHTML=(items||[]).map(val=>`
    <div class="col">
      <div class="category-item ${state.group===val?'active':''}" data-action="select-category" data-val="${esc(val)}">
        <img src="https://img.icons8.com/color/96/000000/category.png" alt="">
        <span>${esc(val)}</span>
      </div>
    </div>
  `).join('');
}
function selectCategory(val){
  state.group=val;state.page=1;fetchPage();
  document.querySelectorAll('.category-item').forEach(el=>{
    el.classList.toggle('active', el.dataset.val === val);
  });
}

/* Filter buttons */
function buildFilterBox(boxId, items, field){
  const box=document.getElementById(boxId);
  box.innerHTML=(items||[]).map(val=>`
    <button class="btn btn-sm ${state[field]===val?'btn-primary':'btn-outline-secondary'} me-1 mb-1"
      data-action="set-filter" data-field="${field}" data-val="${esc(val)}">${esc(val)}</button>
  `).join('');
}
function updateFilterCount(){
  let count=0;
  if(state.type) count++;
  if(state.loai) count++;
  if(state.note) count++;
  if(state.category) count++;
  document.getElementById("filterBtn").innerText=`‚öôÔ∏è B·ªô l·ªçc${count>0?' ('+count+')':''}`;
}

/* Gi·ªè h√†ng */
function addToCartById(id){
  const item=products[id];
  if(item){const found=cart.find(p=>p.id===id);if(found)found.qty++;else cart.push({...item,qty:1});updateCart();openCart();}
}
function changeQty(id,delta){
  const it=cart.find(p=>p.id===id); if(!it)return;
  it.qty+=delta;if(it.qty<=0)cart.splice(cart.indexOf(it),1);updateCart();
}
function removeItem(id){
  const idx=cart.findIndex(p=>p.id===id);
  if(idx>=0)cart.splice(idx,1);updateCart();
}
function clearCart(){if(confirm("X√≥a to√†n b·ªô gi·ªè h√†ng?")){cart.length=0;updateCart();}}
function updateCart(){
  document.getElementById('cartCount').innerText=cart.reduce((a,b)=>a+b.qty,0);
  const list=document.getElementById('cartList');
  let total=0;
  list.innerHTML=cart.map(it=>{
    const sub=it.qty*(Number(it.price)||0);total+=sub;
    return `<div class="cart-item">
      <img src="${esc(it.img)}" alt="">
      <div class="cart-info">
        <div class="cart-title">${esc(it.details||it.id)}</div>
        <div>${fmtVND(it.price)}</div>
      </div>
      <div class="cart-actions">
        <button class="qty-btn" data-action="qty" data-id="${esc(it.id)}" data-delta="-1">-</button>
        <span>${it.qty}</span>
        <button class="qty-btn" data-action="qty" data-id="${esc(it.id)}" data-delta="1">+</button>
      </div>
      <div style="min-width:80px;text-align:right">${fmtVND(sub)}</div>
      <button class="remove-btn" data-action="remove" data-id="${esc(it.id)}">&times;</button>
    </div>`;
  }).join('');
  document.getElementById('cartTotal').innerText=fmtVND(total);
}

/* Submit order */
function submitOrder(){
  if(cart.length===0){ alert("Gi·ªè h√†ng tr·ªëng!"); return; }
  const name=document.getElementById("buyerName").value.trim();
  const email=document.getElementById("buyerEmail").value.trim();
  const phone=document.getElementById("buyerPhone").value.trim();
  const address=document.getElementById("buyerAddress").value.trim();
  const note=document.getElementById("buyerNote").value.trim();
  if(!name||!email||!phone||!address){alert("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin!");return;}
  const order={customer:{name,email,phone,address,note},
    items:cart.map(({id,details,type,price,qty,img,linkFull,group,loai,category,note})=>({id,details,type,price,qty,img,linkFull,group,loai,category,note})),
    total:cart.reduce((a,b)=>a+b.qty*(Number(b.price)||0),0)};
  fetch(API_URL,{method:"POST",headers:{"Content-Type":"application/json"},
    body:JSON.stringify({action:"order",email:"lehaidangem836@gmail.com",data:order})})
  .then(r=>r.json()).then(res=>{
    if(res && (res.ok||res.success)){ alert("ƒê√£ g·ª≠i ƒë∆°n h√†ng th√†nh c√¥ng!"); cart.length=0; updateCart(); }
    else alert("G·ª≠i ƒë∆°n h√†ng th·∫•t b·∫°i.");
  }).catch(()=>alert("Kh√¥ng th·ªÉ g·ª≠i ƒë∆°n h√†ng. Ki·ªÉm tra k·∫øt n·ªëi ho·∫∑c API_URL."));
}

/* Event delegation (kh√¥ng inline onclick) */
document.addEventListener('click', (e)=>{
  const el=e.target;

  if(el.matches('[data-action="add-to-cart"]')) addToCartById(el.dataset.id);

  if(el.closest('[data-action="select-category"]')){
    const t = el.closest('[data-action="select-category"]');
    selectCategory(t.dataset.val||'');
  }

  if(el.matches('[data-action="set-filter"]')){
    state[el.dataset.field]=el.dataset.val||'';state.page=1;fetchPage();updateFilterCount();
  }

  if(el.matches('[data-action="qty"]')){
    changeQty(el.dataset.id, Number(el.dataset.delta||el.dataset.d||0));
  }

  if(el.matches('[data-action="remove"]')){
    removeItem(el.dataset.id);
  }

  if(el.matches('#searchBtn')){
    state.q=document.getElementById('searchBox').value.trim();state.page=1;fetchPage();
  }
  if(el.matches('#prevBtn')){ if(state.page>1){state.page--;fetchPage();} }
  if(el.matches('#nextBtn')){ state.page++;fetchPage(); }
  if(el.matches('#cartBtn')){ openCart(); }
  if(el.matches('#clearCartBtn')){ clearCart(); }
  if(el.matches('#submitOrderBtn')){ submitOrder(); }
});

/* Cart toggle */
function openCart(){ document.getElementById('cartSidebar').classList.add('open'); }

/* Demo factories + load */
document.getElementById('factoryList').innerHTML =
  ['X∆∞·ªüng A','X∆∞·ªüng B','X∆∞·ªüng C'].map(n=>`<div>${n}</div>`).join('');
fetchPage();

});
</script>
</body>
</html>
