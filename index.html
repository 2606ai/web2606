<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>2606AI</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
:root{ --main:#0018a8; --accent:#d4af37; --bg:#f5f6fa; }
body{ font-family:'Helvetica','Arial',sans-serif; background:var(--bg); font-size:14px; padding-top:70px; }
.container-fluid{max-width:1400px;margin:auto;}
.top-banner{background:var(--main)!important;color:#fff;font-weight:700;position:sticky; top:70px; z-index:1054;height:32px; display:flex; align-items:center; overflow:hidden; border:0;}
.top-banner .marquee{display:inline-block; white-space:nowrap; padding-left:100%; animation: marquee 60s linear infinite;}
@keyframes marquee{ 0%{transform:translateX(0)} 100%{transform:translateX(-100%)} }
.site-header{background:#fff;padding:10px 15px;border-bottom:1px solid #eee; position:fixed;top:0;left:0;right:0;z-index:1055;height:70px; box-shadow:0 2px 6px rgba(0,0,0,.05); }
.site-header .wrap{max-width:1400px;width:100%;margin:0 auto;display:flex;align-items:center;justify-content:center;gap:12px;}
.site-header img.logo{ width:84px; aspect-ratio:3/2; object-fit:contain; display:block; cursor:pointer; }
.header-search{ flex:1 1 auto; width:100%; max-width:100%; min-width:360px; }
@media (max-width: 992px){
  .site-header .wrap{ justify-content:center; }
  .header-search{ flex:1 1 100%; max-width:100%; }
}
.header-search .form-control{ font-size:13px;padding:6px 10px; }
/* FABs */
.cart-fab, .filter-fab, .suppliers-fab, .zalo-fab{
  position:fixed; right:16px; width:54px; height:54px; border:none; border-radius:50%;
  color:#fff; font-size:22px; line-height:54px; box-shadow:0 6px 16px rgba(0,0,0,.25); z-index:2500; cursor:pointer;
  display:flex; align-items:center; justify-content:center;
}
.filter-fab{ background:#6c757d; bottom:212px; }
.cart-fab{ background:#0018a8; bottom:148px; }
.suppliers-fab{ background:#0d6efd; bottom:84px; }
.zalo-fab{ background:#25D366; bottom:20px; }
.fab-badge{position:absolute; top:-6px; right:-6px; background:#d32f2f; color:#fff; border-radius:999px; padding:2px 6px; font-size:12px; font-weight:700; display:none}
/* Offcanvas z-index cao */
.offcanvas{ z-index: 4000; }
.offcanvas-backdrop{ z-index: 3990; }
/* Sidebar chung */
.sidebar-box{background:#fff;padding:12px;border-radius:8px;margin-bottom:15px;box-shadow:0 2px 4px rgba(0,0,0,.05)}
.sidebar-box h6{font-weight:700;font-size:15px;margin-bottom:8px}
/* Benefit cards */
.benefits-v3 .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
@media (max-width: 480px){ .benefits-v3 .grid{grid-template-columns:1fr} }
.benefits-v3 .bcard{background:#fff;border:1px solid #eef2ff;border-radius:12px;padding:10px;display:flex;gap:8px;align-items:flex-start;min-height:60px; position:relative; font-weight:500}
.benefits-v3 .ic{width:28px;height:28px;border-radius:8px;background:#f1f4ff;display:inline-flex;align-items:center;justify-content:center;flex:0 0 28px}
.benefits-v3 .ttl{ font-weight:600; text-transform:none;font-size:12px; }
.benefits-v3 .sub{font-size:12px;color:#6b7483;line-height:1.25;margin-top:2px}
.benefits-v3 .bcard{ flex-direction:column; align-items:center; text-align:center; gap:6px; padding:12px; }
.benefits-v3 .ic{ width:36px; height:36px; margin:0 0 6px 0; flex:0 0 auto; }
/* benefit note badge */
.benefit-note{ position:absolute; top:6px; right:8px; font-size:11px; font-weight:700; padding:2px 6px; border-radius:999px; color:#fff; }
.benefit-free{ background:#4caf50; }
.benefit-paid{ background:#d32f2f; }
/* Preview card */
.link-preview{display:flex; gap:10px; border:1px solid #eef2ff;background:#fff;border-radius:10px;padding:10px; align-items:flex-start; }
.link-preview img.thumb{width:64px;height:64px;object-fit:cover;border-radius:8px;background:#f6f7fb}
.link-preview .meta{font-size:12px}
.link-preview .title{font-weight:700;margin-bottom:2px}
.link-preview .desc{color:#6c757d;max-height:2.4em;overflow:hidden}
.link-preview .site{font-size:12px;color:#8898aa}
.link-preview .actions{ display:flex; flex-direction:column; gap:6px; align-items:flex-end; }
.link-preview .doc-missing{ display:inline-block; font-size:11px; padding:2px 6px; border-radius:999px; background:#f8f9fc; color:#6b7483; border:1px dashed #dfe6ff; }
/* Hero */
.hero{margin-bottom:15px}
.hero .carousel{border-radius:8px;overflow:hidden}
.hero .carousel .carousel-indicators [data-bs-target]{width:8px;height:8px;border-radius:50%}
.hero .mini img{width:100%;height:145px;object-fit:cover;border-radius:8px}
.hero .mini .carousel{height:145px}
.hero .main img{width:100%;height:300px;object-fit:cover;border-radius:8px}
/* Danh mục */
.category-box{background:#fff;border-radius:8px;padding:10px;box-shadow:0 2px 4px rgba(0,0,0,.05)}
.category-item{ text-align:center;padding:10px;border-radius:10px;cursor:pointer;transition:.2s }
.category-item:hover{background:#f5f5f5}
.category-item .icon{width:48px;height:48px;display:inline-flex;align-items:center;justify-content:center;border-radius:12px;background:#f1f4ff;margin-bottom:6px}
.category-item .icon img{width:28px;height:28px;object-fit:contain}
.category-item span{font-size:13px;display:block}
.category-item.active{background:#e6f0ff;border:1px solid #007bff}
/* Product card */
.cardx{border:none;border-radius:0;background:#fff;overflow:hidden;transition:.2s;height:100%;
  box-shadow:0 2px 6px rgba(0,0,0,.08);display:flex;flex-direction:column;position:relative}
.cardx .thumb-wrap{position:relative}
.cardx img.thumb{width:100%;height:180px;object-fit:cover;background:#fff;border-radius:0}
.cardx .note-chip{position:absolute; top:8px; right:8px;padding:2px 6px; border-radius:999px; font-size:10px; font-weight:600; color:#fff; background:#555;}
.cardx .meta{padding:10px;flex:1;display:flex;flex-direction:column;}
.cardx .id{font-weight:600;color:#0018a8;font-size:13px;margin-bottom:2px}
.cardx .type-badge{display:inline-block;background:#e0f0ff;color:#0056b3;font-size:11px;font-weight:600;padding:2px 6px;border-radius:12px;margin:6px 0}
.cardx .details{font-size:12px;color:#666;flex:1;margin-bottom:6px}
.cardx .price{font-weight:600;color:#d32f2f;font-size:1rem;margin-bottom:8px}
.cardx .add-btn{border:none;background:var(--main);color:#fff;border-radius:50%;width:32px;height:32px;font-size:18px;font-weight:bold;display:flex;align-items:center;justify-content:center;align-self:flex-end}
.cardx .meta-actions{ display:flex; align-items:center; justify-content:space-between; gap:8px }
.cardx .btn-gift{background:#fff;border:1px solid var(--main);color:var(--main);font-weight:700;padding:6px 10px;border-radius:999px;font-size:12px;line-height:1;display:inline-flex;align-items:center;gap:6px;max-width:70%;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;text-decoration:none}
.cardx .btn-gift:hover{ background:var(--main); color:#fff; text-decoration:none }
/* Error box */
#errbox{position:fixed;bottom:8px;left:8px;right:8px;background:#ffefef;border:1px solid #e99;padding:8px;border-radius:8px;z-index:3000;display:none;white-space:pre-wrap;font-family:ui-monospace,Consolas,monospace}
#pagerRow .btn{min-width:38px}
.site-footer{ background:#fff; border-top:1px solid #eee; padding:16px 0; margin-top:20px; font-size:13px; color:#555; }
.site-footer .brand{ font-weight:700; color:var(--main); margin-bottom:4px; }
.site-footer a{ color:inherit; text-decoration:none; }
.site-footer a:hover{ text-decoration:underline; }
.footer-social{ display:flex; gap:8px; justify-content:flex-start; }
.footer-social .social{ width:36px; height:36px; border-radius:50%; display:inline-flex; align-items:center; justify-content:center; color:#fff; font-weight:800; text-decoration:none; }
.footer-social .social-zalo{ background:#0068ff; }
.footer-social .social-fb{ background:#1877F2; }
@media (max-width:576px){ .footer-social{ justify-content:flex-start; margin-top:8px; } }

/* ====== Bộ lọc nâng cao (UI mới, không đổi logic) ====== */
#filterPanel h6 { font-weight:700; font-size:14px; margin:16px 0 8px; color:#0018a8; text-transform:uppercase; letter-spacing:.3px; }
.filter-box-group { display:flex; flex-wrap:wrap; gap:8px; margin-bottom:12px; }
.filter-tag{ border:1px solid #dbe3ff; background:#f9faff; border-radius:20px; padding:6px 12px; font-size:13px; font-weight:500; color:#333; cursor:pointer; transition:.2s; }
.filter-tag:hover{ background:#eef3ff; border-color:#b3c8ff; }
.filter-tag.active{ background:#0018a8; color:#fff; border-color:#0018a8; box-shadow:0 2px 8px rgba(0,24,168,.25); }

/* Stats bar nhẹ */
#statsBar{ background:#fff; border:1px solid #eef2ff; border-radius:10px; padding:8px 12px; }

/* Note hướng dẫn trong cart */
.cart-help{ font-size:12px; color:#4b5563; background:#f8fafc; border:1px dashed #dbeafe; border-radius:8px; padding:8px; }
</style>
</head>
<body>

<header class="site-header">
  <div class="wrap">
    <a id="logoLink" href="#" class="d-flex align-items-center text-decoration-none">
      <img src="https://drive.google.com/thumbnail?id=1e9N6rgsTP5vYtKl4Lwq801dfteYLbx_F&sz=w160" class="logo" alt="2606AI logo">
    </a>
    <form id="filter-form" class="header-search d-flex gap-2 m-0" onsubmit="return false;">
      <div class="input-group w-100">
        <input id="searchBox" class="form-control" placeholder="Tìm sản phẩm... (ID, mô tả)">
        <button id="searchBtn" class="btn btn-primary" type="button">Tìm</button>
      </div>
    </form>
  </div>
</header>

<div class="top-banner">
  <div class="marquee">
    Để đảm bảo quyền lợi hãy thông báo với 2606AI.VN khi bạn đã chốt đơn hàng &nbsp; • &nbsp;
    Nguồn thu của 2606AI.VN đến từ quảng cáo &nbsp; • &nbsp;
    Có sự hỗ trợ của 2606AI.VN tự tin sản xuất mọi sản phẩm
  </div>
</div>

<div class="container-fluid my-3">
  <div class="row g-3">
    <!-- Sidebar -->
    <div class="col-lg-3 col-md-4">
      <div class="sidebar-box benefits-v3">
        <h6 class="mb-2">Chúng tôi có gì cho bạn...</h6>
        <div class="grid">
          <div class="bcard">
            <span class="benefit-note benefit-free">Miễn phí</span>
            <div class="ic">📚</div><div><div class="ttl">1. Tham khảo 10,000+ mẫu sản phẩm</div><div class="sub">Không lo thiếu ý tưởng</div></div>
          </div>
          <div class="bcard">
            <span class="benefit-note benefit-free">Miễn phí</span>
            <div class="ic">🏭</div><div><div class="ttl">2. Hơn 500+ nhà cung cấp và xưởng sản xuất</div><div class="sub">Báo giá nhanh, đa dạng, dễ dàng so sánh giá</div></div>
          </div>
          <div class="bcard">
            <span class="benefit-note benefit-free">Miễn phí</span>
            <div class="ic">🎨</div><div><div class="ttl">3. Hỗ trợ tư vấn sản xuất</div><div class="sub">Phản hồi nhanh, đáp ứng nhiều nhu cầu</div></div>
          </div>
          <div class="bcard">
            <span class="benefit-note benefit-free">Miễn phí</span>
            <div class="ic">⚙️</div><div><div class="ttl">4. Hỗ trợ thiết kế 2D, 3D sản xuất</div><div class="sub">Mockup miễn phí cho các đơn hàng chốt</div></div>
          </div>
          <div class="bcard">
            <span class="benefit-note benefit-paid">Có phí</span>
            <div class="ic">📦</div><div><div class="ttl">5. Hậu cần vận chuyển và đóng gói hàng hóa</div><div class="sub">Dịch vụ nhanh chuyên nghiệp</div></div>
          </div>
          <div class="bcard">
            <span class="benefit-note benefit-paid">Có phí</span>
            <div class="ic">🤝</div><div><div class="ttl">6. Hỗ trợ giải quyết tranh chấp</div><div class="sub">Bảo vệ quyền lợi khách hàng</div></div>
          </div>
        </div>
      </div>

      <!-- XƯỞNG ĐỀ XUẤT -->
      <div class="sidebar-box">
        <h6 class="fw-bold mb-2 d-flex align-items-center justify-content-between">
          <span class="d-inline-flex align-items-center gap-2">
            Xưởng đề xuất
            <span id="adsCount" class="badge rounded-pill text-bg-primary" style="font-weight:700;display:none">0</span>
          </span>
          <div class="btn-group btn-group-sm">
            <button type="button" class="btn btn-outline-secondary" id="adsPrevBtn">‹</button>
            <button type="button" class="btn btn-outline-secondary" id="adsNextBtn">›</button>
            <button type="button" class="btn btn-outline-secondary" id="refreshAdsBtn">↻</button>
          </div>
        </h6>
        <div id="adsList" class="d-flex flex-column gap-2"></div>
        <div id="adsEmpty" class="small text-muted">Chọn bộ lọc để xem đơn vị phù hợp (dựa trên cột “quangcao”).</div>
      </div>
    </div>

    <!-- Content -->
    <div class="col-lg-9 col-md-8">
      <!-- HERO -->
      <div class="hero row g-2">
        <div class="col-md-8 main">
          <div id="heroMain" class="carousel slide" data-bs-ride="carousel" data-bs-interval="4000">
            <div class="carousel-indicators">
              <button type="button" data-bs-target="#heroMain" data-bs-slide-to="0" class="active"></button>
              <button type="button" data-bs-target="#heroMain" data-bs-slide-to="1"></button>
              <button type="button" data-bs-target="#heroMain" data-bs-slide-to="2"></button>
            </div>
            <div class="carousel-inner">
              <div class="carousel-item active"><img class="d-block w-100" src="https://picsum.photos/1200/300?random=11" alt=""></div>
              <div class="carousel-item"><img class="d-block w-100" src="https://picsum.photos/1200/300?random=12" alt=""></div>
              <div class="carousel-item"><img class="d-block w-100" src="https://picsum.photos/1200/300?random=13" alt=""></div>
            </div>
            <button class="carousel-control-prev" type="button" data-bs-target="#heroMain" data-bs-slide="prev"><span class="carousel-control-prev-icon"></span></button>
            <button class="carousel-control-next" type="button" data-bs-target="#heroMain" data-bs-slide="next"><span class="carousel-control-next-icon"></span></button>
          </div>
        </div>
        <div class="col-md-4 d-flex flex-column gap-2 mini">
          <div id="heroRight1" class="carousel slide" data-bs-ride="carousel" data-bs-interval="3500">
            <div class="carousel-inner">
              <div class="carousel-item active"><img src="https://picsum.photos/600/145?random=21" class="d-block w-100" alt=""></div>
              <div class="carousel-item"><img src="https://picsum.photos/600/145?random=22" class="d-block w-100" alt=""></div>
            </div>
          </div>
          <div id="heroRight2" class="carousel slide" data-bs-ride="carousel" data-bs-interval="4200">
            <div class="carousel-inner">
              <div class="carousel-item active"><img src="https://picsum.photos/600/145?random=23" class="d-block w-100" alt=""></div>
              <div class="carousel-item"><img src="https://picsum.photos/600/145?random=24" class="d-block w-100" alt=""></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Danh mục -->
      <div class="category-box mb-3">
        <h6 class="fw-bold mb-2">ẤN PHẨM THƯƠNG HIỆU</h6>
        <div class="row row-cols-3 row-cols-md-6 g-2" id="categoryGrid"></div>
      </div>

      <!-- Thống kê -->
      <div id="statsBar" class="mb-3">
        <div class="d-flex align-items-center gap-2">
          <span class="fw-semibold">TỔNG SỐ SẢN PHẨM TÌM THẤY:</span>
          <span id="totalCount" class="badge text-bg-primary">0</span>
          <button id="clearFiltersBtn2" class="btn btn-sm btn-outline-danger">Xóa bộ lọc</button>
        </div>
      </div>

      <!-- Grid -->
      <div id="productGrid" class="row row-cols-2 row-cols-md-3 row-cols-lg-6 g-2"></div>

      <!-- Phân trang dạng số -->
      <div id="pagerRow" class="mt-3 d-flex flex-wrap gap-2"></div>
    </div>
  </div>
</div>

<!-- Footer -->
<footer class="site-footer">
  <div class="container-fluid">
    <div class="row align-items-center g-2">
      <div class="col-12 col-md">
        <div class="brand">HỘ KINH DOANH DỊCH VỤ MARKETING VINA GASE</div>
        <div>Mã số thuế: <strong>12333211232</strong></div>
        <div>Liên hệ: <a href="tel:012345678">012345678</a> • Email: <a href="mailto:lienhengay@gmail.com">lienhengay@gmail.com</a></div>
      </div>
      <div class="col-12 col-md-auto">
        <div class="footer-social">
          <a class="social social-zalo" href="#" target="_blank" rel="noopener" aria-label="Zalo">Z</a>
          <a class="social social-fb" href="#" target="_blank" rel="noopener" aria-label="Facebook">f</a>
        </div>
      </div>
    </div>
  </div>
</footer>

<!-- Offcanvas: Giỏ hàng -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="cartCanvas" aria-labelledby="cartCanvasLabel">
  <div class="offcanvas-header">
    <h5 id="cartCanvasLabel" class="mb-0">Chọn hàng loạt</h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
  </div>
  <div class="offcanvas-body">
    <div id="cartList"></div>

    <!-- Tổng cộng + phí dịch vụ -->
    <div class="py-2">
      <div class="d-flex justify-content-between align-items-center fw-bold">
        <span>Tạm tính</span><span id="cartSubtotal">0 đ</span>
      </div>
      <div id="serviceFeeRow" class="d-flex justify-content-between align-items-center text-muted small" style="display:none">
        <span>Phí dịch vụ</span><span id="serviceFeeText">0 đ</span>
      </div>
      <hr class="my-2">
      <div class="d-flex justify-content-between align-items-center fw-bold">
        <span>Tổng cộng</span><span id="cartTotal">0 đ</span>
      </div>
    </div>

    <button class="btn btn-danger w-100 mb-2" id="clearCartBtn">Xóa toàn bộ</button>

    <!-- Form thông tin -->
    <input id="buyerName" class="form-control mb-2" placeholder="Họ và tên">
    <input id="buyerEmail" class="form-control mb-2" placeholder="Email">
    <input id="buyerPhone" class="form-control mb-2" placeholder="Số điện thoại">
    <input id="buyerAddress" class="form-control mb-2" placeholder="Địa chỉ nhận hàng">
    <textarea id="buyerNote" class="form-control mb-2" placeholder="Ghi chú"></textarea>

    <!-- Tải tệp -->
    <label class="form-label mt-1 mb-1">Đính kèm tệp (thiết kế, yêu cầu, hồ sơ…)</label>
    <input id="buyerFiles" type="file" class="form-control mb-2" multiple
           accept=".jpg,.jpeg,.png,.webp,.pdf,.ai,.psd,.zip,.rar,.doc,.docx,.xls,.xlsx">

    <!-- Dịch vụ LẤY BÁO GIÁ HỘ -->
    <label class="form-label mt-2 mb-1">Dịch vụ LẤY BÁO GIÁ HỘ</label>
    <select id="serviceSelect" class="form-select mb-1">
      <option value="none">Không chọn</option>
      <option value="3@100000">100,000 đ / 3 báo giá</option>
      <option value="10@500000">500,000 đ / 10 báo giá</option>
    </select>
    <div class="form-check mb-2">
      <input class="form-check-input" type="checkbox" id="quoteByFile">
      <label class="form-check-label" for="quoteByFile">Báo giá theo tệp tải lên</label>
    </div>
    <div class="form-text mb-2">Phí dịch vụ (nếu chọn) sẽ được cộng vào tổng.</div>

    <!-- Note hướng dẫn -->
    <div class="cart-help mb-2">
      <div>1) Bạn cần làm giống mẫu nào hoặc mua sản phẩm gì hãy <b>Gửi đơn hàng</b>, chúng tôi sẽ sớm liên hệ lại.</div>
      <div>2) Ghi rõ yêu cầu sẽ giúp chúng tôi tư vấn bạn dễ dàng hơn.</div>
      <div>3) CSKH của 2606ai.vn sẽ liên hệ bạn trong vòng 24h (nếu quá thời gian này phiền bạn chủ động liên hệ lại).</div>
    </div>

    <button class="btn btn-success w-100" id="submitOrderBtn">Gửi đơn hàng</button>
  </div>
</div>

<!-- Offcanvas: Bộ lọc -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="filterPanel" aria-labelledby="filterPanelLabel">
  <div class="offcanvas-header">
    <h5 id="filterPanelLabel" class="mb-0">Bộ lọc nâng cao</h5>
    <div class="d-flex gap-2">
      <button type="button" class="btn btn-outline-danger btn-sm" id="clearFiltersBtn">Xóa bộ lọc</button>
      <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
    </div>
  </div>
  <div class="offcanvas-body">
    <h6>ẤN PHẨM THƯƠNG HIỆU</h6><div id="brandBox" class="mb-3"></div>
    <h6>TYPE</h6><div id="typeBox" class="mb-3"></div>
    <h6>LOẠI SẢN PHẨM</h6><div id="loaiBox" class="mb-3"></div>
    <h6>CHÚ Ý</h6><div id="noteBox" class="mb-3"></div>
  </div>
</div>

<!-- Offcanvas: Danh sách xưởng -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="suppliersCanvas" aria-labelledby="suppliersLabel">
  <div class="offcanvas-header">
    <h5 id="suppliersLabel" class="mb-0">Danh sách xưởng</h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
  </div>
  <div class="offcanvas-body">
    <div id="suppliersList">Chưa có dữ liệu.</div>
  </div>
</div>

<button id="filterFab" class="filter-fab" aria-label="Mở bộ lọc">⚙️</button>
<button id="cartFab" class="cart-fab" aria-label="Mở giỏ hàng">🛒 <span id="cartFabCount" class="fab-badge">0</span></button>
<button id="suppliersFab" class="suppliers-fab" aria-label="Danh sách xưởng">🏭</button>
<a id="zaloFab" class="zalo-fab" aria-label="Zalo" href="#" target="_blank" rel="noopener">💬</a>

<div id="errbox"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
/* ===== ERROR ===== */
(function(){
  const box=document.getElementById('errbox');
  function show(msg){ box.style.display='block'; box.textContent='[ERROR] '+msg; console.error(msg); }
  window.addEventListener('error', e=>show(e.message+(e.filename?(' @ '+e.filename+':'+e.lineno):'')));
  window.addEventListener('unhandledrejection', e=>show('Promise rejected: '+((e.reason&&e.reason.message)||e.reason)));
})();

document.addEventListener('DOMContentLoaded', () => {
/* ===== CONFIG ===== */
const API_URL = "https://script.google.com/macros/s/AKfycbydKdWt4wZIvCgg5dHghFrZuJqaBZGkRUxHypSIUV3oIkqLyH0XqYIqhUQUVMNwMFs/exec";
const ZALO_URL = "#";

/* STATE */
const AUTO_OPEN_ON_ADD = false;
const state = { page:1, pageSize:36, q:'', group:'', type:'', loai:'', note:'', category:'' };
const cart = []; const products = {};

/* ADS slider state */
let adsData = [];
let adsIndex = 0;
let adsTimer = null;
const ADS_PAGE_SIZE = 6;       // 6 dòng / lần
const ADS_INTERVAL  = 10000;   // ms (0 = tắt auto)

/* UTILS */
const fmtVND = n => (Number(n)||0).toLocaleString('vi-VN') + ' đ';
const esc = s => (s??'').toString().replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
function badgeColor(txt){ if(!txt) return "#555"; const t=txt.toLowerCase(); if(t.includes("mẫu")||t.includes("sample")) return "#4caf50"; if(t.includes("giảm")||t.includes("sale")||t.includes("km")) return "#ff9800"; if(t.includes("gấp")||t.includes("urgent")) return "#d32f2f"; return "#555"; }
function hostnameFromUrl(u){ try{ return new URL(u).hostname; }catch(e){ return (u||'').replace(/^https?:\/\//,''); } }
function firstLink(s){ if(!s) return ''; const parts=String(s).split(/[\s,;|\n]+/).filter(Boolean); for(const p of parts) if(/^https?:\/\//i.test(p)) return p; return parts[0]||''; }
function httpsImage(u){ try{ const url=new URL(u); if(url.protocol==='http:') return 'https://wsrv.nl/?url='+encodeURIComponent(u); return u; }catch(_){ return u; } }

/* UI: click logo = reload */
document.getElementById('logoLink').addEventListener('click', (e)=>{ e.preventDefault(); window.location.reload(); });

/* Product card */
function productCardHtml(it){
  products[it.id]=it;
  const giftUrl = firstLink(it.imageClick);
  const showGift= !!giftUrl;
  const giftLabel=(it.loai||'Nhận quà').toString().trim();

  return `<div class="col"><div class="cardx">
    <div class="thumb-wrap">
      <a href="${esc(it.linkFull || it.img)}" target="_blank" rel="noopener">
        <img class="thumb" src="${esc(httpsImage(it.img))}" alt="${esc(it.id)}"
             onerror="this.src='https://via.placeholder.com/300x300?text=No+Image'">
      </a>
      ${it.note?`<span class="note-chip" style="background:${badgeColor(it.note)}">${esc(it.note)}</span>`:''}
    </div>
    <div class="meta">
      <div class="id">${esc(it.id)}</div>
      <div class="details">${esc(it.details||'')}</div>
      ${it.type ? `<div class="type-badge">${esc(it.type)}</div>` : ``}
      <div class="price">${fmtVND(it.price)}</div>
      <div class="meta-actions">
        ${showGift ? `<a class="btn-gift" href="${esc(giftUrl)}" target="_blank" rel="noopener" title="${esc(giftLabel)}"><span>${esc(giftLabel)}</span></a>` : `<span></span>`}
        <button class="add-btn" data-action="add-to-cart" data-id="${esc(it.id)}">+</button>
      </div>
    </div>
  </div></div>`;
}

/* Pagination số */
function renderPagination(totalItems, pageSize, currentPage){
  const pager = document.getElementById('pagerRow');
  const totalPages = Math.ceil((totalItems||0) / pageSize);
  if(totalPages <= 1){ pager.innerHTML = ''; return; }
  let html = '';
  for(let i=1;i<=totalPages;i++){
    const active = (i===currentPage) ? 'btn-primary' : 'btn-outline-secondary';
    html += `<button class="btn btn-sm ${active}" data-action="goto-page" data-page="${i}">${i}</button>`;
  }
  pager.innerHTML = html;
}

/* Render + facets */
function render(res){
  const grid=document.getElementById('productGrid');
  if(!res||!res.items||res.items.length===0){ grid.innerHTML='<div class="text-muted">Không có sản phẩm.</div>'; }
  else{ grid.innerHTML=res.items.map(productCardHtml).join(''); }

  const facets=res&&res.facets?res.facets:{};
  buildCategory(facets.categories||[]);
  buildFilterBox('typeBox',facets.types||[],'type');
  buildFilterBox('loaiBox',facets.loais||[],'loai');
  buildFilterBox('noteBox',facets.notes||[],'note');
  buildFilterBox('brandBox',facets.categories||[],'category');

  const totalEl = document.getElementById('totalCount');
  if (totalEl) totalEl.textContent = Number(res?.total||0).toLocaleString('vi-VN');

  renderPagination(res?.total||0, state.pageSize, state.page);
}

/* Fetch list */
function fetchPage(){
  const params=new URLSearchParams({
    action:'list',page:state.page,pageSize:state.pageSize,
    q:state.q,group:state.group,type:state.type,loai:state.loai,note:state.note,category:state.category
  });
  fetch(API_URL+'?'+params.toString())
    .then(r=>r.json())
    .then(res => { render(res); fetchAds(); })
    .catch(()=>{ document.getElementById('productGrid').innerHTML='<div class="text-danger">Không tải được dữ liệu.</div>'; });
}

/* Category grid */
function buildCategory(items){
  const ICONS={
    "MÓC KHÓA":"https://img.icons8.com/color/48/keychain.png",
    "TƯỢNG ĐẤT":"https://img.icons8.com/color/48/clay.png",
    "LEN":"https://img.icons8.com/color/48/yarn.png",
    "BADGE":"https://img.icons8.com/color/48/medal2.png",
    "KHÁC":"https://img.icons8.com/color/48/categorize.png"
  };
  const grid=document.getElementById("categoryGrid");
  grid.innerHTML=(items||[]).map(val=>{
    const key=(val||'').toString().toUpperCase();
    const icon=ICONS[key]||ICONS["KHÁC"];
    return `
      <div class="col">
        <div class="category-item ${state.category===val?'active':''}" data-action="select-category" data-val="${esc(val)}">
          <div class="icon"><img src="${icon}" alt=""
            onerror="this.src='https://via.placeholder.com/48?text=%F0%9F%93%8C'"></div>
          <span>${esc(val||'Khác')}</span>
        </div>
      </div>`;
  }).join('');
}
function selectCategory(val){
  state.category=val; state.page=1; fetchPage();
  document.querySelectorAll('.category-item').forEach(el=>el.classList.toggle('active', el.dataset.val===val));
}

/* Filter buttons trong offcanvas */
function buildFilterBox(boxId, items, field){
  const box=document.getElementById(boxId);
  if(!box) return;
  box.classList.add("filter-box-group");
  box.innerHTML=(items||[]).map(val=>`
    <div class="filter-tag ${state[field]===val?'active':''}"
      data-action="set-filter" data-field="${field}" data-val="${esc(val)}">
      ${esc(val||'Tất cả')}
    </div>
  `).join('');
}
function updateFilterCount(){
  let c=0; if(state.type)c++; if(state.loai)c++; if(state.note)c++; if(state.category)c++;
  const fb=document.getElementById('filterFabCount');
  if(fb){ fb.textContent=c; fb.style.display=c? 'inline-block':'none'; }
}

/* Link preview API */
function fetchLinkPreview(url){
  const qs = new URLSearchParams({ action:'preview', url });
  return fetch(API_URL + '?' + qs.toString()).then(r => r.json());
}

/* ===== XƯỞNG ĐỀ XUẤT ===== */
function fetchAds(){
  const qs = new URLSearchParams({
    action:'ads',
    q:state.q, group:state.group, type:state.type, loai:state.loai, note:state.note, category:state.category
  });
  fetch(API_URL + '?' + qs.toString())
    .then(r=>r.json())
    .then(r=>renderAds(r.items||[]))
    .catch(()=>renderAds([]));
}
function renderAds(list){
  adsData = Array.isArray(list) ? list : [];
  adsIndex = 0;

  const countEl = document.getElementById('adsCount');
  if (countEl){
    countEl.textContent = String(adsData.length);
    countEl.style.display = adsData.length ? 'inline-block' : 'none';
  }

  const empty = document.getElementById('adsEmpty');
  if (!adsData.length){
    document.getElementById('adsList').innerHTML = '';
    empty.style.display = 'block';
    stopAdsTimer();
    return;
  }
  empty.style.display = 'none';
  drawAdsWindow();
  startAdsTimer();
}
function drawAdsWindow(){
  const box = document.getElementById('adsList');
  const n = adsData.length;
  const take = Math.min(ADS_PAGE_SIZE, n);
  const win = [];
  for(let i=0;i<take;i++){ win.push(adsData[(adsIndex + i) % n]); }
  box.innerHTML = win.map(()=>`
    <div class="link-preview">
      <div class="thumb" style="width:64px;height:64px;border-radius:8px;background:#f1f4ff"></div>
      <div class="meta" style="flex:1;min-width:0">
        <div class="title placeholder-glow"><span class="placeholder col-8" style="height:16px"></span></div>
        <div class="desc placeholder-glow"><span class="placeholder col-10" style="height:12px"></span></div>
        <div class="site placeholder-glow"><span class="placeholder col-4" style="height:12px"></span></div>
        <div><span class="small text-muted">Đang tải…</span></div>
      </div>
      <div class="actions"></div>
    </div>
  `).join('');
  win.forEach(async (s, i)=>{
    const card = box.children[i]; if (!card) return;
    let p=null; try{ p = await fetchLinkPreview(s.url); }catch(e){}
    const host = hostnameFromUrl(s.url);
    const img  = p?.ok && p.image ? httpsImage(p.image) : `https://www.google.com/s2/favicons?domain=${host}&sz=64`;
    const tit  = p?.ok && p.title ? p.title : host;
    const des  = p?.ok && p.description ? p.description : '';
    const ico  = p?.ok && p.favicon ? p.favicon : `https://www.google.com/s2/favicons?domain=${host}&sz=16`;
    const site = p?.ok && p.siteName ? p.siteName : host;
    card.innerHTML = `
      <img class="thumb" src="${esc(img)}" alt=""
           onerror="this.src='https://via.placeholder.com/64?text=%F0%9F%93%8C'">
      <div class="meta" style="flex:1;min-width:0">
        <div class="title text-truncate" title="${esc(tit)}">${esc(tit)}</div>
        <div class="desc">${esc(des)}</div>
        <div class="site">
          <img src="${esc(ico)}" style="width:14px;height:14px;vertical-align:-2px;margin-right:4px"
               onerror="this.style.display='none'">${esc(site)}
        </div>
        <div><a href="${esc(s.url)}" target="_blank" rel="noopener" class="small">Mở trang</a></div>
      </div>
      <div class="actions">
        <a href="${esc(s.url)}" target="_blank" class="btn btn-sm btn-outline-primary">Liên hệ</a>
        ${ s.doc ? `<a href="${esc(s.doc)}" target="_blank" class="btn btn-sm btn-outline-success">Tệp DN</a>`
                 : `<span class="doc-missing">Chưa có tệp</span>` }
      </div>
    `;
  });
}
function startAdsTimer(){
  stopAdsTimer();
  if (ADS_INTERVAL <= 0 || adsData.length <= ADS_PAGE_SIZE) return;
  adsTimer = setInterval(()=>{ adsIndex = (adsIndex + ADS_PAGE_SIZE) % adsData.length; drawAdsWindow(); }, ADS_INTERVAL);
}
function stopAdsTimer(){ if (adsTimer){ clearInterval(adsTimer); adsTimer = null; } }

/* ===== CART ===== */
function addToCartById(id){ const it=products[id]; if(!it) return; const f=cart.find(p=>p.id===id); if(f) f.qty++; else cart.push({...it,qty:1}); updateCart(); if (AUTO_OPEN_ON_ADD) cartOffcanvas.show(); }
function changeQty(id,delta){ const it=cart.find(p=>p.id===id); if(!it) return; it.qty+=delta; if(it.qty<=0) cart.splice(cart.indexOf(it),1); updateCart(); }
function removeItem(id){ const i=cart.findIndex(p=>p.id===id); if(i>=0) cart.splice(i,1); updateCart(); }
function clearCart(){ if(confirm("Xóa toàn bộ giỏ hàng?")){ cart.length=0; updateCart(); } }

function getServiceFee(){
  const v=document.getElementById('serviceSelect')?.value||'none';
  if(v==='none') return 0;
  const parts=v.split('@'); return Number(parts[1]||0);
}
function getSubtotal(){
  return cart.reduce((a,b)=>a+b.qty*(Number(b.price)||0),0);
}
function updateCart(){
  const count = cart.reduce((a,b)=>a+b.qty,0);
  const fabCount = document.getElementById('cartFabCount');
  if(fabCount){ fabCount.textContent=count; fabCount.style.display = count>0 ? 'inline-block' : 'none'; }

  const list=document.getElementById('cartList'); let subtotal=0;
  list.innerHTML=cart.map(it=>{
    const sub=it.qty*(Number(it.price)||0); subtotal+=sub;
    return `<div class="d-flex align-items-center gap-2 border-bottom py-2">
      <img src="${esc(httpsImage(it.img))}" alt="" style="width:50px;height:50px;object-fit:cover;border-radius:4px;border:1px solid #ddd"
           onerror="this.src='https://via.placeholder.com/50?text=%F0%9F%93%8C'">
      <div class="flex-grow-1">
        <div class="fw-semibold small text-truncate" title="${esc(it.details||it.id)}">${esc(it.details||it.id)}</div>
        <div class="text-muted small">${fmtVND(it.price)}</div>
      </div>
      <div class="d-flex align-items-center gap-1">
        <button class="btn btn-sm btn-outline-secondary" data-action="qty" data-id="${esc(it.id)}" data-delta="-1">-</button>
        <span>${it.qty}</span>
        <button class="btn sm btn-outline-secondary" data-action="qty" data-id="${esc(it.id)}" data-delta="1">+</button>
      </div>
      <div style="min-width:90px;text-align:right" class="small">${fmtVND(sub)}</div>
      <button class="btn btn-sm btn-link text-danger" data-action="remove" data-id="${esc(it.id)}">&times;</button>
    </div>`;
  }).join('');

  // hiển thị tổng + phí
  const fee = getServiceFee();
  document.getElementById('cartSubtotal').innerText = fmtVND(subtotal);
  const feeRow = document.getElementById('serviceFeeRow');
  if(fee>0){ feeRow.style.display='flex'; document.getElementById('serviceFeeText').innerText = fmtVND(fee); }
  else { feeRow.style.display='none'; }
  document.getElementById('cartTotal').innerText = fmtVND(subtotal + fee);
}

/* Submit order: JSON nếu không có tệp; có tệp => multipart */
function submitOrder(){
  if(cart.length===0){ alert("Giỏ hàng trống!"); return; }
  const name=document.getElementById("buyerName").value.trim();
  const email=document.getElementById("buyerEmail").value.trim();
  const phone=document.getElementById("buyerPhone").value.trim();
  const address=document.getElementById("buyerAddress").value.trim();
  const note=document.getElementById("buyerNote").value.trim();
  const files=document.getElementById("buyerFiles").files;
  const service=document.getElementById("serviceSelect").value;
  const quoteByFile=document.getElementById("quoteByFile").checked;

  if(!name||!email||!phone||!address){ alert("Vui lòng nhập đầy đủ thông tin!"); return; }

  const subtotal=getSubtotal();
  const serviceFee=getServiceFee();

  const order={
    customer:{name,email,phone,address,note, service, quoteByFile, serviceFee},
    items:cart.map(({id,details,type,price,qty,img,linkFull,group,loai,category,note})=>({id,details,type,price,qty,img,linkFull,group,loai,category,note})),
    total: subtotal + serviceFee
  };

  // Có file -> gửi multipart
  if(files && files.length>0){
    const fd = new FormData();
    fd.append('action','order');
    fd.append('data', JSON.stringify(order));
    for(const f of files) fd.append('files[]', f, f.name);

    fetch(API_URL,{ method:"POST", body: fd })
      .then(async r=>{ const t=await r.text(); let j=null; try{ j=JSON.parse(t);}catch(_){}
        if(!r.ok) throw new Error((j&&j.error)||('HTTP '+r.status+' '+t));
        if(j && (j.ok||j.success)){ alert("Đã gửi đơn hàng thành công!"); cart.length=0; updateCart(); }
        else throw new Error((j&&j.error)||"Gửi đơn hàng thất bại.");
      })
      .catch(err=>alert("Không thể gửi đơn hàng (multipart). Kiểm tra API_URL / Apps Script.\n"+(err?.message||err)));
    return;
  }

  // Không có file -> JSON
  fetch(API_URL,{method:"POST",headers:{"Content-Type":"application/json"},
    body:JSON.stringify({action:"order",data:order})})
    .then(async r=>{ const t=await r.text(); let j=null; try{ j=JSON.parse(t);}catch(_){}
      if(!r.ok) throw new Error((j&&j.error)||('HTTP '+r.status+' '+t));
      if(j && (j.ok||j.success)){ alert("Đã gửi đơn hàng thành công!"); cart.length=0; updateCart(); }
      else throw new Error((j&&j.error)||"Gửi đơn hàng thất bại.");
    })
    .catch(err=>alert("Không thể gửi đơn hàng (JSON). Kiểm tra API_URL.\n"+(err?.message||err)));
}

/* Offcanvas */
const cartOffcanvas   = bootstrap.Offcanvas.getOrCreateInstance(document.getElementById('cartCanvas'));
const filterOffcanvas = bootstrap.Offcanvas.getOrCreateInstance(document.getElementById('filterPanel'));
const suppliersOffcanvas = bootstrap.Offcanvas.getOrCreateInstance(document.getElementById('suppliersCanvas'));

/* Events */
document.addEventListener('click', (e)=>{
  const el=e.target;
  if(el.matches('[data-action="add-to-cart"]')) addToCartById(el.dataset.id);
  if(el.closest('[data-action="select-category"]')) selectCategory(el.closest('[data-action="select-category"]').dataset.val||'');
  if(el.matches('[data-action="set-filter"]')){
    const field = el.dataset.field;
    state[field]=el.dataset.val||'';
    state.page=1; fetchPage(); updateFilterCount();
  }
  if(el.matches('[data-action="remove"]')) removeItem(el.dataset.id);
  if(el.matches('#searchBtn')){ state.q=document.getElementById('searchBox').value.trim(); state.page=1; fetchPage(); }
  if(el.matches('[data-action="goto-page"]')){ const p=Number(el.dataset.page); if(p&&p!==state.page){ state.page=p; fetchPage(); } }
  if(el.matches('#clearCartBtn')) clearCart();
  if(el.matches('[data-action="qty"]')){ changeQty(el.dataset.id, Number(el.dataset.delta)); }
});
document.getElementById('adsPrevBtn').addEventListener('click', ()=>{ if(!adsData.length) return; adsIndex = (adsIndex - ADS_PAGE_SIZE + adsData.length) % adsData.length; drawAdsWindow(); startAdsTimer(); });
document.getElementById('adsNextBtn').addEventListener('click', ()=>{ if(!adsData.length) return; adsIndex = (adsIndex + ADS_PAGE_SIZE) % adsData.length; drawAdsWindow(); startAdsTimer(); });
document.getElementById('refreshAdsBtn').addEventListener('click', fetchAds);
document.getElementById('searchBox').addEventListener('keydown',e=>{ if(e.key==='Enter'){ e.preventDefault(); document.getElementById('searchBtn').click(); } });

/* FAB */
document.getElementById('cartFab').addEventListener('click', () => cartOffcanvas.toggle());
document.getElementById('filterFab').addEventListener('click', () => filterOffcanvas.toggle());
document.getElementById('suppliersFab').addEventListener('click', ()=>{ loadSuppliers(); suppliersOffcanvas.show(); });
document.getElementById('zaloFab').setAttribute('href', ZALO_URL);

/* Clear filters */
function clearAllFilters(){
  state.type=''; state.loai=''; state.note=''; state.category=''; state.group='';
  updateFilterCount(); state.page=1; fetchPage();
}
document.getElementById('clearFiltersBtn').addEventListener('click', clearAllFilters);
document.getElementById('clearFiltersBtn2').addEventListener('click', clearAllFilters);

/* Danh sách xưởng (sheet NHAXUONG) */
function loadSuppliers(){
  const box=document.getElementById('suppliersList');
  box.innerHTML='Đang tải…';
  fetch(API_URL+'?action=suppliers')
    .then(r=>r.json())
    .then(res=>{
      if(!res||!res.ok||!res.items||!res.items.length){ box.innerHTML='<div class="text-muted">Chưa có dữ liệu.</div>'; return; }
      box.innerHTML = res.items.map(s=>`
        <div class="mb-2 p-2 border rounded bg-white">
          <div class="fw-semibold">${esc(s.name||'Xưởng')}</div>
          ${s.url?`<a href="${esc(s.url)}" target="_blank" class="small d-block">${esc(s.url)}</a>`:''}
          ${s.address?`<div class="text-muted small">📍 ${esc(s.address)}</div>`:''}
          ${s.cert?`<div class="text-muted small">🗂 ${esc(s.cert)}</div>`:''}
        </div>
      `).join('');
    })
    .catch(()=>{ box.innerHTML='<div class="text-danger">Không tải được danh sách.</div>'; });
}

/* INIT */
fetchPage(); updateFilterCount();
document.getElementById('serviceSelect').addEventListener('change', updateCart);
document.getElementById('submitOrderBtn').addEventListener('click', submitOrder);
});
</script>
</body>
</html>
