<script>
/* ====== API URL của bạn ====== */
const API_URL="https://script.google.com/macros/s/AKfycbz-P3biIvSq1FYSt5I4T6tLYtv5mggIwRR3ug1FIUSbuZe6HMkLazUlbRyM1IW7LxH6/exec";

const state = { page:1, pageSize:36, q:'', group:'', type:'', loai:'', note:'', category:'' };
const cart = []; const products = {};

const fmtVND = n => (Number(n)||0).toLocaleString('vi-VN') + ' đ';
const esc = s => (s??'').toString().replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));

function badgeColor(txt){
  if(!txt) return "#555";
  const t = txt.toLowerCase();
  if(t.includes("mẫu") || t.includes("sample")) return "#4caf50";
  if(t.includes("giảm") || t.includes("sale") || t.includes("km")) return "#ff9800";
  if(t.includes("gấp") || t.includes("urgent")) return "#d32f2f";
  return "#555";
}

/* ===== Card sản phẩm: dùng data-id thay onclick ===== */
function productCardHtml(it){
  products[it.id] = it;
  return `<div class="col"><div class="cardx">
    ${it.note?`<span class="note-badge" style="background:${badgeColor(it.note)}">${esc(it.note)}</span>`:''}
    <a href="${esc(it.linkFull || it.img)}" target="_blank" rel="noopener">
      <img class="thumb" src="${esc(it.img)}" alt="${esc(it.id)}"
        onerror="this.src='https://via.placeholder.com/300x300?text=No+Image'">
    </a>
    <div class="meta">
      <div class="id">${esc(it.id)}</div>
      <div class="type-badge">${esc(it.type || '')}</div>
      <div class="details">${esc(it.details || '')}</div>
      <div class="price">${fmtVND(it.price)}</div>
      <button class="add-btn" data-action="add-to-cart" data-id="${esc(it.id)}">+</button>
    </div>
  </div></div>`;
}

function render(res){
  const grid = document.getElementById('productGrid');
  if(!res || !res.items || res.items.length===0){
    grid.innerHTML = '<div class="text-muted">Không có sản phẩm.</div>';
  } else {
    grid.innerHTML = res.items.map(it => productCardHtml(it)).join('');
  }

  const facets = res && res.facets ? res.facets : {};
  buildCategory(facets.groups || []);
  buildFilterBox('typeBox', facets.types || [], 'type');
  buildFilterBox('loaiBox', facets.loais || [], 'loai');
  buildFilterBox('noteBox', facets.notes || [], 'note');
}

function fetchPage(){
  const params = new URLSearchParams({
    action:'list',
    page: state.page,
    pageSize: state.pageSize,
    q: state.q,
    group: state.group,
    type: state.type,
    loai: state.loai,
    note: state.note,
    category: state.category
  });
  fetch(API_URL + '?' + params.toString())
    .then(r => r.json())
    .then(res => { render(res); })
    .catch(err => {
      console.error(err);
      document.getElementById('productGrid').innerHTML =
        '<div class="text-danger">Không tải được dữ liệu. Kiểm tra API_URL hoặc quyền truy cập Web App.</div>';
    });
}

/* ===== Category: dùng data-val, không nhúng vào chuỗi JS ===== */
function buildCategory(items){
  const grid = document.getElementById("categoryGrid");
  grid.innerHTML = (items||[]).map(val=>`
    <div class="col">
      <div class="category-item ${state.group===val?'active':''}" data-action="select-category" data-val="${esc(val)}">
        <img src="https://img.icons8.com/color/96/000000/category.png" alt="">
        <span>${esc(val)}</span>
      </div>
    </div>
  `).join('');
}
function selectCategory(val){
  state.group = val; state.page = 1; fetchPage();
  document.querySelectorAll('.category-item').forEach(el=>{
    el.classList.toggle('active', el.dataset.val === val);
  });
}

/* ===== Filter: cũng dùng data-attr thay onclick ===== */
function buildFilterBox(boxId, items, field){
  const box = document.getElementById(boxId);
  box.innerHTML = (items||[]).map(val=>`
    <button class="btn btn-sm ${state[field]===val?'btn-primary':'btn-outline-secondary'} me-1 mb-1"
      data-action="set-filter" data-field="${field}" data-val="${esc(val)}">${esc(val)}</button>
  `).join('');
}
function updateFilterCount(){
  let count = 0;
  if(state.type) count++;
  if(state.loai) count++;
  if(state.note) count++;
  if(state.category) count++;
  document.getElementById("filterBtn").innerText = `⚙️ Bộ lọc${count>0?' ('+count+')':''}`;
}

/* ===== Giỏ hàng ===== */
function addToCartById(id){
  const item = products[id];
  if(item){
    const found = cart.find(p=>p.id===id);
    if(found) found.qty++;
    else cart.push({...item, qty:1});
    updateCart(); openCart();
  }
}
function changeQty(id,delta){
  const it = cart.find(p=>p.id===id); if(!it) return;
  it.qty += delta; if(it.qty<=0) cart.splice(cart.indexOf(it),1);
  updateCart();
}
function removeItem(id){
  const idx = cart.findIndex(p=>p.id===id);
  if(idx>=0) cart.splice(idx,1);
  updateCart();
}
function clearCart(){
  if(confirm("Xóa toàn bộ giỏ hàng?")){ cart.length = 0; updateCart(); }
}
function updateCart(){
  document.getElementById('cartCount').innerText = cart.reduce((a,b)=>a+b.qty,0);
  const list = document.getElementById('cartList');
  let total = 0;
  list.innerHTML = cart.map(it=>{
    const sub = it.qty*(Number(it.price)||0); total += sub;
    return `<div class="cart-item">
      <img src="${esc(it.img)}" alt="">
      <div class="cart-info">
        <div class="cart-title">${esc(it.details||it.id)}</div>
        <div>${fmtVND(it.price)}</div>
      </div>
      <div class="cart-actions">
        <button class="qty-btn" data-action="qty" data-id="${esc(it.id)}" data-delta="-1">-</button>
        <span>${it.qty}</span>
        <button class="qty-btn" data-action="qty" data-id="${esc(it.id)}" data-delta="1">+</button>
      </div>
      <div style="min-width:80px;text-align:right">${fmtVND(sub)}</div>
      <button class="remove-btn" data-action="remove" data-id="${esc(it.id)}">&times;</button>
    </div>`;
  }).join('');
  document.getElementById('cartTotal').innerText = fmtVND(total);
}

/* ===== Gửi đơn hàng ===== */
function submitOrder(){
  if(cart.length===0){ alert("Giỏ hàng trống!"); return; }
  const name = document.getElementById("buyerName").value.trim();
  const email = document.getElementById("buyerEmail").value.trim();
  const phone = document.getElementById("buyerPhone").value.trim();
  const address = document.getElementById("buyerAddress").value.trim();
  const note = document.getElementById("buyerNote").value.trim();
  if(!name||!email||!phone||!address){ alert("Vui lòng nhập đầy đủ thông tin!"); return; }

  const order = {
    customer:{name,email,phone,address,note},
    items: cart.map(({id,details,type,price,qty,img,linkFull,group,loai,category,note})=>({
      id, details, type, price, qty, img, linkFull, group, loai, category, note
    })),
    total: cart.reduce((a,b)=>a+b.qty*(Number(b.price)||0),0)
  };

  fetch(API_URL, {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ action:"order", email:"lehaidangem836@gmail.com", data:order })
  })
  .then(r=>r.json())
  .then(res=>{
    if(res && (res.ok || res.success)){
      alert("Đã gửi đơn hàng thành công! Chúng tôi sẽ liên hệ sớm.");
      cart.length = 0; updateCart();
    }else{
      alert("Gửi đơn hàng thất bại. Vui lòng thử lại.");
    }
  })
  .catch(()=>alert("Không thể gửi đơn hàng. Kiểm tra kết nối hoặc API_URL."));
}

/* ===== Event delegation: gỡ hết onclick inline ===== */
document.addEventListener('click', (e)=>{
  const el = e.target;

  // Add to cart
  if(el.matches('[data-action="add-to-cart"]')){
    addToCartById(el.dataset.id);
  }

  // Category
  if(el.closest('[data-action="select-category"]')){
    const target = el.closest('[data-action="select-category"]');
    selectCategory(target.dataset.val||'');
  }

  // Filter buttons
  if(el.matches('[data-action="set-filter"]')){
    const field = el.dataset.field;
    const val = el.dataset.val||'';
    state[field] = val; state.page=1; fetchPage(); updateFilterCount();
  }

  // Qty change
  if(el.matches('[data-action="qty"]')){
    changeQty(el.dataset.id, Number(el.dataset.delta||0));
  }

  // Remove item
  if(el.matches('[data-action="remove"]')){
    removeItem(el.dataset.id);
  }
});

/* ===== Cart toggle ===== */
function openCart(){ document.getElementById('cartSidebar').classList.add('open'); }
function closeCart(){ document.getElementById('cartSidebar').classList.remove('open'); }

/* ===== Search & paging ===== */
document.getElementById('searchBtn').addEventListener('click', ()=>{
  state.q = document.getElementById('searchBox').value.trim();
  state.page = 1; fetchPage();
});
document.getElementById('searchBox').addEventListener('keydown', (e)=>{
  if(e.key==='Enter') document.getElementById('searchBtn').click();
});
document.getElementById('prevBtn').addEventListener('click', ()=>{
  if(state.page>1){ state.page--; fetchPage(); }
});
document.getElementById('nextBtn').addEventListener('click', ()=>{
  state.page++; fetchPage();
});
document.getElementById('cartBtn').addEventListener('click', openCart);

/* ===== Khởi động ===== */
function loadFactories(){
  const holder = document.getElementById('factoryList');
  const demo = [
    {name:'Xưởng A',desc:'Chuyên huy hiệu, mạ vàng',url:'#'},
    {name:'Xưởng B',desc:'In UV, số lượng lớn',url:'#'},
    {name:'Xưởng C',desc:'Ép khuôn, men mềm',url:'#'}
  ];
  holder.innerHTML = demo.map(x=>`
    <div class="d-flex align-items-start gap-2 mb-2">
      <img src="https://picsum.photos/seed/${encodeURIComponent(x.name)}/56/56" width="56" height="56" class="rounded" alt="">
      <div>
        <div class="fw-bold">${esc(x.name)}</div>
        <div class="small text-muted">${esc(x.desc)}</div>
        <a href="${esc(x.url)}" class="small">Xem chi tiết</a>
      </div>
    </div>`).join('');
}
loadFactories();
fetchPage();
</script>
