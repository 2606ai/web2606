<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>2606AI Marketplace</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
:root{--main:#0018a8;--accent:#d4af37;--bg:#f5f6fa}
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,'Be Vietnam Pro',sans-serif;background:var(--bg);font-size:14px;padding-top:68px}
.container-fluid{max-width:1400px;margin:auto}
.top-banner{background:#000;color:#fff;text-align:center;padding:6px;font-weight:600}

/* Header */
.site-header{position:fixed;top:0;left:0;right:0;z-index:1055;background:#fff;border-bottom:1px solid #eee;height:68px;display:flex;align-items:center;justify-content:space-between;padding:8px 12px;box-shadow:0 2px 8px rgba(0,0,0,.05)}
.site-header img.logo{height:42px}
.brand-title{font-weight:800;font-size:18px;color:var(--main)}

/* Sidebar box */
.sidebar-box{background:#fff;border-radius:10px;padding:12px;margin-bottom:14px;box-shadow:0 2px 6px rgba(0,0,0,.06)}

/* Category icons (danh m·ª•c s·∫£n ph·∫©m) */
.cat-pill{display:flex;flex-direction:column;align-items:center;gap:8px;background:#fff;border:1px solid #eee;border-radius:14px;padding:10px 8px;min-width:110px;cursor:pointer;transition:.15s}
.cat-pill:hover{box-shadow:0 4px 10px rgba(0,0,0,.08);transform:translateY(-2px)}
.cat-icon{width:46px;height:46px;border-radius:14px;background:#f1f4ff;display:flex;align-items:center;justify-content:center;color:var(--main);font-weight:700}
.cat-label{font-size:12px;color:#333;text-align:center}
.cat-pill.active{border-color:var(--main);background:#f3f7ff}

/* Card s·∫£n ph·∫©m */
#productGrid .col{padding:6px}
.cardx{background:#fff;border:1px solid #eaeaea;border-radius:12px;overflow:hidden;position:relative;height:100%;display:flex;flex-direction:column;transition:.15s;box-shadow:0 2px 6px rgba(0,0,0,.05)}
.cardx:hover{transform:translateY(-3px);box-shadow:0 6px 16px rgba(0,0,0,.12)}
.cardx img.thumb{width:100%;height:195px;object-fit:cover;background:#fafafa}
.note-badge{position:absolute;top:8px;left:8px;background:#ff9800;color:#fff;font-weight:700;font-size:12px;border-radius:12px;padding:2px 8px}
.meta{padding:8px 10px;display:flex;flex-direction:column;gap:6px;flex:1}
.id{font-weight:700;color:#0018a8;font-size:13px}
.details{color:#555;font-size:12px;flex:1;overflow:hidden;text-overflow:ellipsis;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical}
.type-badge{display:inline-block;background:#eaf3ff;color:#0056b3;font-weight:700;font-size:11px;border-radius:16px;padding:2px 8px}
.row-meta{display:flex;align-items:center;justify-content:space-between;margin-top:2px}
.price{color:#d32f2f;font-weight:800}
.add-btn{background:var(--main);border:0;color:#fff;width:30px;height:30px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:18px}

/* Offcanvas filter */
.badge-dot{display:inline-flex;align-items:center;justify-content:center;background:#d32f2f;color:#fff;border-radius:10px;padding:0 6px;font-size:12px;margin-left:6px}

/* Cart modal */
.cart-item{display:flex;gap:8px;border-bottom:1px solid #eee;padding:8px 0}
.cart-item img{width:56px;height:56px;object-fit:cover;border:1px solid #eee;border-radius:8px}
.cart-info{flex:1}
.qty-btn{width:28px;height:28px;border:1px solid #ccc;background:#fff;border-radius:6px;display:inline-flex;align-items:center;justify-content:center}
.remove-btn{background:none;border:none;color:#d32f2f;font-size:18px}

/* Pagination buttons spacing */
.pager{display:flex;justify-content:space-between;margin-top:8px}
</style>
</head>
<body>

<!-- Header -->
<div class="site-header">
  <div class="d-flex align-items-center gap-2">
    <img class="logo" src="https://raw.githubusercontent.com/datnguyenIT/2606ai-assets/main/logo.png" alt="logo">
    <span class="brand-title">2606AI Marketplace</span>
  </div>
  <div class="d-flex align-items-center gap-2">
    <button class="btn btn-outline-secondary" data-bs-toggle="offcanvas" data-bs-target="#filterPanel">
      ‚öôÔ∏è B·ªô l·ªçc <span id="filterCount" class="badge-dot d-none">0</span>
    </button>
    <button class="btn btn-outline-dark" data-bs-toggle="modal" data-bs-target="#cartModal">üõí Gi·ªè h√†ng <span id="cartCount">0</span></button>
  </div>
</div>

<!-- Banner nh·ªè -->
<div class="top-banner">∆Øu ƒë√£i th√°ng n√†y cho kh√°ch ƒë·∫∑t qua 2606ai.vn</div>

<div class="container-fluid my-3">
  <div class="row g-2 mb-3">
    <div class="col-lg-8">
      <!-- Hero carousel -->
      <div id="heroCarousel" class="carousel slide" data-bs-ride="carousel">
        <div class="carousel-inner">
          <div class="carousel-item active">
            <img class="d-block w-100" src="https://picsum.photos/1200/360?random=1" alt="">
          </div>
          <div class="carousel-item">
            <img class="d-block w-100" src="https://picsum.photos/1200/360?random=2" alt="">
          </div>
          <div class="carousel-item">
            <img class="d-block w-100" src="https://picsum.photos/1200/360?random=3" alt="">
          </div>
        </div>
        <button class="carousel-control-prev" type="button" data-bs-target="#heroCarousel" data-bs-slide="prev">
          <span class="carousel-control-prev-icon"></span>
        </button>
        <button class="carousel-control-next" type="button" data-bs-target="#heroCarousel" data-bs-slide="next">
          <span class="carousel-control-next-icon"></span>
        </button>
      </div>
    </div>
    <div class="col-lg-4 d-flex flex-column gap-2">
      <img class="w-100 rounded" src="https://picsum.photos/600/176?random=11" alt="">
      <img class="w-100 rounded" src="https://picsum.photos/600/176?random=12" alt="">
    </div>
  </div>

  <div class="row">
    <!-- Sidebar -->
    <div class="col-lg-3">
      <div class="sidebar-box">
        <h6 class="fw-bold mb-2">Quy·ªÅn l·ª£i</h6>
        <ul class="mb-0 small">
          <li>‚ö° B√°o gi√° nhanh 24h</li>
          <li>üé® Thi·∫øt k·∫ø mi·ªÖn ph√≠</li>
          <li>‚úÖ QC 2 l·ªõp</li>
          <li>üöö Giao h√†ng to√†n qu·ªëc</li>
        </ul>
      </div>

      <div class="sidebar-box">
        <h6 class="fw-bold mb-2">X∆∞·ªüng ƒë·ªÅ xu·∫•t</h6>
        <div class="d-flex align-items-center gap-2 mb-2">
          <img src="https://picsum.photos/60?1" class="rounded" alt="">
          <div><div class="fw-bold small">X∆∞·ªüng 1 ‚Äì Tem kim lo·∫°i</div><div class="text-muted small">Men m√†u, m·∫° v√†ng; ƒë√∫c n·ªïi 3D</div></div>
        </div>
        <div class="d-flex align-items-center gap-2 mb-2">
          <img src="https://picsum.photos/60?2" class="rounded" alt="">
          <div><div class="fw-bold small">X∆∞·ªüng 2 ‚Äì In UV</div><div class="text-muted small">Chi ti·∫øt s·∫Øc n√©t, b·ªÅn cao</div></div>
        </div>
        <div class="d-flex align-items-center gap-2 mb-2">
          <img src="https://picsum.photos/60?3" class="rounded" alt="">
          <div><div class="fw-bold small">X∆∞·ªüng 3 ‚Äì ƒê√∫c huy hi·ªáu</div><div class="text-muted small">ƒê√∫c n·ªïi 3D, m·∫° cao c·∫•p</div></div>
        </div>
      </div>
    </div>

    <!-- Content -->
    <div class="col-lg-9">
      <!-- Danh m·ª•c s·∫£n ph·∫©m (gi·ªëng c√°c icon Shopee) -->
      <div class="bg-white rounded shadow-sm p-2 mb-2">
        <h6 class="fw-bold mb-2">DANH M·ª§C S·∫¢N PH·∫®M</h6>
        <div class="d-flex flex-wrap gap-2" id="categoryRow">
          <!-- render ·ªü JS -->
        </div>
      </div>

      <!-- Search -->
      <div class="input-group mb-2">
        <span class="input-group-text bg-primary text-white">üîç</span>
        <input id="searchBox" class="form-control" placeholder="T√¨m s·∫£n ph·∫©m... (id, details)">
        <button id="btnFind" class="btn btn-primary">T√¨m</button>
      </div>

      <!-- Grid -->
      <div id="productGrid" class="row row-cols-2 row-cols-md-3 row-cols-lg-6 g-0"></div>

      <!-- Pagination -->
      <div class="pager">
        <button id="prevBtn" class="btn btn-outline-secondary">‚Üê Tr∆∞·ªõc</button>
        <button id="nextBtn" class="btn btn-outline-secondary">Sau ‚Üí</button>
      </div>
    </div>
  </div>
</div>

<!-- Offcanvas filter -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="filterPanel">
  <div class="offcanvas-header">
    <h5>B·ªô l·ªçc</h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
  </div>
  <div class="offcanvas-body">
    <h6 class="fw-bold mb-2">TYPE</h6>
    <div id="typeBox" class="mb-3 d-flex flex-wrap gap-2"></div>

    <h6 class="fw-bold mb-2">LO·∫†I</h6>
    <div id="loaiBox" class="mb-3 d-flex flex-wrap gap-2"></div>

    <h6 class="fw-bold mb-2">CATEGORY</h6>
    <div id="catBox" class="mb-3 d-flex flex-wrap gap-2"></div>

    <button class="btn btn-sm btn-outline-secondary" id="btnClearFilter">X√≥a b·ªô l·ªçc</button>
  </div>
</div>

<!-- Cart modal -->
<div class="modal fade" id="cartModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Gi·ªè h√†ng</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div id="cartList"></div>
        <div class="d-flex justify-content-between fw-bold mt-2">
          <div>T·ªïng c·ªông</div>
          <div id="cartTotal">0 ƒë</div>
        </div>

        <hr>
        <div class="row g-2">
          <div class="col-md-6">
            <input id="buyerName" class="form-control mb-2" placeholder="H·ªç v√† t√™n">
            <input id="buyerPhone" class="form-control mb-2" placeholder="S·ªë ƒëi·ªán tho·∫°i">
            <input id="buyerEmail" class="form-control mb-2" placeholder="Email">
          </div>
          <div class="col-md-6">
            <input id="buyerAddress" class="form-control mb-2" placeholder="ƒê·ªãa ch·ªâ nh·∫≠n h√†ng">
            <textarea id="buyerNote" class="form-control mb-2" placeholder="Ghi ch√∫"></textarea>
            <div class="d-flex gap-2">
              <button id="btnClearCart" class="btn btn-outline-danger">X√≥a to√†n b·ªô</button>
              <button id="btnSubmitOrder" class="btn btn-success flex-fill">G·ª≠i ƒë∆°n h√†ng</button>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer small text-muted">
        Sau khi g·ª≠i ƒë∆°n, ch√∫ng t√¥i s·∫Ω li√™n h·ªá x√°c nh·∫≠n trong 24h.
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
// ========= CONFIG =========
const API_URL = "https://script.google.com/macros/s/AKfycbzATc7jxCAypch1kauqsCSpffvDhygwNyvV9AIelAXUe1J9dn-mBOd1-UFYOWvL78MT/exec";
const state = { page:1, pageSize:24, q:'', group:'', category:'', loai:'', type:'' };
const products = {};
const cart = [];

// ========= HELPERS =========
const fmt = n => (Number(n)||0).toLocaleString('vi-VN')+' ƒë';
const esc = s => (s??'').toString().replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
const $ = sel => document.querySelector(sel);
const el = (id)=>document.getElementById(id);

// ========= RENDER: CARD =========
function productCardHtml(it){
  products[it.id]=it;
  const thumb = esc(it.img||'');
  const full   = esc(it.full||it.img||'');
  return `
  <div class="col">
    <div class="cardx">
      ${it.chuy?`<span class="note-badge">${esc(it.chuy)}</span>`:''}
      <a href="${full}" target="_blank" rel="noopener">
        <img class="thumb" loading="lazy"
          src="${thumb}"
          onerror="this.src='https://placehold.co/300x300?text=No+Image'">
      </a>
      <div class="meta">
        <div class="id">${esc(it.id||'')}</div>
        <div class="details">${esc(it.details||'')}</div>
        <div class="type-badge">${esc(it.type||'')}</div>
        <div class="row-meta">
          <div class="price">${fmt(it.price)}</div>
          <button class="add-btn" onclick="addToCartById('${esc(it.id)}')">+</button>
        </div>
      </div>
    </div>
  </div>`;
}

// ========= FETCH PAGE =========
function fetchPage(){
  const params = new URLSearchParams({...state, action:'list'});
  fetch(API_URL + '?' + params.toString())
    .then(r=>r.json())
    .then(res=>{
      renderProducts(res.items||[]);
      renderFacetBoxes(res.facets||{});
      updateFilterBadge();
    })
    .catch(err=>{
      console.error('L·ªói t·∫£i API:',err);
      el('productGrid').innerHTML='<div class="text-danger p-3">Kh√¥ng t·∫£i ƒë∆∞·ª£c d·ªØ li·ªáu. Ki·ªÉm tra API_URL.</div>';
    });
}

function renderProducts(items){
  const grid = el('productGrid');
  if(!items.length){ grid.innerHTML='<div class="text-muted p-3">Kh√¥ng c√≥ s·∫£n ph·∫©m.</div>'; return; }
  grid.innerHTML = items.map(productCardHtml).join('');
}

// ========= FACETS =========
function pill(label, active, onclick){
  return `<div class="cat-pill ${active?'active':''}" onclick="${onclick}">
    <div class="cat-icon">‚Çø</div>
    <div class="cat-label">${esc(label||'Kh√°c')}</div>
  </div>`;
}
function renderFacetBoxes(f){
  // danh m·ª•c ki·ªÉu Shopee
  const cates = f.categories || f.dongs || []; // fallback n·∫øu backend c≈©
  const row = el('categoryRow');
  row.innerHTML = (cates||[]).map(c => pill(c, state.category===c, `applyCategory('${esc(c)}')`)).join('') 
                 + pill('T·∫•t c·∫£', !state.category, `applyCategory('')`);

  // filter offcanvas
  const types = f.types || [];
  const loais = f.loais || [];
  const tBox = el('typeBox');  const lBox = el('loaiBox');  const catBox = el('catBox');
  tBox.innerHTML   = types.map(v=>btnFilter(v, 'type')).join('')   + btnFilter('T·∫•t c·∫£','type','');
  lBox.innerHTML   = loais.map(v=>btnFilter(v, 'loai')).join('')   + btnFilter('T·∫•t c·∫£','loai','');
  catBox.innerHTML = cates.map(v=>btnFilter(v, 'category')).join('') + btnFilter('T·∫•t c·∫£','category','');
}
function btnFilter(text, field, value){
  const val = (value!==undefined)? value : text;
  const active = (state[field]||'') === (val||'');
  return `<button class="btn btn-sm ${active?'btn-primary':'btn-outline-secondary'}"
     onclick="applyFilter('${field}','${esc(val)}')">${esc(text)}</button>`;
}
function applyFilter(field,val){
  state[field] = val || '';
  state.page = 1;
  fetchPage();
}
function applyCategory(v){ state.category = v || ''; state.page=1; fetchPage(); }

function updateFilterBadge(){
  const num = ['type','loai','category'].filter(k=>state[k]).length;
  const b = el('filterCount');
  if(num>0){ b.textContent=num; b.classList.remove('d-none'); }
  else b.classList.add('d-none');
}

// ========= SEARCH & PAGINATION =========
el('btnFind').onclick = ()=>{
  state.q = el('searchBox').value.trim();
  state.page=1; fetchPage();
};
el('prevBtn').onclick = ()=>{ if(state.page>1){ state.page--; fetchPage(); } };
el('nextBtn').onclick = ()=>{ state.page++; fetchPage(); };

// ========= CART =========
function addToCartById(id){
  const it = products[id]; if(!it) return;
  const f = cart.find(x=>x.id===id);
  if(f) f.qty++;
  else cart.push({id:it.id, details:it.details, type:it.type, price:Number(it.price)||0, img:it.img, qty:1});
  updateCart();
}
function changeQty(id,delta){
  const f = cart.find(x=>x.id===id); if(!f) return;
  f.qty += delta; if(f.qty<=0) cart.splice(cart.indexOf(f),1);
  updateCart();
}
function removeItem(id){
  const idx = cart.findIndex(x=>x.id===id);
  if(idx>=0){ cart.splice(idx,1); updateCart(); }
}
function clearCart(){
  cart.length = 0; updateCart();
}
function updateCart(){
  el('cartCount').textContent = cart.reduce((a,b)=>a+b.qty,0);
  const list = el('cartList');
  let total = 0;
  list.innerHTML = cart.map(it=>{
    const sub = it.qty * (Number(it.price)||0); total+=sub;
    return `
    <div class="cart-item">
      <img src="${esc(it.img||'https://placehold.co/56')}"
           onerror="this.src='https://placehold.co/56'">
      <div class="cart-info">
        <div class="fw-bold small">${esc(it.details||it.id)}</div>
        <div class="text-muted">${fmt(it.price)}</div>
      </div>
      <div class="d-flex align-items-center gap-1">
        <button class="qty-btn" onclick="changeQty('${esc(it.id)}',-1)">-</button>
        <div class="px-2">${it.qty}</div>
        <button class="qty-btn" onclick="changeQty('${esc(it.id)}',1)">+</button>
      </div>
      <div class="ms-2" style="min-width:100px;text-align:right">${fmt(sub)}</div>
      <button class="remove-btn ms-1" title="X√≥a" onclick="removeItem('${esc(it.id)}')">&times;</button>
    </div>`;
  }).join('');
  el('cartTotal').textContent = fmt(total);
}
el('btnClearCart').onclick = clearCart;

// ========= SUBMIT ORDER =========
el('btnSubmitOrder').onclick = async ()=>{
  if(cart.length===0){ alert('Gi·ªè h√†ng tr·ªëng'); return; }
  const name = el('buyerName').value.trim();
  const phone= el('buyerPhone').value.trim();
  const email= el('buyerEmail').value.trim();
  const addr = el('buyerAddress').value.trim();
  const note = el('buyerNote').value.trim();
  if(!name || !phone || !addr){ alert('Vui l√≤ng nh·∫≠p H·ªç t√™n, SƒêT v√† ƒê·ªãa ch·ªâ'); return; }

  const total = cart.reduce((a,b)=>a+b.qty*(Number(b.price)||0),0);
  const order = { customer:{name,phone,email,address:addr,note}, cart, total };

  try{
    const body = new FormData();
    body.append('action','order');
    body.append('order', JSON.stringify(order));
    const r = await fetch(API_URL, { method:'POST', body });
    const res = await r.json();
    alert(res.message || 'ƒê√£ g·ª≠i ƒë∆°n h√†ng!');
    clearCart();
    // reset form
    ['buyerName','buyerPhone','buyerEmail','buyerAddress','buyerNote'].forEach(id=>el(id).value='');
    bootstrap.Modal.getInstance($('#cartModal')).hide?.();
  }catch(e){
    console.error(e);
    alert('G·ª≠i ƒë∆°n th·∫•t b·∫°i. Vui l√≤ng th·ª≠ l·∫°i!');
  }
};

// ========= CLEAR FILTER BUTTON =========
el('btnClearFilter').onclick = ()=>{
  state.type=''; state.loai=''; state.category=''; state.page=1; fetchPage();
};

// ========= INIT =========
document.addEventListener('DOMContentLoaded', ()=>{
  fetchPage();
});
</script>
</body>
</html>
