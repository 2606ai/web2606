<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>2606AI Marketplace</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
:root{ --main:#0018a8; --accent:#d4af37; --bg:#f5f6fa; }
body{font-family:'Be Vietnam Pro',system-ui,Arial,sans-serif;background:var(--bg);font-size:14px}
.container-fluid{max-width:1400px;margin:auto;}
.top-banner{background:#000;color:#fff;text-align:center;padding:6px;font-weight:600}

/* Header */
.site-header{
  background:#fff;padding:10px 15px;border-bottom:1px solid #eee;
  display:flex;align-items:center;justify-content:space-between;
  box-shadow:0 2px 6px rgba(0,0,0,.05);
  position:sticky;top:0;z-index:1055;
}
.site-header img.logo{height:42px}
.site-header .brand-title{font-weight:800;font-size:18px;color:var(--main)}

/* Sidebar */
.sidebar-box{background:#fff;padding:12px;border-radius:10px;margin-bottom:15px;box-shadow:0 2px 6px rgba(0,0,0,.06)}
.sidebar-box h6{font-weight:700;font-size:15px;margin-bottom:8px}

/* Hero */
.hero img{width:100%;height:320px;object-fit:cover;border-radius:10px}
@media (min-width:992px){ .hero img{height:360px} }

/* Category pills */
.cat-pill{display:inline-flex;align-items:center;gap:8px;
  border:1px solid #e9eef7;background:#fff;border-radius:999px;padding:8px 14px;
  cursor:pointer;transition:.15s;font-weight:600}
.cat-pill:hover{box-shadow:0 3px 10px rgba(0,0,0,.06)}
.cat-pill.active{border-color:var(--main);background:#eef4ff;color:#0b3fb1}
.cat-icon{width:26px;height:26px;border-radius:8px;background:#f4f7ff;display:flex;align-items:center;justify-content:center;color:var(--main);font-weight:700}

/* Product card */
.cardx{border:none;border-radius:12px;background:#fff;overflow:hidden;
  transition:.15s;box-shadow:0 2px 6px rgba(0,0,0,.08);position:relative;height:100%}
.cardx:hover{transform:translateY(-3px);box-shadow:0 8px 22px rgba(0,0,0,.12)}
.cardx img.thumb{width:100%;height:200px;object-fit:cover}
.cardx .note-badge{position:absolute;top:8px;left:8px;padding:2px 8px;border-radius:14px;font-size:12px;font-weight:700;color:#fff}
.cardx .meta{padding:10px;display:flex;flex-direction:column;gap:6px}
.cardx .id{font-weight:700;color:#0018a8;font-size:13px}
.cardx .details{font-size:12px;color:#666;min-height:32px}
.cardx .price{font-weight:800;color:#d32f2f}
.cardx .row-meta{display:flex;justify-content:space-between;align-items:center}
.type-badge{background:#eef6ff;color:#0b4db3;border-radius:999px;font-size:11px;font-weight:700;padding:4px 10px}
.add-btn{border:none;background:var(--main);color:#fff;border-radius:50%;width:32px;height:32px;font-size:18px;display:flex;align-items:center;justify-content:center}

/* Pagination row spacing */
#productGrid{margin-top:8px}
</style>
</head>
<body>
  <div class="top-banner">∆Øu ƒë√£i th√°ng n√†y cho kh√°ch ƒë·∫∑t qua 2606ai.vn</div>

  <div class="site-header">
    <div class="d-flex align-items-center gap-2">
      <img src="https://raw.githubusercontent.com/datnguyenIT/2606ai-assets/main/logo.png" class="logo" alt="2606AI logo">
      <span class="brand-title">2606AI Marketplace</span>
    </div>
    <div class="d-flex gap-2">
      <button class="btn btn-outline-secondary" data-bs-toggle="offcanvas" data-bs-target="#filterPanel">‚öôÔ∏è B·ªô l·ªçc</button>
      <button class="btn btn-outline-dark">üõí Gi·ªè h√†ng <span id="cartCount">0</span></button>
    </div>
  </div>

  <div class="container-fluid my-3">
    <div class="row g-3">
      <!-- Sidebar -->
      <div class="col-lg-3 col-md-4">
        <div class="sidebar-box">
          <h6 class="fw-bold">Quy·ªÅn l·ª£i</h6>
          <ul class="small mb-0">
            <li>‚ö° B√°o gi√° nhanh 24h</li>
            <li>üé® Thi·∫øt k·∫ø mi·ªÖn ph√≠</li>
            <li>‚úÖ QC 2 l·ªõp</li>
            <li>üöö Giao h√†ng to√†n qu·ªëc</li>
          </ul>
        </div>
        <div class="sidebar-box">
          <h6 class="fw-bold mb-2">X∆∞·ªüng ƒë·ªÅ xu·∫•t</h6>
          <div id="factoryList"></div>
        </div>
      </div>

      <!-- Main -->
      <div class="col-lg-9 col-md-8">
        <!-- Hero -->
        <div class="hero mb-2">
          <div id="heroCarousel" class="carousel slide" data-bs-ride="carousel">
            <div class="carousel-inner">
              <div class="carousel-item active"><img src="https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?q=80&w=1600&auto=format&fit=crop" class="d-block w-100" alt=""></div>
              <div class="carousel-item"><img src="https://images.unsplash.com/photo-1500534314209-a25ddb2bd429?q=80&w=1600&auto=format&fit=crop" class="d-block w-100" alt=""></div>
              <div class="carousel-item"><img src="https://images.unsplash.com/photo-1500534314210-59e391f8d1d0?q=80&w=1600&auto=format&fit=crop" class="d-block w-100" alt=""></div>
            </div>
            <button class="carousel-control-prev" type="button" data-bs-target="#heroCarousel" data-bs-slide="prev"><span class="carousel-control-prev-icon"></span></button>
            <button class="carousel-control-next" type="button" data-bs-target="#heroCarousel" data-bs-slide="next"><span class="carousel-control-next-icon"></span></button>
          </div>
        </div>

        <!-- Categories line (pills) -->
        <div class="p-2 bg-white rounded-3 mb-2">
          <h6 class="fw-bold mb-2">DANH M·ª§C S·∫¢N PH·∫®M</h6>
          <div class="d-flex flex-wrap gap-2" id="categoryPills">
            <!-- pills render here -->
          </div>
        </div>

        <!-- Search -->
        <div class="input-group mb-2">
          <span class="input-group-text bg-primary text-white">üîç</span>
          <input id="searchBox" class="form-control" placeholder="T√¨m s·∫£n ph·∫©m... (id, details)">
          <button id="searchBtn" class="btn btn-primary">T√¨m</button>
        </div>

        <!-- Product grid -->
        <div id="productGrid" class="row row-cols-2 row-cols-md-3 row-cols-lg-6 g-2"></div>

        <!-- Pagination -->
        <div class="d-flex justify-content-between align-items-center mt-2">
          <button id="prevBtn" class="btn btn-outline-secondary">‚Üê Tr∆∞·ªõc</button>
          <small class="text-muted" id="pageInfo"></small>
          <button id="nextBtn" class="btn btn-outline-secondary">Sau ‚Üí</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Offcanvas Filter (ƒë·ªÉ nguy√™n, ch∆∞a b·∫≠t filter n√¢ng cao) -->
  <div class="offcanvas offcanvas-end" tabindex="-1" id="filterPanel">
    <div class="offcanvas-header">
      <h5>B·ªô l·ªçc n√¢ng cao</h5>
      <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body">
      <p class="text-muted">(T√πy ch·ªçn n√†y m√¨nh gi·ªØ nguy√™n, ch∆∞a b·∫≠t th√™m ƒëi·ªÅu ki·ªán ƒë·ªÉ kh√¥ng thay ƒë·ªïi UI c≈©)</p>
    </div>
  </div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
/* ================== CONFIG ================== */
// üîÅ Thay API_URL b·∫±ng link Apps Script c·ªßa b·∫°n
const API_URL = "https://script.google.com/macros/s/AKfycbyKMYfPDJ4KGnogh6onTqz_rqcKcR-VRFcQpvQc4nLnZ8DnAL3-2zA0EtCZSpn0QFHJ/exec";

// State
const state = { page:1, pageSize:24, q:"", category:"" };

// Cache s·∫£n ph·∫©m theo id
const products = {};
const cart = [];

/* =============== Helpers =============== */
const VND = n => (Number(n)||0).toLocaleString('vi-VN')+' ƒë';
const esc = s => (s??'').toString().replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
const badgeColor = t => t?.toLowerCase().includes('g·∫•p') ? '#e53935'
                    : t?.toLowerCase().includes('gi·∫£m') ? '#ff9800'
                    : t?.toLowerCase().includes('m·∫´u') ? '#4caf50'
                    : '#0b57d0';
const NOIMG = 'data:image/svg+xml;utf8,'+encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="600" height="400"><rect width="100%" height="100%" fill="#eef2f7"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-family="Arial" font-size="22" fill="#9aa6b2">No Image</text></svg>`);

/* =============== Renderers =============== */
function productCard(it){
  products[it.id]=it;
  const img = it.bigImg || it.img || '';
  const thumb = img ? esc(img) : NOIMG;
  const full = it.linkFull || it.full || img || '#';
  const note = it.note || it.chuy || '';
  return `
  <div class="col">
    <div class="cardx h-100">
      ${note?`<span class="note-badge" style="background:${badgeColor(note)}">${esc(note)}</span>`:''}
      <a href="${esc(full)}" target="_blank" rel="noopener">
        <img class="thumb" src="${thumb}" onerror="this.src='${NOIMG}'">
      </a>
      <div class="meta">
        <div class="id">${esc(it.id)}</div>
        <div class="details">${esc(it.details||'')}</div>
        <div class="price">${VND(it.price)}</div>
        <div class="row-meta">
          <span class="type-badge">${esc(it.type||'')}</span>
          <button class="add-btn" onclick="addToCartById('${esc(it.id)}')">+</button>
        </div>
      </div>
    </div>
  </div>`;
}

function render(res){
  // L·∫•y m·∫£ng items
  let items = res.items || [];

  // N·∫øu backend ch∆∞a l·ªçc theo category -> client l·ªçc
  if(state.category){
    items = items.filter(x => (x.category||'').toString().trim().toLowerCase() === state.category.toLowerCase());
  }

  // Render grid
  const grid = document.getElementById('productGrid');
  grid.innerHTML = items.length ? items.map(productCard).join('') :
    `<div class="col-12 text-center text-muted py-4">Kh√¥ng c√≥ s·∫£n ph·∫©m.</div>`;

  // Render danh m·ª•c pills (∆∞u ti√™n facets.categories, fallback l·∫•y t·ª´ items)
  const pills = document.getElementById('categoryPills');
  const apiCats = (res.facets && (res.facets.categories || res.facets.dongs || res.facets.groups)) || [];
  const pageCats = [...new Set(items.map(x=>(x.category || x.dong || x.group || '').toString().trim()).filter(Boolean))];
  const categories = apiCats.length ? apiCats : pageCats;

  let html = `<div class="cat-pill ${state.category===''?'active':''}" onclick="selectCategory('')">
                <span class="cat-icon">‚Ä¢</span> T·∫•t c·∫£
              </div>`;
  categories.forEach(c=>{
    html += `<div class="cat-pill ${state.category===c?'active':''}" onclick="selectCategory('${esc(c)}')">
              <span class="cat-icon">#</span> ${esc(c)}
            </div>`;
  });
  pills.innerHTML = html;

  // Page info
  const pageInfo = document.getElementById('pageInfo');
  pageInfo.textContent = `Trang ${res.page||state.page} / ${Math.max(1, Math.ceil((res.total||0)/(res.pageSize||state.pageSize)))}`;
}

/* =============== Fetch =============== */
async function fetchPage(){
  const params = new URLSearchParams({
    action:'list',
    page:state.page,
    pageSize:state.pageSize,
    q:state.q,
    category:state.category    // n·∫øu backend c√≥ h·ªó tr·ª£
  });
  try{
    const r = await fetch(API_URL+'?'+params.toString(), {cache:'no-store'});
    const json = await r.json();
    render(json);
  }catch(e){
    console.error(e);
    document.getElementById('productGrid').innerHTML =
      `<div class="col-12 text-center text-danger py-4">Kh√¥ng t·∫£i ƒë∆∞·ª£c d·ªØ li·ªáu. Ki·ªÉm tra API_URL.</div>`;
  }
}

/* =============== Actions =============== */
function selectCategory(cat){
  state.category = cat;
  state.page = 1;
  fetchPage();
}

document.getElementById('searchBtn').onclick = ()=>{
  state.q = document.getElementById('searchBox').value.trim();
  state.page = 1; fetchPage();
};
document.getElementById('prevBtn').onclick = ()=>{ if(state.page>1){ state.page--; fetchPage(); } };
document.getElementById('nextBtn').onclick = ()=>{ state.page++; fetchPage(); };

/* =============== Cart mock =============== */
function addToCartById(id){
  const it = products[id];
  if(!it) return;
  const found = cart.find(x=>x.id===id);
  if(found) found.qty++;
  else cart.push({id,details:it.details,price:it.price,qty:1});
  document.getElementById('cartCount').textContent = cart.reduce((a,b)=>a+b.qty,0);
}

/* =============== Init =============== */
document.addEventListener('DOMContentLoaded', ()=>{
  // demo factories
  const factories = [
    {name:'X∆∞·ªüng 1 ‚Äì Tem kim lo·∫°i',desc:'Men m√†u, m·∫° v√†ng, ƒë√∫c n·ªïi 3D',img:'https://picsum.photos/80?1'},
    {name:'X∆∞·ªüng 2 ‚Äì In UV',desc:'Chi ti·∫øt s·∫Øc n√©t, ƒë·ªô b·ªÅn cao',img:'https://picsum.photos/80?2'},
    {name:'X∆∞·ªüng 3 ‚Äì ƒê√∫c huy hi·ªáu',desc:'ƒê√∫c n·ªïi 3D, m·∫° cao c·∫•p',img:'https://picsum.photos/80?3'},
    {name:'X∆∞·ªüng 4 ‚Äì In offset',desc:'Bao b√¨, h·ªôp, catalogue',img:'https://picsum.photos/80?4'},
  ];
  document.getElementById('factoryList').innerHTML = factories.map(f=>`
    <div class="d-flex align-items-center gap-2 mb-2">
      <img src="${f.img}" width="40" height="40" style="object-fit:cover;border-radius:8px;border:1px solid #eee">
      <div><div class="fw-bold small">${esc(f.name)}</div><div class="text-muted small">${esc(f.desc)}</div></div>
    </div>`).join('');

  fetchPage();
});
</script>
</body>
</html>
