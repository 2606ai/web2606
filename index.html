<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>2606AI — Sửa lỗi & Tối ưu 13.09.2025</title>

  <!-- Bootstrap & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet" />

  <style>

    #adsBox {
  display: block !important;
  visibility: visible !important;
  opacity: 1 !important;
  height: auto !important;
  max-height: none !important;
}

    /* FIX HIỂN THỊ XƯỞNG ĐỀ XUẤT */
#adsBox{ display:block !important; visibility:visible !important; }
#adsList{ display:flex !important; flex-direction:column; gap:8px; min-height:120px; }
#adsList .link-preview{
  display:flex !important; gap:10px;
  background:#fff; border:1px solid #e3f2fd; border-radius:10px; padding:10px;
  box-shadow:0 1px 2px rgba(0,0,0,.06); text-decoration:none;
}
#adsList .thumb{ width:64px; height:64px; border-radius:8px; object-fit:cover; background:#f1f4ff; }
#adsBox .small.text-muted{ display:block; }

  /* ==========================================================================
     2606AI — CLEANED & FIXED BASE
     Ghi chú:
     - Hợp nhất, loại bỏ rule trùng/đè nhau gây nhấp nháy.
     - Chuẩn hoá theme token.
     - Không thay đổi layout tổng thể, chỉ sửa xung đột & bug CSS rõ ràng.
     ========================================================================== */

  :root{
    --main:        #e91e63;     /* hồng chủ đạo */
    --main-600:    #d81b60;
    --main-700:    #c2185b;
    --main-grad:   linear-gradient(90deg,#ff5aa7 0%, #ff8bd1 100%);

    --accent:      #d4af37;
    --bg:          #f5f6fa;

    --text:        #1f2937;
    --muted:       #6b7280;

    --card:        #ffffff;
    --border:      #e7ecf7;

    --shadow-sm:   0 1px 2px rgba(0,0,0,.06);
    --shadow-md:   0 2px 8px rgba(0,0,0,.08);
    --shadow-lg:   0 6px 16px rgba(0,0,0,.16);

    --main-tint:   #ffe3f0;
    --main-shadow: rgba(233,30,99,.22);
  }

  /* ===== BODY / GLOBAL ===== */
  html,body{height:100%}
  body{
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    font-size:14px;
    color:var(--text);
    background:var(--bg);
    padding-top:70px;
  }
  img{max-width:100%;display:block}
  .container-fluid,.wrap{max-width:1400px;margin:0 auto}

  /* ===== HEADER ===== */
  .site-header{
    position:fixed; inset:0 0 auto 0; z-index:1055;
    background:#fff; border-bottom:1px solid #eee;
    box-shadow:var(--shadow-sm);
    padding:10px 15px;
  }
  .site-header .wrap{display:flex;align-items:center;gap:12px}
  .site-header img.logo{width:84px;aspect-ratio:3/2;object-fit:contain;cursor:pointer}
  .header-search{flex:1}
  .header-search .form-control{font-size:13px;padding:6px 10px}
  @media (max-width:992px){
    .site-header img.logo{width:72px}
  }

  /* ===== TOP BANNER ===== */
  .top-banner{
    position:sticky; top:70px; z-index:1054;
    height:32px; display:flex; align-items:center; justify-content:center;
    background:var(--main-grad); color:#fff; font-weight:700; line-height:32px;
    overflow:hidden
  }
  .top-banner .marquee{
    white-space:nowrap; display:inline-block;
    animation:marquee 60s linear infinite
  }
  @keyframes marquee{0%{transform:translateX(100%)}100%{transform:translateX(-100%)}}

  /* ===== SIDEBAR CARD ===== */
  .sidebar-box{
    background:var(--card); border:1px solid var(--border);
    border-radius:12px; padding:12px; box-shadow:var(--shadow-sm); margin-bottom:15px
  }
  .sidebar-box h6{font-weight:700;font-size:15px;margin-bottom:8px}

  /* ===== BENEFITS ===== */
  .benefits-v3 .grid{display:grid;grid-template-columns:1fr;gap:8px}
  .benefits-v3 .bcard{
    background:#fff;border:1px solid #eef2ff;border-radius:12px;padding:12px;
    display:flex;gap:10px;align-items:center;min-height:60px;position:relative;box-shadow:var(--shadow-sm)
  }
  .benefits-v3 .ic{width:36px;height:36px;border-radius:8px;background:#f1f4ff;display:inline-flex;align-items:center;justify-content:center}
  .benefits-v3 .ttl{font-weight:700;font-size:12px;line-height:1.3}
  .benefits-v3 .sub{font-size:12px;color:var(--muted)}
  .benefit-note{position:absolute;top:6px;right:8px;font-size:11px;font-weight:700;padding:2px 6px;border-radius:999px;color:#fff}
  .benefit-free{background:#4caf50}
  .benefit-paid{background:#d32f2f}

  /* ===== HERO BANNERS ===== */
  .hero{margin-bottom:15px}
  .hero .carousel{border-radius:12px;overflow:hidden;box-shadow:var(--shadow-sm)}
  .hero .mini img{height:145px;object-fit:cover;border-radius:12px}
  .hero .main img{height:300px;object-fit:cover;border-radius:12px}
  .hero .carousel .carousel-indicators [data-bs-target]{width:8px;height:8px;border-radius:50%}

  /* ===== GROUP BAR (chips) + DOTS ===== */
  .group-bar-wrapper{
    background:#fff;border:1px solid var(--border);border-radius:12px;
    padding:10px 12px; box-shadow:var(--shadow-sm); margin-bottom:6px; position:relative;
  }
  .group-bar-scroll{
    display:flex; gap:10px; overflow-x:auto; scrollbar-width:none; align-items:center;
  }
  .group-bar-scroll::-webkit-scrollbar{display:none}
  .group-chip{
    display:flex; flex-direction:column; align-items:center; justify-content:center;
    gap:8px; min-width:120px; padding:12px 10px;
    background:#fff; border:1px solid #eef2ff; border-radius:16px;
    box-shadow:0 1px 2px rgba(0,0,0,.04);
    color:#111827; font-weight:600; font-size:13px;
    text-align:center; white-space:normal; line-height:1.25; cursor:pointer;
    transition:transform .12s, box-shadow .12s, background .12s, border-color .12s, color .12s;
  }
  .group-chip:hover{ transform:translateY(-1px); box-shadow:0 4px 14px rgba(0,0,0,.10); background:var(--main-tint); color:var(--main-700); }
  .group-chip.active{
    border-color:#c7d2fe; background:#f8faff;
    box-shadow:0 6px 20px var(--main-shadow); color:var(--main-700);
  }
  .chip-icon{ width:56px; height:56px; border-radius:16px; display:flex; align-items:center; justify-content:center; background:linear-gradient(180deg,#f5f7ff 0%, #edf1ff 100%); box-shadow:inset 0 1px 0 rgba(255,255,255,.7); overflow:hidden; }
  .chip-icon img{ width:34px; height:34px; object-fit:contain; }

  .group-dots{display:flex;justify-content:center;gap:6px;margin:6px 0 10px}
  .group-dots .dot{width:6px;height:6px;border-radius:50%;background:#c9d6ff;transition:transform .15s, background .15s}
  .group-dots .dot.active{background:var(--main);transform:scale(1.25)}

  /* ===== CATEGORY SCROLLER ===== */
  .category-box{background:#fff;border-radius:12px;padding:10px;box-shadow:var(--shadow-sm);border:1px solid var(--border)}
  .category-wrapper{position:relative}
  .category-scroll{
    display:grid;
    grid-template-columns:repeat(6,1fr);
    grid-template-rows:repeat(2,auto);
    gap:12px; overflow:hidden
  }
  .category-item{
    text-align:center;padding:8px;border-radius:12px;cursor:pointer;transition:.15s;border:1px solid transparent;background:transparent;
  }
  .category-item:hover{background:#f7f9ff}
  .category-item.active{background:#e8f1ff;border-color:#a7c4ff}
  .category-item .icon { width:100%; height:100px; border-radius:12px; background:#f2f6ff; overflow:hidden; display:block; box-shadow:0 4px 10px rgba(0,0,0,.06); }
  .category-item .icon img { width:100%; height:100%; object-fit:contain; display:block; }
  .category-item .label{ font-size:12px; display:block; margin-top:6px; font-weight:700; color:#111; line-height:1.25; }

  .cat-arrow{
    position:absolute; top:45%; transform:translateY(-50%);
    background:#fff; border:none; font-size:22px; color:var(--main-700); cursor:pointer; z-index:2;
    width:44px;height:44px;border-radius:50%;box-shadow:0 2px 6px rgba(0,0,0,.15);
  }
  .cat-arrow.left{left:-6px} .cat-arrow.right{right:-6px}
  .cat-arrow.is-disabled,.cat-arrow:disabled{ opacity:.45; pointer-events:none; }

  @media (max-width:1200px){ .category-scroll{grid-template-columns:repeat(5,1fr)} }
  @media (max-width:992px){  .category-scroll{grid-template-columns:repeat(4,1fr)} }
  @media (max-width:768px){  .category-scroll{grid-template-columns:repeat(3,1fr)} }
  @media (max-width:576px){  .category-scroll{grid-template-columns:repeat(2,1fr)} }

  /* ===== STATS / PAGER ===== */
  #statsBar{
    background:#fff;border:1px solid var(--border);border-radius:10px;
    padding:8px 12px; box-shadow:var(--shadow-sm)
  }
  .stats-row{ display:flex; align-items:center; justify-content:space-between; gap:8px; flex-wrap:nowrap; overflow-x:auto; margin-bottom:8px; }
  .found-count{ display:inline-flex; align-items:center; gap:6px; font-weight:500; }
  .pager-bar .btn{min-width:40px}
  #pagerTop{ margin-left:auto; white-space:nowrap; display:flex; align-items:center; gap:4px; }
  #pagerTop .btn, #pagerBottom .btn{
    padding:.35rem .6rem; font-size:.875rem; line-height:1.2; border-radius:.25rem; min-width:40px; height:32px;
  }
  #pagerTop .form-select, #pagerBottom .form-select{ min-width:110px; }
  @media (max-width:576px){
    .found-count{ flex:0 1 auto; }
    #pagerTop   { flex:0 1 auto; }
  }

  /* ===== PRODUCT CARD ===== */
  .cardx{
    border:none;border-radius:12px;background:#fff;overflow:hidden;
    box-shadow:var(--shadow-sm);transition:transform .1s ease, box-shadow .1s ease;height:100%;display:flex;flex-direction:column
  }
  .cardx:hover{transform:translateY(-2px);box-shadow:var(--shadow-md)}
  .cardx .thumb-wrap{position:relative;background:#fff}
  .cardx img.thumb{width:100%;height:180px;object-fit:cover}
  .cardx .note-chip{
    position:absolute;top:8px;right:8px;padding:2px 6px;border-radius:999px;font-size:10px;font-weight:400;color:#fff;background:#555
  }
  .cardx .meta{padding:10px;display:flex;flex-direction:column;gap:6px;flex:1;}
  .cardx .id{font-weight:700;color:var(--main);font-size:13px;line-height:1.2;min-height:1.2em}
  .cardx .details{
    display:-webkit-box;-webkit-box-orient: vertical;-webkit-line-clamp: 2; overflow:hidden;
    min-height:2.4em; font-size:12px; color:#666;
  }
  .cardx .type-badge{display:inline-block;background:#e7f3ff;color:#0056b3;font-size:11px;font-weight:700;padding:2px 6px;border-radius:12px;align-self:flex-start;max-width:100%;white-space:nowrap;text-overflow:ellipsis;overflow:hidden;margin-bottom:2px}
  .cardx .price{font-weight:600;color:#d32f2f;font-size:1rem;margin:0;line-height:1.2;margin-top:auto}
  .cardx .meta-actions{display:flex;align-items:center;justify-content:space-between;gap:8px;margin-top:6px}
  .btn-gift{
    background:#fff !important;color:var(--main) !important;border:1.5px solid var(--main) !important;border-radius:999px;
    font-weight:600;padding:6px 14px;display:inline-flex;align-items:center;justify-content:center;text-decoration:none;max-width:72%;white-space:nowrap;overflow:hidden;text-overflow:ellipsis
  }
  .btn-gift:hover{background:var(--main) !important;color:#fff !important;border-color:var(--main) !important}
  .add-btn{
    border:none;background:var(--main) !important;color:#fff !important;border-radius:50%;
    width:32px;height:32px;font-size:18px;font-weight:800;display:flex;align-items:center;justify-content:center
  }
  .add-btn:hover{ background:var(--main-600) !important; }

  /* ===== ADS (sidebar) ===== */
  .ads-box{
    background:linear-gradient(180deg,#e3f2fd 0%,#bbdefb 100%);
    border:1px solid #90caf9;border-radius:12px;padding:12px
  }
  #adsList{max-height:62vh;overflow:auto;padding-right:4px;scroll-behavior:smooth}
  #adsList .link-preview{
    display:flex;gap:10px;background:#fff;border:1px solid #e3f2fd;border-radius:10px;padding:10px;box-shadow:var(--shadow-sm); text-decoration:none;
  }
  #adsList .link-preview .thumb{ width:64px;height:64px;border-radius:8px;object-fit:cover;background:#f1f4ff; }
  #adsList .title{font-weight:700;color:var(--main)}
  #adsList .desc{font-size:12px;color:var(--muted)}
  #adsList .site{font-size:12px;color:var(--main)}

  /* ===== SUPPLIERS ===== */
  .offcanvas{z-index:4000}
  .offcanvas-backdrop{z-index:3990}
  .sup-toolbar{
    position:sticky; top:0; z-index:2; background:#fff; margin:-12px -12px 12px; padding:12px;
    border-bottom:1px solid var(--border); border-radius:12px 12px 0 0
  }
  .sup-toolbar .counter{font-size:12px;color:var(--muted);display:flex;align-items:center;gap:8px}
  .sup-toolbar .pill{background:#eef3ff;color:var(--main);border:1px solid #dbe3ff;padding:2px 8px;border-radius:999px;font-weight:700;font-size:12px}
  .supplier-list{max-height:62vh;overflow:auto;padding-right:4px}
  .supplier-card{
    border:1px solid var(--border);border-radius:12px;padding:10px;background:#fff;
    box-shadow:var(--shadow-sm)
  }
  .supplier-card .title{font-weight:700;font-size:14px}
  .supplier-card .meta{font-size:12px;color:var(--muted)}
  .supplier-card .chips{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
  .supplier-card .chip{font-size:11px;padding:2px 8px;border-radius:999px;background:#f6f7fb;border:1px solid #e5e9ff;color:#475569}
  .supplier-card .chip.ok{background:#e8f7ee;border-color:#c7ead5;color:#256c3b}
  .supplier-card .supplier-doc{ margin-top:8px; font-size:12px; }
  .supplier-card .doc-input{ max-width:260px; }
  .supplier-card .doc-preview{ font-size:11px; color:#666; font-style:italic; }
  .chip.muted { color:#6b7280; background:#f3f4f6; }
  .chip.btn-upload-doc { cursor:pointer; }

  /* ===== CART PANEL ===== */
  #cartCanvas .offcanvas-header{
    background:var(--main-grad); color:#fff; border:0; border-radius:12px 12px 0 0
  }
  #cartCanvas .offcanvas-body{font-size:13px;padding:16px}
  #cartCanvas input.form-control,#cartCanvas textarea.form-control,#cartCanvas select.form-select{
    border-radius:10px;font-size:13px;border:1px solid #dbe3ff
  }
  #cartCanvas input:focus,#cartCanvas textarea:focus,#cartCanvas select:focus{
    border-color:var(--main); box-shadow:0 0 0 0.2rem rgba(233,30,99,0.15)
  }
  #cartCanvas .btn{border-radius:999px;font-weight:600;font-size:13px}
  #cartCanvas #clearCartBtn{background:#fbe9e7;color:#d32f2f;border:1px solid #ffcdd2}
  #cartCanvas #clearCartBtn:hover{background:#ffcdd2}
  #cartCanvas #submitOrderBtn{background:#2e7d32;border:none}
  #cartCanvas #submitOrderBtn:hover{background:#1b5e20}
  #cartCanvas .alert{border-radius:10px;font-size:12px;background:#f4f6fd;color:#333;border:1px solid #dbe3ff}
  #cartCanvas .summary-box{background:#fff8e1;border:1px solid #ffe082;border-radius:10px;padding:8px 12px;margin-bottom:12px}
  #cartCanvas #cartTotal{font-weight:700;font-size:16px;color:#d32f2f}

  /* ===== FABs ===== */
  .cart-fab,.filter-fab,.suppliers-fab,.zalo-fab{
    position:fixed; right:16px; width:54px; height:54px; border:none; border-radius:50%;
    color:#fff; font-size:22px; line-height:54px; box-shadow:0 6px 16px rgba(0,0,0,.25);
    z-index:2500; cursor:pointer; display:flex; align-items:center; justify-content:center
  }
  .filter-fab{background:#6c757d;bottom:212px}
  .cart-fab{background:var(--main-grad);bottom:148px}
  .suppliers-fab{background:#0d6efd;bottom:84px}
  .zalo-fab{background:#25D366;bottom:20px}
  .fab-badge{position:absolute;top:-6px;right:-6px;background:#d32f2f;color:#fff;border-radius:999px;padding:2px 6px;font-size:12px;font-weight:700;display:none}

  /* ===== FOOTER ===== */
  footer.text-light{
    background: var(--main-grad);
    color:#fff;
  }
  footer.text-light h6{ color: var(--accent); }
  footer.text-light hr{ border-color: rgba(255,255,255,.4); }
  footer.text-light a, footer.text-light .bi{ color:#fff; }

  /* ===== ERROR TOAST ===== */
  #errbox{
    position:fixed;left:8px;right:8px;bottom:8px;z-index:3000;
    background:#ffefef;border:1px solid #e99;border-radius:8px;padding:8px;
    display:none;white-space:pre-wrap;font-family:ui-monospace,Consolas,monospace
  }
#adsBox{ display:block !important; visibility:visible !important; }
#adsList .link-preview{ text-decoration:none; }

#adsBox {
  display: block !important;
  visibility: visible !important;
}


    
  </style>
</head>
<body class="theme-bamboo">

  <!-- =========================================================
       HEADER
       ========================================================= -->
  <header class="site-header">
    <div class="wrap">
      <a id="logoLink" href="#" class="d-flex align-items-center text-decoration-none">
        <img src="https://drive.google.com/thumbnail?id=1e9N6rgsTP5vYtKl4Lwq801dfteYLbx_F&sz=w160" class="logo" alt="2606AI logo">
      </a>
      <form id="filter-form" class="header-search d-flex gap-2 m-0" onsubmit="return false;">
        <div class="input-group w-100">
          <input id="searchBox" class="form-control" placeholder="Tìm sản phẩm... (ID, mô tả)" aria-label="Tìm sản phẩm">
          <button id="searchBtn" class="btn btn-primary" type="button">Tìm</button>
        </div>
      </form>
    </div>
  </header>

  <!-- =========================================================
       MARQUEE
       ========================================================= -->
  <div class="top-banner" role="region" aria-label="Thông báo">
    <div class="wrap">
      <div class="marquee">
        Để đảm bảo quyền lợi hãy thông báo với 2606AI.VN khi bạn đã chốt đơn hàng &nbsp; • &nbsp;
        Nguồn thu của 2606AI.VN đến từ quảng cáo &nbsp; • &nbsp;
        Có sự hỗ trợ của 2606AI.VN tự tin sản xuất mọi sản phẩm
      </div>
    </div>
  </div>

  <!-- =========================================================
       MAIN
       ========================================================= -->
  <div class="container-fluid my-3">
    <div class="row g-3">

      <!-- ================== SIDEBAR ================== -->
      <aside id="leftCol" class="col-lg-3 col-md-4">

        <!-- Benefits -->
        <div class="sidebar-box benefits-v3">
          <h6 class="mb-2">Chúng tôi có gì cho bạn...</h6>
          <div class="grid">
            <div class="bcard" data-benefit="b1" role="button" tabindex="0" aria-label="Tham khảo 10,000+ mẫu sản phẩm">
              <span class="benefit-note benefit-free">Miễn phí</span>
              <div class="ic">🧩</div>
              <div class="ttl">1. Tham khảo 10,000+ mẫu sản phẩm</div>
              <div class="sub">Không lo thiếu ý tưởng</div>
            </div>
            <div class="bcard" data-benefit="b2" role="button" tabindex="0" aria-label="500+ nhà cung cấp và xưởng sản xuất">
              <span class="benefit-note benefit-free">Miễn phí</span>
              <div class="ic">🏭</div>
              <div class="ttl">2. Hơn 500+ nhà cung cấp và xưởng sản xuất</div>
              <div class="sub">Báo giá nhanh, đa dạng, dễ dàng so sánh giá</div>
            </div>
            <div class="bcard" data-benefit="b3" role="button" tabindex="0" aria-label="Hỗ trợ tư vấn sản xuất">
              <span class="benefit-note benefit-free">Miễn phí</span>
              <div class="ic">💬</div>
              <div class="ttl">3. Hỗ trợ tư vấn sản xuất</div>
              <div class="sub">Phản hồi nhanh, đáp ứng nhiều nhu cầu</div>
            </div>
            <div class="bcard" data-benefit="b4" role="button" tabindex="0" aria-label="Hỗ trợ thiết kế 2D, 3D sản xuất">
              <span class="benefit-note benefit-free">Miễn phí</span>
              <div class="ic">🎨</div>
              <div class="ttl">4. Hỗ trợ thiết kế 2D, 3D sản xuất</div>
              <div class="sub">Mockup miễn phí cho các đơn hàng chốt</div>
            </div>
            <div class="bcard" data-benefit="b5" role="button" tabindex="0" aria-label="Hậu cần vận chuyển và đóng gói hàng">
              <span class="benefit-note benefit-paid">Có phí</span>
              <div class="ic">📦</div>
              <div class="ttl">5. Hậu cần vận chuyển và đóng gói hàng</div>
              <div class="sub">Dịch vụ nhanh chuyên nghiệp</div>
            </div>
            <div class="bcard" data-benefit="b6" role="button" tabindex="0" aria-label="Hỗ trợ giải quyết tranh chấp">
              <span class="benefit-note benefit-paid">Có phí</span>
              <div class="ic">🛡️</div>
              <div class="ttl">6. Hỗ trợ giải quyết tranh chấp</div>
              <div class="sub">Bảo vệ quyền lợi khách hàng</div>
            </div>
          </div>
        </div>
        <!-- /Benefits -->

        <!-- Xưởng đề xuất -->
        <div id="adsBox" class="sidebar-box ads-box">
          <h6 class="fw-bold mb-2 d-flex align-items-center justify-content-between">
            <span class="d-inline-flex align-items-center gap-2">
              Xưởng đề xuất
              <span id="adsCount" class="badge rounded-pill text-bg-primary" style="display:none">0</span>
            </span>
          </h6>

          <div id="adsList" class="d-flex flex-column gap-2"></div>
          <div id="adsEmpty" class="small text-muted">(debug) Box đã hiển thị – chờ dữ liệu quảng cáo.</div>

          <div class="mt-2 text-center">
            <a id="adsContactBtn2" href="#" target="_blank" rel="noopener"
               class="btn btn-sm fw-bold px-3"
               style="border-radius:999px;background:#ffca28;color:#0d47a1;border:none">
              📢 LIÊN HỆ ĐẶT QUẢNG CÁO
            </a>
          </div>
        </div>
        <!-- /Xưởng đề xuất -->

      </aside>

      <!-- ================== CONTENT ================== -->
      <section class="col-lg-9 col-md-8">
        <!-- HERO -->
        <div class="hero row g-2">
          <div class="col-md-8 main">
            <div id="heroMain" class="carousel slide" data-bs-ride="carousel" data-bs-interval="4000">
              <div class="carousel-inner">
                <div class="carousel-item active"><img loading="lazy" class="d-block w-100" src="https://picsum.photos/1200/300?random=11" alt="Banner 1"></div>
                <div class="carousel-item"><img loading="lazy" class="d-block w-100" src="https://picsum.photos/1200/300?random=12" alt="Banner 2"></div>
                <div class="carousel-item"><img loading="lazy" class="d-block w-100" src="https://picsum.photos/1200/300?random=13" alt="Banner 3"></div>
              </div>
              <button class="carousel-control-prev" type="button" data-bs-target="#heroMain" data-bs-slide="prev"><span class="carousel-control-prev-icon"></span></button>
              <button class="carousel-control-next" type="button" data-bs-target="#heroMain" data-bs-slide="next"><span class="carousel-control-next-icon"></span></button>
            </div>
          </div>
          <div class="col-md-4 d-flex flex-column gap-2 mini">
            <div id="heroRight1" class="carousel slide" data-bs-ride="carousel" data-bs-interval="3500">
              <div class="carousel-inner">
                <div class="carousel-item active"><img loading="lazy" src="https://picsum.photos/600/145?random=21" class="d-block w-100" alt="Promo 1"></div>
                <div class="carousel-item"><img loading="lazy" src="https://picsum.photos/600/145?random=22" class="d-block w-100" alt="Promo 2"></div>
              </div>
            </div>
            <div id="heroRight2" class="carousel slide" data-bs-ride="carousel" data-bs-interval="4200">
              <div class="carousel-inner">
                <div class="carousel-item active"><img loading="lazy" src="https://picsum.photos/600/145?random=23" class="d-block w-100" alt="Promo 3"></div>
                <div class="carousel-item"><img loading="lazy" src="https://picsum.photos/600/145?random=24" class="d-block w-100" alt="Promo 4"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- CATEGORY (Group chips + Category scroller) -->
        <div class="category-box mb-3">
          <!-- Dots indicator -->
          <div id="groupDots" class="group-dots" aria-label="Vị trí trang nhóm"></div>

          <!-- GROUP BAR -->
          <div class="group-bar-wrapper">
            <button class="group-arrow left" id="groupPrev" type="button" aria-label="prev">‹</button>
            <div class="group-bar-scroll" id="groupBar" role="tablist" aria-label="Nhóm sản phẩm"></div>
            <button class="group-arrow right" id="groupNext" type="button" aria-label="next">›</button>
          </div>

          <!-- CATEGORY GRID -->
          <div class="category-wrapper">
            <button id="catPrev" class="cat-arrow left"  type="button" aria-label="prev">‹</button>
            <div id="categoryScroll" class="category-scroll" role="grid" aria-label="Danh mục"></div>
            <button id="catNext" class="cat-arrow right" type="button" aria-label="next">›</button>
          </div>
        </div>

        <!-- STATS + PAGER -->
        <div class="stats-row row g-2 align-items-center">
          <div class="col-auto d-flex align-items-center found-count">
            <span class="lbl">Tìm thấy</span>
            <span id="totalCount" class="badge text-bg-primary">0</span>
            <button id="clearFiltersBtn2" class="btn btn-sm btn-outline-danger ms-2">Xóa bộ lọc</button>
          </div>
          <div class="col text-end">
            <div id="pagerTop" class="d-inline-flex"></div>
          </div>
        </div>

        <!-- GRID -->
        <div id="productGrid" class="row row-cols-2 row-cols-md-3 row-cols-lg-6 g-2" aria-live="polite"></div>

        <!-- PAGER BOTTOM -->
        <div id="pagerBottom" class="mt-3 pager-bar"></div>

        <!-- FOOTER ADS -->
        <div class="hero-ads my-3">
          <div id="footerAds" class="carousel slide" data-bs-ride="carousel" data-bs-interval="4000">
            <div class="carousel-inner">
              <div class="carousel-item active">
                <img loading="lazy" src="https://picsum.photos/1200/200?random=91" class="d-block w-100" alt="Quảng cáo 1">
              </div>
              <div class="carousel-item">
                <img loading="lazy" src="https://picsum.photos/1200/200?random=92" class="d-block w-100" alt="Quảng cáo 2">
              </div>
              <div class="carousel-item">
                <img loading="lazy" src="https://picsum.photos/1200/200?random=93" class="d-block w-100" alt="Quảng cáo 3">
              </div>
            </div>
            <button class="carousel-control-prev" type="button" data-bs-target="#footerAds" data-bs-slide="prev">
              <span class="carousel-control-prev-icon"></span>
            </button>
            <button class="carousel-control-next" type="button" data-bs-target="#footerAds" data-bs-slide="next">
              <span class="carousel-control-next-icon"></span>
            </button>
          </div>
        </div>

      </section>
    </div>
  </div>

  <!-- ================== OFFCANVAS: CART ================== -->
  <div class="offcanvas offcanvas-end" tabindex="-1" id="cartCanvas" aria-labelledby="cartCanvasLabel">
    <div class="offcanvas-header">
      <h5 id="cartCanvasLabel" class="mb-0">Giỏ hàng</h5>
      <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body">
      <div id="cartList"></div>

      <div class="summary-box d-flex justify-content-between align-items-center">
        <span>Tổng cộng</span><span id="cartTotal">0 đ</span>
      </div>

      <button class="btn btn-danger w-100 mb-2" id="clearCartBtn">Xóa toàn bộ</button>

      <input id="buyerName" class="form-control mb-2" placeholder="Họ và tên" aria-label="Họ và tên">
      <input id="buyerEmail" class="form-control mb-2" placeholder="Email" aria-label="Email">
      <input id="buyerPhone" class="form-control mb-2" placeholder="Số điện thoại" aria-label="Số điện thoại">
      <input id="buyerAddress" class="form-control mb-2" placeholder="Địa chỉ nhận hàng" aria-label="Địa chỉ nhận hàng">
      <textarea id="buyerNote" class="form-control mb-2" placeholder="Ghi chú" aria-label="Ghi chú"></textarea>

      <label class="form-label mt-2">Tải tệp yêu cầu / thiết kế (tùy chọn)</label>
      <input id="buyerFile" type="file" class="form-control mb-2" accept=".pdf,.doc,.docx,.xls,.xlsx,.png,.jpg,.jpeg,.zip">

      <div class="row g-2">
        <div class="col-12">
          <label class="form-label">Dịch vụ LẤY BÁO GIÁ HỘ (tùy chọn)</label>
          <select id="servicePlan" class="form-select">
            <option value="">— Không chọn —</option>
            <option value="100000-3">100.000 đ / 3 báo giá</option>
            <option value="500000-10">500.000 đ / 10 báo giá</option>
          </select>
        </div>
        <div class="col-12">
          <div class="form-check mt-2">
            <input class="form-check-input" type="checkbox" id="fileQuote">
            <label class="form-check-label" for="fileQuote">Báo giá theo tệp tải lên</label>
          </div>
        </div>
      </div>

      <div class="alert alert-secondary mt-3 mb-2" style="font-size:12px">
        <div><strong>Hướng dẫn:</strong></div>
        <div>1) Bạn cần làm giống mẫu nào hoặc mua sản phẩm gì bấm gửi, chúng tôi sẽ sớm liên hệ lại sau.</div>
        <div>2) Ghi rõ yêu cầu sẽ giúp chúng tôi tư vấn cho bạn dễ dàng hơn.</div>
        <div>3) CSKH của 2606ai.vn sẽ trực tiếp liên hệ bạn trong vòng 24h (nếu quá thời gian này, vui lòng liên hệ lại).</div>
      </div>

      <button class="btn btn-success w-100" id="submitOrderBtn">Gửi đơn hàng</button>
    </div>
  </div>

  <!-- ================== OFFCANVAS: FILTERS ================== -->
  <div class="offcanvas offcanvas-end" tabindex="-1" id="filterPanel" aria-labelledby="filterPanelLabel">
    <div class="offcanvas-header">
      <h5 id="filterPanelLabel" class="mb-0">Bộ lọc nâng cao</h5>
      <div class="d-flex gap-2">
        <button type="button" class="btn btn-outline-danger btn-sm" id="clearFiltersBtn">Xóa bộ lọc</button>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
      </div>
    </div>
    <div class="offcanvas-body">
      <h6>ẤN PHẨM THƯƠNG HIỆU</h6><div id="brandBox" class="mb-3"></div>
      <h6>TYPE</h6><div id="typeBox" class="mb-3"></div>
      <h6>LOẠI SẢN PHẨM</h6><div id="loaiBox" class="mb-3"></div>
      <h6>CHÚ Ý</h6><div id="noteBox" class="mb-3"></div>
      <h6>GROUP (NHÓM)</h6><div id="groupBox" class="mb-3"></div>
    </div>
  </div>

  <!-- ================== OFFCANVAS: SUPPLIERS ================== -->
  <div class="offcanvas offcanvas-end" tabindex="-1" id="suppliersCanvas" aria-labelledby="suppliersLabel">
    <div class="offcanvas-header">
      <h5 id="suppliersLabel" class="mb-0">Danh sách xưởng</h5>
      <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body">
      <div class="sup-toolbar">
        <div class="row g-2 align-items-center">
          <div class="col-12">
            <input id="supSearch" class="form-control" placeholder="Tìm theo tên, địa chỉ, chứng nhận…">
          </div>
          <div class="col-7 d-flex align-items-center gap-2">
            <select id="supSort" class="form-select form-select-sm" style="max-width:210px">
              <option value="name">Sắp xếp A→Z (Tên)</option>
              <option value="addr">Theo địa chỉ</option>
            </select>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="supHasSite">
              <label class="form-check-label small" for="supHasSite">Chỉ xưởng có website</label>
            </div>
          </div>
          <div class="col-5">
            <div class="counter justify-content-end">
              <span class="pill" id="suppliersCount">0</span>
              <span class="small">xưởng phù hợp</span>
            </div>
          </div>
        </div>
      </div>

      <div id="suppliersList" class="supplier-list">Chưa có dữ liệu.</div>

      <!-- Hidden file input dùng chung cho nút "Tải tệp" (sửa bug thiếu phần tử) -->
      <input id="uploadSupplierFile" type="file" hidden accept=".pdf,.png,.jpg,.jpeg,.doc,.docx,.zip" />

      <div class="mt-3">
        <a id="adsContactBtn" href="#" target="_blank" rel="noopener"
           class="btn btn-primary w-100">LIÊN HỆ ĐẶT QUẢNG CÁO</a>
      </div>
    </div>
  </div>

  <!-- ================== MODAL: BENEFIT DETAILS ================== -->
  <div class="modal fade" id="benefitModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content" style="border-radius:16px">
        <div class="modal-header" style="background:var(--main-grad);color:#fff;border:0">
          <h5 class="modal-title" id="benefitTitle">Chi tiết</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" style="filter:invert(1)"></button>
        </div>
        <div class="modal-body">
          <div id="benefitLead" class="text-muted mb-2"></div>
          <ul id="benefitList" class="mb-2"></ul>
          <div id="benefitNote" class="small text-muted"></div>
        </div>
        <div class="modal-footer" style="border:0">
          <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Đã hiểu</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ================== FABs ================== -->
  <button id="filterFab" class="filter-fab" aria-label="Mở bộ lọc">
    ⚙️ <span id="filterFabCount" class="fab-badge">0</span>
  </button>
  <button id="cartFab" class="cart-fab" aria-label="Mở giỏ hàng">
    🛒 <span id="cartFabCount" class="fab-badge">0</span>
  </button>
  <button id="suppliersFab" class="suppliers-fab" aria-label="Danh sách xưởng">🏭</button>
  <a id="zaloFab" class="zalo-fab" aria-label="Zalo" href="#" target="_blank" rel="noopener">💬</a>

  <!-- ================== ERROR BOX ================== -->
  <div id="errbox" role="alert" aria-live="assertive"></div>

  <!-- ================== SCRIPTS ================== -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    /* === SELF-HEAL “Xưởng đề xuất” — tạo box nếu thiếu + tiêm CSS + render demo === */
(function(){
  // 1) Tiêm CSS (chống xẹp layout)
  const css = `
  #adsBox{ display:block !important; visibility:visible !important; }
  #adsList{ display:flex !important; flex-direction:column; gap:8px; min-height:120px; }
  #adsList .link-preview{
    display:flex !important; gap:10px;
    background:#fff; border:1px solid #e3f2fd; border-radius:10px; padding:10px;
    box-shadow:0 1px 2px rgba(0,0,0,.06); text-decoration:none;
  }
  #adsList .thumb{ width:64px; height:64px; border-radius:8px; object-fit:cover; background:#f1f4ff; }
  #adsBox .small.text-muted{ display:block; }
  `;
  const st = document.createElement('style'); st.textContent = css; document.head.appendChild(st);

  // 2) Tạo box nếu chưa có và đặt đúng VỊ TRÍ (cột trái, dưới benefits)
  let box = document.getElementById('adsBox');
  if (!box) {
    const aside = document.querySelector('#leftCol') || document.querySelector('aside');
    box = document.createElement('div');
    box.id = 'adsBox';
    box.className = 'sidebar-box ads-box';
    box.innerHTML = `
      <h6 class="fw-bold mb-2 d-flex align-items-center justify-content-between">
        <span class="d-inline-flex align-items-center gap-2">
          Xưởng đề xuất
          <span id="adsCount" class="badge rounded-pill text-bg-primary" style="display:none">0</span>
        </span>
      </h6>
      <div id="adsList" class="d-flex flex-column gap-2"></div>
      <div id="adsEmpty" class="small text-muted">Đang tải dữ liệu…</div>
      <div class="mt-2 text-center">
        <a id="adsContactBtn2" href="#" target="_blank" rel="noopener"
           class="btn btn-sm fw-bold px-3"
           style="border-radius:999px;background:#ffca28;color:#0d47a1;border:none">
          📢 LIÊN HỆ ĐẶT QUẢNG CÁO
        </a>
      </div>`;
    // chèn ngay dưới khối benefits nếu có
    const benefits = aside && aside.querySelector('.benefits-v3');
    if (aside) (benefits ? benefits.after(box) : aside.prepend(box));
  }

  // 3) Render DEMO để bạn thấy ngay
  const esc = s => (s??'').toString().replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
  function render(items){
    const list  = document.getElementById('adsList');
    const empty = document.getElementById('adsEmpty');
    const badge = document.getElementById('adsCount');
    const html = (items||[]).map(it=>{
      const url=it.url||'#', img=it.img||'https://picsum.photos/80?blur=0.1', ttl=it.title||'Đơn vị', desc=it.desc||'';
      const site = url && /^https?:\/\//i.test(url) ? new URL(url).hostname : '';
      return `
      <a class="link-preview" href="${esc(url)}" target="_blank" rel="noopener">
        <img class="thumb" src="${esc(img)}" alt="${esc(ttl)}">
        <div class="flex-grow-1 small">
          <div class="title text-truncate">${esc(ttl)}</div>
          ${desc?`<div class="desc text-truncate">${esc(desc)}</div>`:''}
          ${site?`<div class="site">${esc(site)}</div>`:''}
        </div>
      </a>`;
    }).join('');
    list.innerHTML = html;
    empty.style.display = html ? 'none' : 'block';
    if (badge){ const n=(items||[]).length; badge.textContent=n; badge.style.display=n?'inline-block':'none'; }
  }

  render([
    { title:'Xưởng DEMO 1', url:'#', img:'https://picsum.photos/80?1', desc:'Đúc – mạ – laser' },
    { title:'Xưởng DEMO 2', url:'#', img:'https://picsum.photos/80?2', desc:'In UV, kim loại/nhựa' },
    { title:'Xưởng DEMO 3', url:'#', img:'https://picsum.photos/80?3', desc:'Cao su đúc 2D/3D' }
  ]);

  // 4) Cuộn tới box để bạn nhìn thấy đúng khối
  box.scrollIntoView({behavior:'smooth', block:'center'});
  console.log('[ADS] self-heal done. Items:', document.querySelectorAll('#adsList .link-preview').length);
})();

  /* ==========================================================================
     CONFIG (an toàn khi build)
     ========================================================================== */
  window.ZALO_URL = "https://zalo.me/123456789";   // thay link thật
  window.ADS_CONTACT_URL = "https://zalo.me/123456789";
  window.API_URL = "https://script.google.com/macros/s/AKfycby2PjYOKiRRphQCOI9eSDo8ShAY-Bugp_gQD7JjgJPaYE7fmaoDjbP4kXGWLpOQxWOh/exec";
  window.API_KEY = "";
  window.AUTO_OPEN_ON_ADD = false;
    
/* ================== ADS GUARD (self-heal) ================== */
(() => {
  const SEL = {
    box: '#adsBox',
    list: '#adsList'
  };

  /* 1) CSS an toàn để item không bị xẹp */
  const css = `
  ${SEL.box}{
    display:block !important; visibility:visible !important; opacity:1 !important;
    height:auto !important; max-height:none !important;
  }
  ${SEL.list}{ display:flex; flex-direction:column; gap:10px; }
  ${SEL.list} .link-preview{
    display:flex !important; align-items:center; gap:10px;
    padding:10px; background:#fff; border:1px solid #e3f2fd; border-radius:10px;
    box-shadow:0 1px 2px rgba(0,0,0,.06); min-height:72px;
    text-decoration:none; color:#111;
  }
  ${SEL.list} .thumb{
    width:64px; height:64px; flex-shrink:0; border-radius:8px; object-fit:cover; background:#f1f4ff;
  }
  ${SEL.list} .title{ font-weight:600; }
  ${SEL.list} .desc{ color:#6b7280; font-size:12px; }
  `;
  const s = document.createElement('style'); s.textContent = css; document.head.appendChild(s);

  /* DEMO dữ liệu (fallback) */
  const DEMO = [
    {url:'https://logohuyadeco.com/…', img:'https://picsum.photos/64?1',  title:'Xưởng DEMO 1', desc:'Đúc – mạ – laser'},
    {url:'https://quatangviet.vn/…',      img:'https://picsum.photos/64?2',  title:'Xưởng DEMO 2', desc:'In UV / Nhựa / Hợp kim'},
    {url:'https://igift.com.vn/…',        img:'https://picsum.photos/64?3',  title:'Xưởng DEMO 3', desc:'Khuôn nhanh – giá tốt'}
  ];

  const $ = (q)=>document.querySelector(q);

  function forceShowBox() {
    const box = $(SEL.box); if (!box) return;
    box.style.removeProperty('display');
    box.style.removeProperty('visibility');
    box.classList.remove('d-none','invisible');
    box.style.display   = 'block';
    box.style.visibility= 'visible';
    box.style.opacity   = '1';
  }

  function ensureMinHeight() {
    const box  = $(SEL.box);
    const list = $(SEL.list);
    if (!box || !list) return;
    // nếu có item nhưng height=0 thì set tạm để tránh xẹp
    if (list.children.length && box.offsetHeight === 0) {
      box.style.minHeight = '140px';
    } else if (!list.children.length) {
      box.style.minHeight = '';
    }
  }

  function render(items) {
    const list = $(SEL.list); if (!list) return;
    list.innerHTML = items.map(it => `
      <a class="link-preview" href="${it.url||'#'}" target="_blank" rel="noopener">
        <img class="thumb" src="${it.img||'https://placehold.co/64'}" alt="">
        <div class="flex-grow-1">
          <div class="title text-truncate">${it.title||'Đơn vị'}</div>
          ${it.desc?`<div class="desc text-truncate">${it.desc}</div>`:''}
          ${it.site?`<div class="site">${it.site}</div>`:''}
        </div>
      </a>`).join('');
    forceShowBox();
    ensureMinHeight();
  }

  function ensureAds() {
    const box  = $(SEL.box);
    const list = $(SEL.list);
    if (!box || !list) return;

    const hasItems = list.querySelector('.link-preview');
    if (!hasItems) {
      // Nếu rỗng → render DEMO
      render(DEMO);
    } else {
      forceShowBox();
      ensureMinHeight();
    }
  }

  // 2) Quan sát mọi thay đổi trong #adsList: có item → show, rỗng → demo
  const listEl = $(SEL.list);
  if (listEl) {
    new MutationObserver(() => ensureAds())
      .observe(listEl, { childList:true, subtree:false });
  }

  // 3) Cứ mỗi 1.5 giây kiểm tra 1 lần (phòng code khác clear DOM bất chợt)
  setInterval(ensureAds, 1500);

  // 4) chạy ngay lần đầu
  ensureAds();
})();


  /* ==========================================================================
     ERROR GUARD
     ========================================================================== */
  (function(){
    const box=document.getElementById('errbox');
    function show(msg){
      try{
        box.style.display='block';
        box.textContent='[ERROR] '+msg;
      }catch{}
      console.error(msg);
    }
    window.addEventListener('error', e=>show(e.message+(e.filename?(' @ '+e.filename+':'+e.lineno):'')));
    window.addEventListener('unhandledrejection', e=>show('Promise rejected: '+((e.reason&&e.reason.message)||e.reason)));
    window._showError = show;
  })();

  /* ==========================================================================
     STATE + GLOBALS
     ========================================================================== */
  window.state = {
    page: 1,
    pageSize: 36,
    q: '',
    group: '',
    type: '',
    loai: '',
    note: '',
    category: '',
    totalPages: 1
  };
  const state = window.state;

  window.cart = [];
  window.products = {};

  /* ==========================================================================
     UTILITIES
     ========================================================================== */
  const fmtVND = n => (Number(n)||0).toLocaleString('vi-VN') + ' đ';
  const esc = s => (s??'').toString().replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
  function badgeColor(txt){
    if(!txt) return "#555";
    const t=txt.toLowerCase();
    if(t.includes("mẫu")||t.includes("sample")) return "#4caf50";
    if(t.includes("giảm")||t.includes("sale")||t.includes("km")) return "#ff9800";
    if(t.includes("gấp")||t.includes("urgent")) return "#d32f2f";
    return "#555";
  }
   // Drive "view" → "thumbnail", + fallback
const ADS_FALLBACK = 'https://placehold.co/64x64?text=%20&bg=E8F5E9&fc=2E7D32';
function toDriveThumb(u){
  if (!u) return ADS_FALLBACK;
  const m = String(u).match(/\/d\/([^/]+)\//);
  if (m && m[1]) return `https://drive.google.com/thumbnail?id=${m[1]}&sz=w200`;
  if (/drive\.google\.com\/thumbnail\?id=/i.test(u)) return u;
  return /^https?:\/\//i.test(u) ? u : ADS_FALLBACK;
}
function safeImg(u){
  if (!u) return ADS_FALLBACK;
  const url = toDriveThumb(u);
  return /^https?:\/\//i.test(url) ? url : ADS_FALLBACK;
}
 
  function firstLink(s){
    if(!s) return '';
    const parts=String(s).split(/[\s,;|\n]+/).filter(Boolean);
    for(const p of parts) if(/^https?:\/\//i.test(p)) return p;
    return parts[0]||'';
  }
  function upgradeThumbQuality(u){
    try{
      if(!u) return u;
      const url = new URL(u, location.href);
      if (url.hostname.includes('googleusercontent') || url.hostname.includes('google.com')) {
        if (url.searchParams.has('sz')) url.searchParams.set('sz','w800');
        else url.searchParams.append('sz','w800');
        return url.toString();
      }
    }catch(_){
      return String(u).replace(/([?&])sz=w\d+/,'$1sz=w800');
    }
    return u;
  }
  function debounce(fn, ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn.apply(this,a),ms); }; }

  /* ==========================================================================
     ICON MAPS (Group & Category)
     ========================================================================== */
  const GROUP_ICONS = {
    "QUÀ TẶNG 247 EXPRESS (Đối tác)":"https://drive.google.com/thumbnail?id=1ixc_p6X925a0JpSG4YIWwpyauVmhRakI&sz=w1000",
    "QUÀ TẶNG ẤN PHẨM THƯƠNG HIỆU":"https://img.icons8.com/fluency/96/advertising.png",
    "QUÀ TẶNG SẢN PHẨM THƯƠNG HIỆU":"https://img.icons8.com/fluency/96/product.png",
    "QUÀ TẶNG KỶ NIỆM EVENT THƯƠNG HIỆU":"https://img.icons8.com/fluency/96/conference-foreground-selected.png",
    "QUÀ TẶNG PHỤ KIỆN THƯƠNG HIỆU":"https://img.icons8.com/fluency/96/electronics.png",
    "KHÁC":"https://img.icons8.com/fluency/96/more.png"
  };
  function iconForGroup(name){ return GROUP_ICONS[name] || GROUP_ICONS["KHÁC"]; }

  const CATEGORY_ICONS = {
    "__DEFAULT__": "https://drive.google.com/thumbnail?id=1ixc_p6X925a0JpSG4YIWwpyauVmhRakI&sz=w48"
  };
  function normKey(s){ return String(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/^\s*\d+\.\s*/,'').replace(/\s+/g,' ').trim().toUpperCase(); }
  function iconForCat(name){ return CATEGORY_ICONS[normKey(name)] || CATEGORY_ICONS["__DEFAULT__"]; }

  /* ==========================================================================
     RENDERERS
     ========================================================================== */
  function productCardHtml(it){
    products[it.id]=it;
    const giftUrl   = firstLink(it.imageClick);
    const showGift  = !!giftUrl;
    const giftLabel = (it.loai || 'Nhận quà').toString().trim();

    const thumbSrc = upgradeThumbQuality(it.img);
    const linkHref = esc(it.linkFull || it.img || '#');

    return `<div class="col"><div class="cardx">
      <div class="thumb-wrap">
        <a href="${linkHref}" target="_blank" rel="noopener">
          <img loading="lazy" class="thumb" src="${esc(thumbSrc)}" alt="Sản phẩm ${esc(it.id)}" onerror="this.src='https://via.placeholder.com/300x300?text=No+Image'">
        </a>
        ${it.note?`<span class="note-chip" style="background:${badgeColor(it.note)}">${esc(it.note)}</span>`:''}
      </div>
      <div class="meta">
        <div class="id">${esc(it.id)}</div>
        <div class="details">${esc(it.details||'')}</div>
        ${it.type ? `<div class="type-badge">${esc(it.type)}</div>` : ``}
        <div class="price">${fmtVND(it.price)}</div>
        <div class="meta-actions">
          ${showGift ? `<a class="btn-gift" href="${esc(giftUrl)}" target="_blank" rel="noopener" title="${esc(giftLabel)}"><span>${esc(giftLabel)}</span></a>` : `<span></span>`}
          <button class="add-btn" data-action="add-to-cart" data-id="${esc(it.id)}" aria-label="Thêm ${esc(it.id)} vào giỏ">+</button>
        </div>
      </div>
    </div></div>`;
  }

  function renderPagination(totalItems, pageSize, currentPage){
    const totalPages = Math.max(1, Math.ceil((totalItems || 0) / (pageSize || 1)));
    state.totalPages = totalPages;

    const block = (where) => `
      <div class="d-inline-flex align-items-center gap-1" data-where="${where}">
        <button type="button" class="btn btn-sm btn-outline-secondary" data-action="page-prev" ${currentPage<=1?'disabled':''}>&lsaquo;</button>
        <select class="form-select form-select-sm page-select" style="width:auto">
          ${Array.from({length: totalPages}, (_, i) => {
            const p = i + 1;
            return `<option value="${p}" ${p===currentPage?'selected':''}>Trang ${p}/${totalPages}</option>`;
          }).join('')}
        </select>
        <button type="button" class="btn btn-sm btn-outline-secondary" data-action="page-next" ${currentPage>=totalPages?'disabled':''}>&rsaquo;</button>
      </div>
    `;

    const top = document.getElementById('pagerTop');
    const bot = document.getElementById('pagerBottom');
    if (top) top.innerHTML = block('top');
    if (bot) bot.innerHTML = block('bottom');

    document.querySelectorAll('#pagerTop .page-select, #pagerBottom .page-select')
      .forEach(sel => {
        sel.onchange = (e) => {
          state.page = parseInt(e.target.value, 10) || 1;
          fetchPage();
        };
      });

    const leftBlock = document.querySelector('.found-count');
    if (leftBlock && top) {
      leftBlock.appendChild(top);
      top.classList.add('ms-2');
    }
  }

  /* GROUP & CATEGORY (static config + from facets) */
  function renderGroups(groups){
    const bar  = document.getElementById('groupBar');
    const dotsBox = document.getElementById('groupDots');
    if(!bar || !dotsBox) return;

    const list = groups || [];
    bar.innerHTML = list.map(g => `
      <div class="group-chip ${state.group===g?'active':''}"
           data-action="select-group" data-val="${esc(g)}" role="tab" aria-selected="${state.group===g?'true':'false'}">
        <span class="chip-icon"><img src="${esc(iconForGroup(g))}" alt=""></span>
        <span class="chip-text">${esc(g)}</span>
      </div>
    `).join('');

    dotsBox.innerHTML = list.map((_,i)=>
      `<span class="dot ${state.group===list[i]?'active':''}" data-idx="${i}"></span>`
    ).join('');

    window._lastGroups = list;
  }

  const CAT_CONFIG = [
    { id:'huy-chuong-phoi-san', label:'Huy chương phôi sẵn',
      icon:'https://drive.google.com/thumbnail?id=1e9N6rgsTP5vYtKl4Lwq801dfteYLbx_F&sz=w200', link:'#',
      filters:{ category:'Huy chương phôi sẵn' } },

    { id:'huy-chuong-chay-bo', label:'Huy chương sự kiện chạy bộ',
      icon:'https://drive.google.com/thumbnail?id=1e9N6rgsTP5vYtKl4Lwq801dfteYLbx_F&sz=w200', link:'#',
      filters:{ category:'Huy chương sự kiện chạy bộ' } },

    { id:'moc-khoa-cao-su', label:'Móc khóa cao su',
      icon:'https://drive.google.com/thumbnail?id=1e9N6rgsTP5vYtKl4Lwq801dfteYLbx_F&sz=w200', link:'#',
      filters:{ category:'Móc khóa cao su' } },

    { id:'moc-khoa-hop-kim', label:'Móc khóa hợp kim',
      icon:'https://drive.google.com/thumbnail?id=1e9N6rgsTP5vYtKl4Lwq801dfteYLbx_F&sz=w200', link:'#',
      filters:{ category:'Móc khóa hợp kim' } },

    { id:'moc-khoa-tet-2025', label:'Móc khóa tết 2025',
      icon:'https://drive.google.com/thumbnail?id=1e9N6rgsTP5vYtKl4Lwq801dfteYLbx_F&sz=w200', link:'#',
      filters:{ category:'Móc khóa tết 2025' } },

    { id:'moc-khoa-tet-2026', label:'Móc khóa tết 2026',
      icon:'https://drive.google.com/thumbnail?id=1e9N6rgsTP5vYtKl4Lwq801dfteYLbx_F&sz=w200', link:'#',
      filters:{ category:'Móc khóa tết 2026' } },

    { id:'moc-khoa-tet-2027', label:'Móc khóa tết 2027',
      icon:'https://drive.google.com/thumbnail?id=1e9N6rgsTP5vYtKl4Lwq801dfteYLbx_F&sz=w200', link:'#',
      filters:{ category:'Móc khóa tết 2027' } },

    { id:'moc-khoa-tet-2030', label:'Móc khóa tết 2030',
      icon:'https://drive.google.com/thumbnail?id=1e9N6rgsTP5vYtKl4Lwq801dfteYLbx_F&sz=w200', link:'#',
      filters:{ category:'Móc khóa tết 2030' } },

    { id:'moc-khoa-tet-2031', label:'Móc khóa tết 2031',
      icon:'https://drive.google.com/thumbnail?id=1e9N6rgsTP5vYtKl4Lwq801dfteYLbx_F&sz=w200', link:'#',
      filters:{ category:'Móc khóa tết 2031' } },

    { id:'moc-khoa-tet-2032', label:'Móc khóa tết 2032',
      icon:'https://drive.google.com/thumbnail?id=1e9N6rgsTP5vYtKl4Lwq801dfteYLbx_F&sz=w200', link:'#',
      filters:{ category:'Móc khóa tết 2032' } },

    { id:'moc-khoa-tet-2036', label:'Móc khóa tết 2036',
      icon:'https://drive.google.com/thumbnail?id=1e9N6rgsTP5vYtKl4Lwq801dfteYLbx_F&sz=w200', link:'#',
      filters:{ category:'Móc khóa tết 2036' } },
  ];

  function renderCategoriesFromConfig(){
    const wrap = document.getElementById('categoryScroll');
    if (!wrap) return;

    wrap.innerHTML = CAT_CONFIG.map(c => `
      <a class="category-item" href="#"
         data-action="select-category"
         data-val="${c.filters?.category || ''}">
        <div class="icon">
          <img src="${c.icon}" alt="${esc(c.label)}">
        </div>
        <div class="label">${esc(c.label)}</div>
      </a>
    `).join('');
  }

  /* ==========================================================================
     GROUP DOTS + ARROWS (accessible & robust)
     ========================================================================== */
  const groupBarEl = document.getElementById('groupBar');
  const dotBox     = document.getElementById('groupDots');
  const btnPrev    = document.getElementById('groupPrev');
  const btnNext    = document.getElementById('groupNext');

  function currentPage(){
    if(!groupBarEl) return 0;
    const w = groupBarEl.clientWidth || 1;
    return Math.round(groupBarEl.scrollLeft / w);
  }
  function pagesCount(){
    return groupBarEl ? Math.ceil(groupBarEl.scrollWidth / (groupBarEl.clientWidth||1)) : 1;
  }
  function scrollToPage(p){
    const w = groupBarEl.clientWidth;
    groupBarEl.scrollTo({ left: p*w, behavior: 'smooth' });
  }
  function updateGroupArrows(){
    if(!groupBarEl || !btnPrev || !btnNext) return;
    const p = currentPage(), pc = pagesCount();
    btnPrev.disabled = (p <= 0);
    btnNext.disabled = (p >= pc-1);
  }
  function updateGroupDots(){
    const dots = document.querySelectorAll('#groupDots .dot');
    const chips = document.querySelectorAll('#groupBar .group-chip');
    let activeIdx = -1;
    chips.forEach((c,i)=>{ if(c.dataset.val === (state.group||'')) activeIdx = i; });
    dots.forEach((d,i)=> d.classList.toggle('active', i===activeIdx));
  }
  btnPrev?.addEventListener('click', ()=> scrollToPage(Math.max(0, currentPage()-1)));
  btnNext?.addEventListener('click', ()=> scrollToPage(Math.min(pagesCount()-1, currentPage()+1)));
  groupBarEl?.addEventListener('scroll', ()=>{ clearTimeout(groupBarEl._t); groupBarEl._t = setTimeout(()=>{ updateGroupArrows(); updateGroupDots(); }, 60); });

  dotBox?.addEventListener('click', (e)=>{
    const dot = e.target.closest('.dot'); if(!dot) return;
    const idx = Number(dot.dataset.idx)||0;
    const chips = document.querySelectorAll('#groupBar .group-chip');
    const chip = chips[idx];
    if(chip){
      state.group = chip.dataset.val || '';
      state.page = 1;
      updateGroupUI();
      updateGroupDots();
      fetchPage();
      chip.scrollIntoView({behavior:'smooth', inline:'center', block:'nearest'});
    }
  });

  window.addEventListener('resize', ()=>{ if(window._repaint_t){ clearTimeout(window._repaint_t); } window._repaint_t = setTimeout(()=> renderGroups((window._lastGroups)||[]), 120); });

  /* ==========================================================================
     CATEGORY SCROLLER arrows
     ========================================================================== */
  (function(){
    const wrap = document.getElementById('categoryScroll');
    const prev = document.getElementById('catPrev');
    const next = document.getElementById('catNext');
    if (!wrap || !prev || !next) return;

    const eps  = 4;
    const getMax = () => Math.max(0, wrap.scrollWidth - wrap.clientWidth);
    const step   = () => Math.max(240, Math.round(wrap.clientWidth * 0.9));
    const clamp  = (n, min, max) => Math.min(max, Math.max(min, n));

    function go(dir){
      const max = getMax();
      const target = clamp(wrap.scrollLeft + dir * step(), 0, max);
      wrap.scrollTo({ left: target, behavior: 'smooth' });
      setTimeout(update, 350);
    }
    function update(){
      const max = getMax();
      const atStart = wrap.scrollLeft <= eps;
      const atEnd   = wrap.scrollLeft >= (max - eps);
      const noScroll = max <= eps;
      prev.disabled = atStart || noScroll;
      next.disabled = atEnd   || noScroll;
      prev.classList.toggle('is-disabled', prev.disabled);
      next.classList.toggle('is-disabled', next.disabled);
    }
    prev.addEventListener('click', () => go(-1));
    next.addEventListener('click', () => go( 1));
    wrap.addEventListener('scroll', update, { passive:true });
    window.addEventListener('resize', () => setTimeout(update, 50));
    update();
    setTimeout(update, 300);
  })();

  /* ==========================================================================
     FILTER BOXES
     ========================================================================== */
  function buildFilterBox(boxId, items, field){
    const box=document.getElementById(boxId);
    if(!box) return;
    box.classList.add("filter-box-group");
    box.innerHTML=(items||[]).map(val=>`
      <div class="filter-tag ${state[field]===val?'active':''}"
        data-action="set-filter" data-field="${field}" data-val="${esc(val)}" role="button" tabindex="0">
        ${esc(val||'Tất cả')}
      </div>
    `).join('');
  }
  function updateFilterCount(){
    let c=0; if(state.type)c++; if(state.loai)c++; if(state.note)c++; if(state.category)c++;
    const fb=document.getElementById('filterFabCount');
    if(fb){ fb.textContent=c; fb.style.display=c? 'inline-block':'none'; }
  }

  /* ==========================================================================
     ADS BOX (fixed: define findAdsBox, resilient parsing)
     ========================================================================== */
  function findAdsBox(){ return document.getElementById('adsBox'); }

  function ensureAdsList(box){
    let list = box.querySelector('#adsList, .ads-list, [data-ads-list]');
    if (!list){
      list = document.createElement('div');
      list.id = 'adsList';
      list.className = 'd-flex flex-column gap-2';
      const body = box.querySelector('.card-body, .p-3, .p-2, .body') || box;
      body.appendChild(list);
    }
    let empty = box.querySelector('#adsEmpty');
    if (!empty){
      empty = document.createElement('div');
      empty.id = 'adsEmpty';
      empty.className = 'text-muted small mt-1';
      empty.textContent = 'Đang tải dữ liệu…';
      list.after(empty);
    }
    box.classList.remove('d-none', 'invisible');
    box.style.display = 'block';
    return {list, empty};
  }

/* ===== HOTFIX: XƯỞNG ĐỀ XUẤT BẮT BUỘC HIỂN THỊ ===== */
(function AdsHotfix(){
  const ADS_FALLBACK = 'https://placehold.co/64x64?text=%20&bg=E8F5E9&fc=2E7D32';

  function toDriveThumb(u){
    if (!u) return ADS_FALLBACK;
    const m = String(u).match(/\/d\/([^/]+)\//);
    if (m && m[1]) return `https://drive.google.com/thumbnail?id=${m[1]}&sz=w200`;
    if (/drive\.google\.com\/thumbnail\?id=/i.test(u)) return u;
    return /^https?:\/\//i.test(u) ? u : ADS_FALLBACK;
  }
  function safeImg(u){
    if (!u) return ADS_FALLBACK;
    const url = toDriveThumb(u);
    return /^https?:\/\//i.test(url) ? url : ADS_FALLBACK;
  }

  const box   = document.getElementById('adsBox');
  const list  = box?.querySelector('#adsList');
  const empty = box?.querySelector('#adsEmpty');
  const badge = document.getElementById('adsCount');

  function _render(items){
    if (!box || !list || !empty) return;
    const html = (items||[]).map(it=>{
      const url   = it.url || it.link || '#';
      const img   = safeImg(it.img || it.image || it.thumb || it.thumbnail || it.linkfull);
      const title = it.title || it.name || 'Đơn vị';
      const desc  = it.desc  || it.description || '';
      const site  = url && /^https?:\/\//i.test(url) ? new URL(url).hostname : '';
      return `
        <a class="link-preview" href="${esc(url)}" target="_blank" rel="noopener">
          <img class="thumb" src="${esc(img)}" alt="${esc(title)}" onerror="this.src='${ADS_FALLBACK}'">
          <div class="flex-grow-1 small">
            <div class="title text-truncate">${esc(title)}</div>
            ${desc ? `<div class="desc text-truncate">${esc(desc)}</div>` : ``}
            ${site ? `<div class="site">${esc(site)}</div>` : ``}
          </div>
        </a>`;
    }).join('');
    list.innerHTML = html;
    empty.style.display = html ? 'none' : 'block';
    empty.textContent   = html ? '' : 'Chưa có dữ liệu quảng cáo.';
    if (badge){
      const n = (items||[]).length;
      badge.textContent = n;
      badge.style.display = n ? 'inline-block' : 'none';
    }
    box.style.display = 'block';
  }

  async function _try(action){
    const qs = new URLSearchParams({action});
    const r  = await fetch(API_URL + '?' + qs.toString(), {redirect:'follow', mode:'cors'});
    const tx = await r.text();
    let json;
    try{ json = JSON.parse(tx); }
    catch{
      json = JSON.parse(tx.replace(/^\)\]\}'[^\n]*\n?/, '').replace(/^\uFEFF/, '').trim());
    }
    return (json && json.ok !== false && Array.isArray(json.items)) ? json.items : [];
  }

  async function _load(){
    if (!box || !list || !empty) return;
    empty.style.display='block'; empty.textContent='Đang tải dữ liệu…';
    try{
      // thử nhiều action khác nhau
      let items = await _try('ads');
      if (!items.length) items = await _try('adsList');
      if (!items.length) items = await _try('sponsors');
      if (!items.length) items = await _try('partners');

      // Fallback demo để xác nhận UI hoạt động
      if (!items.length){
        items = [
          { title:'Xưởng Kim Loại Minh Phát', url:'#', img:'https://picsum.photos/80?1', desc:'Đúc – mạ – khắc laser' },
          { title:'UV Printing An Khang',      url:'#', img:'https://picsum.photos/80?2', desc:'In UV trên kim loại/nhựa' },
          { title:'Cao su đúc màu 2D/3D',      url:'#', img:'https://picsum.photos/80?3', desc:'Khuôn nhanh – giá tốt' },
        ];
      }
      _render(items);
    }catch(e){
      console.warn('[ADS] error', e);
      _render([]);
    }
  }

  // Xoá định nghĩa cũ nếu có, gán public mới rồi nạp
  window.renderAds = _render;
  window.fetchAds  = _load;

  // Nếu init() đã gọi fetchAds() trước đó mà bị ghi đè, ta vẫn tự gọi lại sau 500ms
  setTimeout(_load, 500);
})();



  /* ==========================================================================
     SUPPLIERS
     ========================================================================== */
  let suppliersAll = [];
  function normalize(s){ return (s||'').toString().toLowerCase().trim(); }

  function supplierCardHTML(s){
    const hasSite = !!s.url;
    const hasDoc  = s.cert && /^https?:\/\//i.test(s.cert);
    return `
      <div class="supplier-card mb-2" data-supplier="${esc(s.name||'')}">
        <div class="title">${esc(s.name||'')}</div>
        ${hasSite
          ? `<a href="${esc(s.url)}" target="_blank" rel="noopener" class="small text-truncate d-inline-block" style="max-width:100%">${esc(s.url)}</a>`
          : `<div class="small text-muted">(Không có website cụ thể)</div>`}
        ${s.address ? `<div class="meta mt-1">📍 ${esc(s.address)}</div>` : ''}

        <div class="chips">
          <span class="chip ${hasSite?'ok':''}">${hasSite?'Có website':'Chưa có website'}</span>
          ${
            hasDoc
              ? `<span class="chip"><a href="${esc(s.cert)}" target="_blank" rel="noopener">Xem tệp</a></span>`
              : `<span class="chip muted" data-doc-status="empty">Chưa có tệp</span>
                 <button class="chip btn-upload-doc" data-supplier="${esc(s.name||'')}">Tải tệp</button>`
          }
          ${s.contact ? `<span class="chip">Liên hệ: ${esc(s.contact)}</span>` : ''}
        </div>
      </div>
    `;
  }

  function renderSuppliersList(items){
    const box = document.getElementById('suppliersList');
    const counter = document.getElementById('suppliersCount');
    if(counter) counter.textContent = `${items.length}/${suppliersAll.length}`;
    box.innerHTML = items.length ? items.map(supplierCardHTML).join('') : '<div class="text-muted">Không tìm thấy xưởng phù hợp.</div>';
  }

  function applySupFilters(){
    const q = normalize(document.getElementById('supSearch').value);
    const hasSite = document.getElementById('supHasSite').checked;
    const sortBy  = document.getElementById('supSort').value;

    let out = suppliersAll.filter(s=>{
      if(hasSite && !s.url) return false;
      if(!q) return true;
      const hay = normalize([s.name, s.address, s.cert, s.url].join(' '));
      return hay.includes(q);
    });

    if(sortBy === 'addr'){
      out.sort((a,b)=> normalize(a.address).localeCompare(normalize(b.address)));
    } else {
      out.sort((a,b)=> normalize(a.name).localeCompare(normalize(b.name)));
    }
    renderSuppliersList(out);
  }

  function bindSupplierFilters(){
    const $q  = document.getElementById('supSearch');
    const $ok = document.getElementById('supHasSite');
    const $so = document.getElementById('supSort');
    if($q)  $q.addEventListener('input', debounce(applySupFilters, 250));
    if($ok) $ok.addEventListener('change', applySupFilters);
    if($so) $so.addEventListener('change', applySupFilters);
  }

  async function loadSuppliers(){
    const box=document.getElementById('suppliersList');
    box.innerHTML='Đang tải…';
    try{
      const r = await fetch(API_URL+'?action=suppliers');
      const json = await r.json();
      if(!json || !json.ok || !Array.isArray(json.items)){ suppliersAll=[]; applySupFilters(); return; }
      suppliersAll = json.items.map(s=>({
        name: s.name || '', url:  s.url  || '', address: s.address || '', cert: s.cert || '', contact: s.contact || ''
      }));
      applySupFilters();
    }catch(_){
      box.innerHTML='<div class="text-danger">Không tải được danh sách.</div>';
    }
  }

  /* Upload doc (fixed hidden input flow) */
  (function initUploadSupplierDoc(){
    const list = document.getElementById('suppliersList');
    const fileInput = document.getElementById('uploadSupplierFile');
    if (!list || !fileInput) return;

    let currentSupplier = '';

    list.addEventListener('click', (ev) => {
      const btn = ev.target.closest('.btn-upload-doc');
      if (!btn) return;
      currentSupplier = btn.getAttribute('data-supplier') || '';
      fileInput.value = '';
      fileInput.click();
    });

    fileInput.addEventListener('change', async () => {
      if (!fileInput.files || !fileInput.files[0]) return;
      const f = fileInput.files[0];

      const btn = document.querySelector(`.btn-upload-doc[data-supplier="${CSS.escape(currentSupplier)}"]`);
      if (btn) { btn.disabled = true; btn.textContent = 'Đang tải...'; }

      try{
        const fd = new FormData();
        fd.append('action', 'uploadSupplierDoc');
        fd.append('supplier', currentSupplier);
        fd.append('file', f, f.name);
        if (API_KEY) fd.append('key', API_KEY);

        const res = await fetch(API_URL, { method:'POST', body: fd });
        const json = await res.json();

        if (json && json.ok && json.url){
          const card = btn && btn.closest('.supplier-card');
          if (card){
            const status = card.querySelector('[data-doc-status="empty"]');
            if (status){
              status.outerHTML = `<span class="chip"><a href="${esc(json.url)}" target="_blank" rel="noopener">Xem tệp</a></span>`;
            }
            btn.remove();
          }
          alert('Đã tải tệp thành công.');
        }else{
          alert('Tải tệp thất bại.');
        }
      }catch(err){
        alert('Có lỗi khi tải tệp.');
      }finally{
        if (btn){
          btn.disabled = false;
          btn.textContent = 'Tải tệp';
        }
      }
    });
  })();

  /* ==========================================================================
     CART
     ========================================================================== */
  function addToCartById(id){ const it=products[id]; if(!it) return; const f=cart.find(p=>p.id===id); if(f) f.qty++; else cart.push({...it,qty:1}); updateCart(); if (AUTO_OPEN_ON_ADD) cartOffcanvas.show(); }
  function changeQty(id,delta){ const it=cart.find(p=>p.id===id); if(!it) return; it.qty+=delta; if(it.qty<=0) cart.splice(cart.indexOf(it),1); updateCart(); }
  function removeItem(id){ const i=cart.findIndex(p=>p.id===id); if(i>=0) cart.splice(i,1); updateCart(); }
  function clearCart(){ if(confirm("Xóa toàn bộ giỏ hàng?")){ cart.length=0; updateCart(); } }
  function updateCart(){
    const count = cart.reduce((a,b)=>a+b.qty,0);
    const fabCount = document.getElementById('cartFabCount');
    if(fabCount){ fabCount.textContent=count; fabCount.style.display = count>0 ? 'inline-block' : 'none'; }
    const list=document.getElementById('cartList'); let total=0;
    list.innerHTML=cart.map(it=>{
      const sub=it.qty*(Number(it.price)||0); total+=sub;
      return `<div class="d-flex align-items-center gap-2 border-bottom py-2">
        <img src="${esc(it.img)}" alt="Ảnh ${esc(it.id)}" style="width:50px;height:50px;object-fit:cover;border-radius:4px;border:1px solid #ddd">
        <div class="flex-grow-1">
          <div class="fw-semibold small">${esc(it.details||it.id)}</div>
          <div class="text-muted small">${fmtVND(it.price)}</div>
        </div>
        <div class="d-flex align-items-center gap-1">
          <button class="btn btn-sm btn-outline-secondary" data-action="qty" data-id="${esc(it.id)}" data-delta="-1">-</button>
          <span>${it.qty}</span>
          <button class="btn btn-sm btn-outline-secondary" data-action="qty" data-id="${esc(it.id)}" data-delta="1">+</button>
        </div>
        <div style="min-width:90px;text-align:right" class="small">${fmtVND(sub)}</div>
        <button class="btn btn-sm btn-link text-danger" data-action="remove" data-id="${esc(it.id)}" aria-label="Xóa ${esc(it.id)}">&times;</button>
      </div>`;
    }).join('');
    document.getElementById('cartTotal').innerText=fmtVND(total);
  }

  async function submitOrder(){
    if(cart.length===0){ alert("Giỏ hàng trống!"); return; }
    const note = document.getElementById("buyerNote").value.trim();
    const plan = document.getElementById("servicePlan").value;
    const byFile = document.getElementById("fileQuote").checked;
    const fileEl = document.getElementById("buyerFile");

    if(!name || !phone){
      alert("Vui lòng nhập Họ tên và Số điện thoại.");
      return;
    }

    let total = cart.reduce((s,it)=> s + (Number(it.price)||0)*it.qty, 0);

    try{
      const fd = new FormData();
      fd.append('action','submitOrder');
      if (API_KEY) fd.append('key', API_KEY);

      fd.append('name', name);
      fd.append('email', email);
      fd.append('phone', phone);
      fd.append('address', address);
      fd.append('note', note);
      fd.append('plan', plan || '');
      fd.append('byFile', byFile ? '1' : '0');
      fd.append('cartJson', JSON.stringify(cart));
      fd.append('total', String(total));

      if (fileEl && fileEl.files && fileEl.files[0]){
        const f = fileEl.files[0];
        fd.append('file', f, f.name);
      }

      const res = await fetch(API_URL, { method:'POST', body: fd });
      const txt = await res.text();
      let json;
      try { json = JSON.parse(txt); }
      catch {
        const cleaned = txt.replace(/^\)\]\}'[^\n]*\n?/, '').replace(/^\uFEFF/, '').trim();
        json = JSON.parse(cleaned);
      }

      if (json && json.ok){
        alert('Đã gửi đơn hàng thành công! Chúng tôi sẽ liên hệ lại sớm.');
        cart.length = 0;
        updateCart();
        // Đóng offcanvas
        try { cartOffcanvas.hide(); } catch {}
      } else {
        alert('Gửi đơn thất bại. Vui lòng thử lại.');
      }
    }catch(err){
      alert('Có lỗi khi gửi đơn: ' + (err && err.message ? err.message : err));
    }
  }

  /* ========================================================================
     EVENTS: CART (delegation)
     ======================================================================== */
  document.addEventListener('click', (ev)=>{
    const btnAdd = ev.target.closest('[data-action="add-to-cart"]');
    if (btnAdd){
      const id = btnAdd.getAttribute('data-id');
      addToCartById(id);
      return;
    }

    const qtyBtn = ev.target.closest('[data-action="qty"]');
    if (qtyBtn){
      const id    = qtyBtn.getAttribute('data-id');
      const delta = parseInt(qtyBtn.getAttribute('data-delta'), 10) || 0;
      changeQty(id, delta);
      return;
    }

    const rmBtn = ev.target.closest('[data-action="remove"]');
    if (rmBtn){
      const id = rmBtn.getAttribute('data-id');
      removeItem(id);
      return;
    }

    const pagePrev = ev.target.closest('[data-action="page-prev"]');
    if (pagePrev){
      if (state.page > 1){ state.page--; fetchPage(); }
      return;
    }
    const pageNext = ev.target.closest('[data-action="page-next"]');
    if (pageNext){
      if (state.page < (state.totalPages||1)){ state.page++; fetchPage(); }
      return;
    }

    const filterTag = ev.target.closest('.filter-tag[data-action="set-filter"]');
    if (filterTag){
      const field = filterTag.getAttribute('data-field');
      const val   = filterTag.getAttribute('data-val') || '';
      state[field] = (state[field] === val) ? '' : val; // toggle chọn/bỏ
      state.page = 1;
      updateFilterCount();
      fetchPage();
      // cập nhật UI active
      document.querySelectorAll(`.filter-tag[data-field="${CSS.escape(field)}"]`).forEach(el=>{
        el.classList.toggle('active', el.getAttribute('data-val') === state[field]);
      });
      return;
    }

    const catItem = ev.target.closest('.category-item[data-action="select-category"]');
    if (catItem){
      const val = catItem.getAttribute('data-val') || '';
      state.category = (state.category === val) ? '' : val;
      state.page = 1;
      document.querySelectorAll('.category-item').forEach(el=>{
        el.classList.toggle('active', el.getAttribute('data-val') === state.category);
      });
      fetchPage();
      return;
    }

    const chip = ev.target.closest('.group-chip[data-action="select-group"]');
    if (chip){
      const v = chip.getAttribute('data-val') || '';
      state.group = (state.group === v) ? '' : v;
      state.page = 1;
      updateGroupUI();
      updateGroupDots();
      fetchPage();
      return;
    }
  });

  /* ========================================================================
     OFFCANVAS, FABs & HEADER
     ======================================================================== */
  const cartOffcanvas      = new bootstrap.Offcanvas('#cartCanvas');
  const filterOffcanvas    = new bootstrap.Offcanvas('#filterPanel');
  const suppliersOffcanvas = new bootstrap.Offcanvas('#suppliersCanvas');

  // FABs
  document.getElementById('cartFab')?.addEventListener('click', ()=> cartOffcanvas.show());
  document.getElementById('filterFab')?.addEventListener('click', ()=> filterOffcanvas.show());
  document.getElementById('suppliersFab')?.addEventListener('click', ()=>{
    suppliersOffcanvas.show();
    if (!window._sup_loaded_once){ window._sup_loaded_once = true; loadSuppliers(); }
  });

  // Header search
  document.getElementById('searchBtn')?.addEventListener('click', ()=>{
    const v = (document.getElementById('searchBox')?.value || '').trim();
    state.q = v; state.page = 1; fetchPage();
  });
  document.getElementById('searchBox')?.addEventListener('keydown', (e)=>{
    if (e.key === 'Enter'){
      const v = (e.target.value || '').trim();
      state.q = v; state.page = 1; fetchPage();
    }
  });

  // Clear filters
  function clearAllFilters(){
    state.type=''; state.loai=''; state.note=''; state.category=''; state.group=''; state.q='';
    const sb=document.getElementById('searchBox'); if(sb) sb.value='';
    updateFilterCount(); state.page=1; fetchPage();
  }
  document.getElementById('clearFiltersBtn')?.addEventListener('click', clearAllFilters);
  document.getElementById('clearFiltersBtn2')?.addEventListener('click', clearAllFilters);

  // Buttons in cart panel
  document.getElementById('clearCartBtn')?.addEventListener('click', clearCart);
  document.getElementById('submitOrderBtn')?.addEventListener('click', submitOrder);

  // External links (Zalo & Ads contact)
  (function(){
    const zalo = document.getElementById('zaloFab');
    if (zalo && window.ZALO_URL){ zalo.href = window.ZALO_URL; }
    const a1 = document.getElementById('adsContactBtn');
    const a2 = document.getElementById('adsContactBtn2');
    if (window.ADS_CONTACT_URL){
      if (a1) a1.href = window.ADS_CONTACT_URL;
      if (a2) a2.href = window.ADS_CONTACT_URL;
    }
  })();

  /* ========================================================================
     BENEFIT MODAL
     ======================================================================== */
  const BENEFIT_DETAIL = {
    b1:{ title:'Tham khảo 10,000+ mẫu sản phẩm', lead:'Kho ý tưởng lớn, cập nhật thường xuyên.', bullets:[
      'Tìm nhanh theo ID, từ khóa',
      'Lọc theo nhóm, loại, chú ý, danh mục',
      'Xem ảnh chất lượng cao, mở link chi tiết'
    ], note:'Miễn phí cho mọi thành viên.'},
    b2:{ title:'500+ nhà cung cấp & xưởng', lead:'Liên kết đa dạng, so sánh giá dễ dàng.', bullets:[
      'Lọc theo địa chỉ, tình trạng website',
      'Xem/đính kèm chứng nhận, tệp năng lực',
      'Sắp xếp theo tên hoặc địa chỉ'
    ], note:'Danh sách cập nhật định kỳ.'},
    b3:{ title:'Hỗ trợ tư vấn sản xuất', lead:'Giải pháp nhanh cho nhiều yêu cầu.', bullets:[
      'Gợi ý kỹ thuật gia công phù hợp',
      'Ước tính chi phí & thời gian',
      'Checklist file in/khắc/đúc'
    ], note:'Miễn phí cơ bản.'},
    b4:{ title:'Thiết kế 2D/3D cho sản xuất', lead:'Mockup rõ ràng, dễ duyệt.', bullets:[
      'Thông số kỹ thuật xuất xưởng',
      'Kiểm tra tính khả thi sản xuất',
      'File preview nhanh'
    ], note:'Miễn phí cho đơn đã chốt.'},
    b5:{ title:'Hậu cần vận chuyển & đóng gói', lead:'Nhanh, chuyên nghiệp.', bullets:[
      'Đóng gói theo tiêu chuẩn',
      'Theo dõi vận đơn',
      'Giao 2 chiều Bắc–Nam'
    ], note:'Có tính phí theo yêu cầu.'},
    b6:{ title:'Hỗ trợ giải quyết tranh chấp', lead:'Bảo vệ quyền lợi khách hàng.', bullets:[
      'Lập biên bản đối soát',
      'Hòa giải với nhà cung cấp',
      'Đưa ra phương án xử lý tối ưu'
    ], note:'Có phí theo từng vụ việc.'},
  };

  (function bindBenefitModal(){
    const modalEl = document.getElementById('benefitModal');
    if (!modalEl) return;
    const modal = new bootstrap.Modal(modalEl);
    const title = document.getElementById('benefitTitle');
    const lead  = document.getElementById('benefitLead');
    const list  = document.getElementById('benefitList');
    const note  = document.getElementById('benefitNote');

    document.querySelectorAll('.bcard[data-benefit]').forEach(card=>{
      card.addEventListener('click', ()=>{
        const id   = card.getAttribute('data-benefit');
        const data = BENEFIT_DETAIL[id] || null;
        if (!data) return;
        title.textContent = data.title || 'Chi tiết';
        lead.textContent  = data.lead || '';
        list.innerHTML    = (data.bullets||[]).map(s=> `<li>${esc(s)}</li>`).join('');
        note.textContent  = data.note || '';
        modal.show();
      });
      // keyboard accessibility
      card.addEventListener('keydown', (e)=>{
        if (e.key === 'Enter' || e.key === ' '){
          e.preventDefault(); card.click();
        }
      });
    });
  })();

  /* ========================================================================
     FETCH & RENDER PRODUCTS
     ======================================================================== */
  function buildParamsFromState(s){
    const o = {
      action:   'list',
      page:     s.page,
      pageSize: s.pageSize,
    };
    if (s.q)        o.q = s.q;
    if (s.group)    o.group = s.group;
    if (s.type)     o.type = s.type;
    if (s.loai)     o.loai = s.loai;
    if (s.note)     o.note = s.note;
    if (s.category) o.category = s.category;
    return o;
  }

  function updateGroupUI(){
    const chips = document.querySelectorAll('#groupBar .group-chip');
    chips.forEach(c=>{
      const v = c.getAttribute('data-val') || '';
      c.classList.toggle('active', v === (state.group||''));
      c.setAttribute('aria-selected', v === (state.group||'') ? 'true' : 'false');
    });
  }

  function renderGrid(items){
    const grid = document.getElementById('productGrid');
    if (!grid) return;
    grid.innerHTML = (items||[]).map(productCardHtml).join('') || `
      <div class="col-12"><div class="text-center text-muted py-5">Không có sản phẩm phù hợp.</div></div>`;
  }

  function renderFacets(json){
    // facets: types, loai, note, groups, categories
    try{
      if (json.facets){
        if (Array.isArray(json.facets.type))  buildFilterBox('typeBox',  json.facets.type,  'type');
        if (Array.isArray(json.facets.loai))  buildFilterBox('loaiBox',  json.facets.loai,  'loai');
        if (Array.isArray(json.facets.note))  buildFilterBox('noteBox',  json.facets.note,  'note');
        if (Array.isArray(json.facets.group)) {
          renderGroups(json.facets.group);
          updateGroupUI();
          updateGroupDots();
        }
        if (Array.isArray(json.facets.category)){
          // nếu muốn đồng bộ icon theo danh sách facet, có thể merge vào CATEGORY_ICONS ở đây
          // hiện tại dùng CAT_CONFIG tĩnh đã hiển thị sẵn
        }
      }
    }catch(e){ console.warn('[facets] render warn', e); }
  }

  async function fetchPage(){
    const grid = document.getElementById('productGrid');
    const totalEl = document.getElementById('totalCount');
    try{
      if (grid){
        grid.innerHTML = `
          <div class="col-12">
            <div class="d-flex align-items-center justify-content-center gap-2 p-4 text-muted">
              <div class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></div>
              <span>Đang tải dữ liệu…</span>
            </div>
          </div>`;
      }

      const params = new URLSearchParams(buildParamsFromState(state));
      const url = API_URL + '?' + params.toString();
      const resp = await fetch(url, { redirect:'follow', mode:'cors' });
      const txt  = await resp.text();

      let json;
      try { json = JSON.parse(txt); }
      catch {
        const cleaned = txt
          .replace(/^\)\]\}'[^\n]*\n?/, '')  // strip XSSI prefix
          .replace(/^\uFEFF/, '')            // strip BOM
          .trim();
        json = JSON.parse(cleaned);
      }

      if (!json || json.ok === false || !Array.isArray(json.items)) {
        throw new Error('Bad JSON schema or empty data');
      }

      // render
      renderGrid(json.items);
      renderFacets(json);

      const found = Number(json.total||json.items.length||0);
      if (totalEl) totalEl.textContent = String(found);

      // pagination
      const pageSize = Number(json.pageSize || state.pageSize || 36);
      renderPagination(found, pageSize, Number(json.page || state.page || 1));
    }catch(err){
      if (grid) grid.innerHTML = `<div class="col-12"><div class="text-danger text-center p-4">Không tải được dữ liệu.</div></div>`;
      window._showError && window._showError('API: '+ (err && err.message ? err.message : err));
    }
  }

  /* ========================================================================
     INIT
     ======================================================================== */
  function init(){
    try {
      renderCategoriesFromConfig();
      updateFilterCount();
      fetchPage();
      fetchAds();

      // Pager bottom container class
      const pagerBottom = document.getElementById('pagerBottom');
      if (pagerBottom) pagerBottom.classList.add('d-flex','justify-content-center','align-items-center','gap-2');

      // Khi đổi kích thước cửa sổ, cập nhật lại mũi tên group/category
      setTimeout(()=>{ 
        try{ updateGroupDots(); updateGroupArrows && updateGroupArrows(); }catch{}
      }, 600);

      bindSupplierFilters();
    } catch (e){
      window._showError && window._showError('INIT: '+ (e && e.message ? e.message : e));
    }
  }

  document.addEventListener('DOMContentLoaded', init);
  </script>
  <script>
(function(){
  const box = document.querySelector('#adsBox');
  if (!box) return;

  // Bảo đảm các phần tử con tồn tại
  let list = box.querySelector('#adsList');
  if (!list) {
    list = document.createElement('div');
    list.id = 'adsList';
    list.className = 'd-flex flex-column gap-2';
    box.appendChild(list);
  }
  let empty = box.querySelector('#adsEmpty');
  if (!empty) {
    empty = document.createElement('div');
    empty.id = 'adsEmpty';
    empty.className = 'small text-muted';
    empty.textContent = '(debug) Box đã hiển thị – chờ dữ liệu quảng cáo.';
    list.after(empty);
  }
  let badge = box.querySelector('#adsCount');
  if (!badge) {
    badge = document.createElement('span');
    badge.id = 'adsCount';
    badge.className = 'badge rounded-pill text-bg-primary';
    badge.style.display = 'none';
    badge.textContent = '0';
    (box.querySelector('h6') || box).appendChild(badge);
  }

  // Ép hiển thị box
  box.style.removeProperty('display');
  box.style.removeProperty('visibility');
  box.style.opacity = '1';

  // Helper escape
  const ESC = s => String(s ?? '').replace(/[&<>"']/g, m => ({
    '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
  }[m]));

  function render(items = []) {
    list.innerHTML = items.map(it => `
      <a class="link-preview d-flex gap-2 align-items-start" href="${ESC(it.url||'#')}" target="_blank" rel="noopener">
        <img class="thumb" src="${ESC(it.img||'https://placehold.co/64x64?text=%20')}"
             alt="${ESC(it.title||'')}"
             onerror="this.src='https://placehold.co/64x64?text=%20'">
        <div class="flex-grow-1 small">
          <div class="title text-truncate">${ESC(it.title||'')}</div>
          <div class="desc text-truncate">${ESC(it.desc||'')}</div>
          <div class="site">${location.hostname}</div>
        </div>
      </a>
    `).join('');

    empty.style.display = items.length ? 'none' : '';
    if (badge) {
      badge.textContent = items.length;
      badge.style.display = items.length ? 'inline-block' : 'none';
    }
  }

  async function load(){
    try {
      const acts = ['adsList','sponsors','partners'];
      for (const act of acts) {
        const url = `?action=${encodeURIComponent(act)}`;
        const res = await fetch(url).then(r => r.ok ? r.json() : null).catch(() => null);
        if (res?.items?.length) {
          render(res.items);
          return;
        }
      }
      // Fallback demo
      render([
        { title:'Xưởng DEMO 1', url:'#', img:'https://picsum.photos/80', desc:'Đúc – mạ – khắc laser' },
        { title:'Xưởng DEMO 2', url:'#', img:'https://picsum.photos/81', desc:'In UV kim loại/nhựa' },
        { title:'Xưởng DEMO 3', url:'#', img:'https://picsum.photos/82', desc:'Cao su đúc 2D/3D' }
      ]);
    } catch(e) {
      console.warn('[ADS] load error', e);
      render([]);
    }
  }

  // Expose global cho nơi khác gọi
  window.renderAds = render;
  window.fetchAds  = load;

  // Chặn việc bị script khác xóa nội dung
  new MutationObserver(muts => {
    if (Array.from(muts).some(m => m.type === 'childList' && !list.children.length)) {
      console.warn('[ADS] #adsList bị clear, load lại…');
      load();
    }
  }).observe(list, { childList:true });

  // Gọi lần đầu
  setTimeout(load, 500);
})();
</script>

</body>
</html>

