<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>2606AI Marketplace</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root{ --main:#0018a8; --bg:#f5f6fa; }
    body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Be Vietnam Pro",sans-serif;background:var(--bg);font-size:14px;padding-top:70px}
    .container-fluid{max-width:1400px;margin:auto}
    .top-banner{background:#000;color:#fff;text-align:center;padding:6px;font-weight:600}
    .site-header{background:#fff;padding:10px 15px;border-bottom:1px solid #eee;
      display:flex;align-items:center;justify-content:space-between;position:fixed;top:0;left:0;right:0;height:70px;z-index:10}
    .brand-title{font-weight:800;color:var(--main)}
    .hero img{width:100%;height:300px;object-fit:cover;border-radius:8px}
    .sidebar-box{background:#fff;border-radius:8px;padding:12px;margin-bottom:12px}
    .category-item{padding:10px;border-radius:8px;text-align:center;background:#fff}
    .cardx{background:#fff;border-radius:12px;box-shadow:0 2px 6px rgba(0,0,0,.08);overflow:hidden;display:flex;flex-direction:column}
    .cardx img.thumb{width:100%;height:180px;object-fit:cover}
    #cartSidebar{position:fixed;top:0;right:-400px;width:350px;height:100%;background:#fff;box-shadow:-3px 0 10px rgba(0,0,0,.2);transition:right .3s;z-index:20;padding:15px;overflow:auto}
    #cartSidebar.open{right:0}
    /* Overlay ch·∫©n ƒëo√°n l·ªói */
    #errbox{position:fixed;bottom:8px;left:8px;right:8px;background:#ffefef;border:1px solid #e99;padding:8px;border-radius:8px;z-index:9999;display:none;white-space:pre-wrap;font-family:ui-monospace,Consolas,monospace}
  </style>
</head>
<body>
  <div class="top-banner">∆Øu ƒë√£i th√°ng n√†y cho kh√°ch ƒë·∫∑t qua 2606ai.vn</div>

  <div class="site-header">
    <div class="d-flex align-items-center gap-2">
      <img src="https://drive.google.com/uc?export=view&id=1jXc4uRzVs6G9Tjryffg5tT98nFFeRF4Z" alt="2606AI logo" style="height:45px">
      <span class="brand-title">2606AI Marketplace</span>
    </div>
    <div class="d-flex gap-2">
      <button id="filterBtn" class="btn btn-outline-secondary" data-bs-toggle="offcanvas" data-bs-target="#filterPanel">‚öôÔ∏è B·ªô l·ªçc</button>
      <button id="cartBtn" class="btn btn-outline-dark">üõí Gi·ªè h√†ng <span id="cartCount">0</span></button>
    </div>
  </div>

  <div class="container-fluid my-3">
    <div class="row">
      <div class="col-lg-3 col-md-4">
        <div class="sidebar-box">
          <h6 class="fw-bold">Quy·ªÅn l·ª£i</h6>
          <ul class="small mb-0">
            <li>‚ö° B√°o gi√° nhanh 24h</li>
            <li>üé® Thi·∫øt k·∫ø mi·ªÖn ph√≠</li>
            <li>‚úÖ QC 2 l·ªõp</li>
            <li>üöö Giao h√†ng to√†n qu·ªëc</li>
          </ul>
        </div>
        <div class="sidebar-box">
          <h6 class="fw-bold mb-2">X∆∞·ªüng ƒë·ªÅ xu·∫•t</h6>
          <div id="factoryList" class="small text-muted">ƒêang t·∫£i...</div>
        </div>
      </div>

      <div class="col-lg-9 col-md-8">
        <div class="hero row g-2 mb-2">
          <div class="col-md-8"><img src="https://picsum.photos/800/300?random=1" alt=""></div>
          <div class="col-md-4 d-flex flex-column gap-2">
            <img src="https://picsum.photos/400/145?random=2" alt="">
            <img src="https://picsum.photos/400/145?random=3" alt="">
          </div>
        </div>

        <div class="p-2 bg-white rounded mb-3">
          <h6 class="fw-bold mb-2">DANH M·ª§C S·∫¢N PH·∫®M</h6>
          <div id="categoryGrid" class="row row-cols-3 row-cols-md-6 g-2"></div>
        </div>

        <div class="input-group mb-3">
          <span class="input-group-text bg-primary text-white">üîç</span>
          <input id="searchBox" class="form-control" placeholder="T√¨m s·∫£n ph·∫©m... (ID, m√¥ t·∫£)">
          <button id="searchBtn" class="btn btn-primary">T√¨m</button>
        </div>

        <div id="productGrid" class="row row-cols-2 row-cols-md-3 row-cols-lg-6 g-2"></div>

        <div class="d-flex justify-content-between mt-2">
          <button id="prevBtn" class="btn btn-outline-secondary">‚Üê Tr∆∞·ªõc</button>
          <button id="nextBtn" class="btn btn-outline-secondary">Sau ‚Üí</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Gi·ªè h√†ng -->
  <div id="cartSidebar">
    <h5>Gi·ªè h√†ng</h5>
    <div id="cartList"></div>
    <div class="d-flex justify-content-between fw-bold my-2"><span>T·ªïng c·ªông</span><span id="cartTotal">0 ƒë</span></div>
    <button class="btn btn-danger w-100 mb-2" id="clearCartBtn">X√≥a to√†n b·ªô</button>
    <div>
      <input id="buyerName" class="form-control mb-2" placeholder="H·ªç v√† t√™n">
      <input id="buyerEmail" class="form-control mb-2" placeholder="Email">
      <input id="buyerPhone" class="form-control mb-2" placeholder="S·ªë ƒëi·ªán tho·∫°i">
      <input id="buyerAddress" class="form-control mb-2" placeholder="ƒê·ªãa ch·ªâ nh·∫≠n h√†ng">
      <textarea id="buyerNote" class="form-control mb-2" placeholder="Ghi ch√∫"></textarea>
      <button class="btn btn-success w-100" id="submitOrderBtn">G·ª≠i ƒë∆°n h√†ng</button>
    </div>
  </div>

  <!-- Offcanvas Filter -->
  <div class="offcanvas offcanvas-end" tabindex="-1" id="filterPanel">
    <div class="offcanvas-header">
      <h5>B·ªô l·ªçc n√¢ng cao</h5>
      <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body">
      <h6>TYPE</h6><div id="typeBox" class="mb-3"></div>
      <h6>LO·∫†I S·∫¢N PH·∫®M</h6><div id="loaiBox" class="mb-3"></div>
      <h6>CH√ö √ù</h6><div id="noteBox" class="mb-3"></div>
    </div>
  </div>

  <div id="errbox"></div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" defer></script>
  <script>
  // ===== Hi·ªÉn th·ªã l·ªói ra m√†n h√¨nh ƒë·ªÉ tr√°nh tr·∫Øng trang =====
  (function(){
    const box = document.getElementById('errbox');
    function show(msg){
      box.style.display='block';
      box.textContent = '[ERROR] ' + msg;
      console.error(msg);
    }
    window.addEventListener('error', e => show(e.message + (e.filename?(' @ '+e.filename+':'+e.lineno):'')));
    window.addEventListener('unhandledrejection', e => show('Promise rejected: ' + (e.reason && e.reason.message ? e.reason.message : e.reason)));
  })();

  // ===== App =====
  const API_URL = "https://script.google.com/macros/s/AKfycbz-P3biIvSq1FYSt5I4T6tLYtv5mggIwRR3ug1FIUSbuZe6HMkLazUlbRyM1IW7LxH6/exec";

  const state = { page:1, pageSize:36, q:'', group:'', type:'', loai:'', note:'', category:'' };
  const cart = []; const products = {};

  const fmtVND = n => (Number(n)||0).toLocaleString('vi-VN') + ' ƒë';
  const esc = s => (s??'').toString().replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));

  function badgeColor(txt){
    if(!txt) return "#555";
    const t = txt.toLowerCase();
    if(t.includes("m·∫´u")||t.includes("sample")) return "#4caf50";
    if(t.includes("gi·∫£m")||t.includes("sale")||t.includes("km")) return "#ff9800";
    if(t.includes("g·∫•p")||t.includes("urgent")) return "#d32f2f";
    return "#555";
  }

  function productCardHtml(it){
    products[it.id]=it;
    return `<div class="col"><div class="cardx">
      ${it.note?`<span class="position-absolute badge text-bg-danger" style="left:8px;top:8px;background:${badgeColor(it.note)}">${esc(it.note)}</span>`:''}
      <a href="${esc(it.linkFull || it.img)}" target="_blank" rel="noopener">
        <img class="thumb" src="${esc(it.img)}" alt="${esc(it.id)}" onerror="this.src='https://via.placeholder.com/300x300?text=No+Image'">
      </a>
      <div class="p-2 d-flex flex-column">
        <div class="fw-semibold" style="color:#0018a8">${esc(it.id)}</div>
        <div class="badge text-bg-light align-self-start mb-1">${esc(it.type||'')}</div>
        <div class="text-muted small flex-grow-1">${esc(it.details||'')}</div>
        <div class="fw-bold" style="color:#d32f2f">${fmtVND(it.price)}</div>
        <button class="btn btn-sm btn-primary align-self-end mt-1" data-action="add" data-id="${esc(it.id)}">Th√™m</button>
      </div>
    </div></div>`;
  }

  function render(res){
    const grid=document.getElementById('productGrid');
    if(!res||!res.items||res.items.length===0){
      grid.innerHTML='<div class="text-muted">Kh√¥ng c√≥ s·∫£n ph·∫©m.</div>';
    }else{
      grid.innerHTML=res.items.map(productCardHtml).join('');
    }
    const facets=res&&res.facets?res.facets:{};
    buildCategory(facets.groups||[]);
    buildFilterBox('typeBox',facets.types||[],'type');
    buildFilterBox('loaiBox',facets.loais||[],'loai');
    buildFilterBox('noteBox',facets.notes||[],'note');
  }

  function fetchPage(){
    const params=new URLSearchParams({
      action:'list',page:state.page,pageSize:state.pageSize,
      q:state.q,group:state.group,type:state.type,loai:state.loai,note:state.note,category:state.category
    });
    fetch(API_URL+'?'+params.toString())
      .then(r=>r.json())
      .then(render)
      .catch(err=>{ throw err; });
  }

  function buildCategory(items){
    const grid=document.getElementById('categoryGrid');
    grid.innerHTML=(items||[]).map(v=>`
      <div class="col">
        <div class="category-item" data-action="cat" data-val="${esc(v)}">${esc(v||'Kh√°c')}</div>
      </div>`).join('');
  }
  function buildFilterBox(boxId,items,field){
    const box=document.getElementById(boxId);
    box.innerHTML=(items||[]).map(v=>`
      <button class="btn btn-sm btn-outline-secondary me-1 mb-1" data-action="flt" data-field="${field}" data-val="${esc(v)}">${esc(v)}</button>
    `).join('');
  }

  // Cart
  function updateCart(){
    document.getElementById('cartCount').textContent = cart.reduce((a,b)=>a+b.qty,0);
    const list=document.getElementById('cartList'); let total=0;
    list.innerHTML=cart.map(it=>{
      const sub=it.qty*(Number(it.price)||0); total+=sub;
      return `<div class="d-flex align-items-center border-bottom py-2">
        <img src="${esc(it.img)}" width="50" height="50" class="me-2" style="object-fit:cover">
        <div class="flex-grow-1">
          <div class="fw-semibold small">${esc(it.details||it.id)}</div>
          <div class="small text-muted">${fmtVND(it.price)}</div>
        </div>
        <div class="d-flex align-items-center gap-1">
          <button class="btn btn-sm btn-outline-secondary" data-action="qty" data-id="${esc(it.id)}" data-d="-1">-</button>
          <span>${it.qty}</span>
          <button class="btn btn-sm btn-outline-secondary" data-action="qty" data-id="${esc(it.id)}" data-d="1">+</button>
        </div>
        <div style="min-width:80px" class="text-end ms-2">${fmtVND(sub)}</div>
        <button class="btn btn-sm btn-link text-danger" data-action="rm" data-id="${esc(it.id)}">&times;</button>
      </div>`;
    }).join('');
    document.getElementById('cartTotal').textContent=fmtVND(total);
  }
  function openCart(){ document.getElementById('cartSidebar').classList.add('open'); }

  // Submit order
  function submitOrder(){
    if(cart.length===0){ alert('Gi·ªè h√†ng tr·ªëng!'); return; }
    const name=document.getElementById('buyerName').value.trim();
    const email=document.getElementById('buyerEmail').value.trim();
    const phone=document.getElementById('buyerPhone').value.trim();
    const address=document.getElementById('buyerAddress').value.trim();
    const note=document.getElementById('buyerNote').value.trim();
    if(!name||!email||!phone||!address){ alert('Vui l√≤ng nh·∫≠p ƒë·ªß th√¥ng tin'); return; }
    const order={
      customer:{name,email,phone,address,note},
      items:cart.map(({id,details,type,price,qty,img,linkFull,group,loai,category,note})=>({id,details,type,price,qty,img,linkFull,group,loai,category,note})),
      total:cart.reduce((a,b)=>a+b.qty*(Number(b.price)||0),0)
    };
    fetch(API_URL,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({action:'order',email:'lehaidangem836@gmail.com',data:order})
    }).then(r=>r.json()).then(res=>{
      if(res && (res.ok || res.success)){ alert('ƒê√£ g·ª≠i ƒë∆°n h√†ng!'); cart.length=0; updateCart(); }
      else alert('G·ª≠i ƒë∆°n h√†ng th·∫•t b·∫°i');
    }).catch(err=>{ throw err; });
  }

  // Events
  document.addEventListener('click',e=>{
    const el=e.target;

    if(el.matches('#searchBtn')){
      state.q=document.getElementById('searchBox').value.trim(); state.page=1; fetchPage();
    }
    if(el.matches('#prevBtn')){ if(state.page>1){state.page--; fetchPage();} }
    if(el.matches('#nextBtn')){ state.page++; fetchPage(); }

    if(el.matches('#cartBtn')) openCart();
    if(el.matches('#clearCartBtn')){ if(confirm('Xo√° to√†n b·ªô gi·ªè?')){ cart.length=0; updateCart(); } }
    if(el.matches('#submitOrderBtn')) submitOrder();

    if(el.closest('[data-action="cat"]')){ state.group = el.closest('[data-action="cat"]').dataset.val || ''; state.page=1; fetchPage(); }
    if(el.matches('[data-action="flt"]')){ state[el.dataset.field] = el.dataset.val || ''; state.page=1; fetchPage(); }

    if(el.matches('[data-action="add"]')){ 
      const id=el.dataset.id; const it=products[id];
      if(it){ const f=cart.find(p=>p.id===id); if(f) f.qty++; else cart.push({...it,qty:1}); updateCart(); openCart(); }
    }
    if(el.matches('[data-action="qty"]')){ 
      const id=el.dataset.id, d=Number(el.dataset.d||0);
      const it=cart.find(p=>p.id===id); if(!it) return; it.qty+=d; if(it.qty<=0) cart.splice(cart.indexOf(it),1); updateCart();
    }
    if(el.matches('[data-action="rm"]')){ 
      const id=el.dataset.id; const i=cart.findIndex(p=>p.id===id); if(i>=0) cart.splice(i,1); updateCart();
    }
  });

  // Kh·ªüi ch·∫°y
  (function boot(){
    // demo factories
    document.getElementById('factoryList').innerHTML =
      ['X∆∞·ªüng A','X∆∞·ªüng B','X∆∞·ªüng C'].map(n=>`<div>${n}</div>`).join('');
    fetchPage();
  })();
  </script>
</body>
</html>
