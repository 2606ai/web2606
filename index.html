<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>PCGbrand - Thiết kế & Mua trực tiếp</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;600;700;800&display=swap" rel="stylesheet">

<style>
  :root{
    --main:#0018a8;
    --accent:#d4af37;
    --bg:#f5f6fa;
    --border:#e9e9ee;
  }
  body{font-family:'Be Vietnam Pro',sans-serif;background:var(--bg);color:#222;font-size:14px}
  .container-xl{max-width:1320px}
  /* ... giữ nguyên phần CSS như bạn đã viết ... */
</style>
</head>
<body>
<!-- ===== Banner, Navbar, Hero, Sidebar, Product Grid, Footer giữ nguyên như code của bạn ===== -->

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
/* ---------- CONFIG API ---------- */
const API_URL = "https://script.google.com/macros/s/AKfycbyp8hH9seYgTW_H59pcR4OpvdQbpLhH9F67oYvOQoUpDsjYsemNDgel2sMameaxTdKy/exec";

/* ---------- STATE ---------- */
const state={page:1,pageSize:15,q:'',group:''};

/* ---------- UTILS ---------- */
const fmtVND = n => (Number(n)||0).toLocaleString('vi-VN') + ' đ';
function hiRes(url,w=600){return (url||'').replace(/=s\d+/,'=s'+w);}
function esc(s){return (s??'').toString().replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}

/* ---------- FACTORIES ---------- */
const FACTORIES = [
  { name:'Xưởng 1 – Tem kim loại', desc:'Men màu, mạ vàng, đúc nổi 3D', logo:'https://picsum.photos/80?random=41', href:'https://temkimloai.nhanmac3a.vn/huy-hieu' },
  { name:'Xưởng 2 – In UV', desc:'In UV độ bền cao, chi tiết sắc nét', logo:'https://picsum.photos/80?random=42', href:'https://example.com/in-uv' },
  { name:'Xưởng 3 – Đúc huy hiệu', desc:'Đúc nổi 3D, mạ màu cao cấp', logo:'https://picsum.photos/80?random=43', href:'https://example.com/duc-huy-hieu' },
  { name:'Xưởng 4 – In offset', desc:'Bao bì – hộp – catalogue', logo:'https://picsum.photos/80?random=44', href:'https://example.com/in-offset' },
  { name:'Xưởng 5 – Quà tặng', desc:'Quà doanh nghiệp/ sự kiện', logo:'https://picsum.photos/80?random=45', href:'https://example.com/qua-tang' },
];
function renderFactories(){
  const box=document.getElementById('factoryList'); if(!box) return;
  box.innerHTML=FACTORIES.map(f=>`
    <div class="factory-item">
      <div class="factory-logo"><img src="${f.logo}" alt=""></div>
      <div class="factory-body">
        <div class="factory-name">${esc(f.name)}</div>
        <div class="factory-desc">${esc(f.desc)}</div>
      </div>
      <div class="factory-cta"><a href="${esc(f.href)}" target="_blank">Xem</a></div>
    </div>
  `).join('');
}

/* ---------- CART ---------- */
let cart=[];
function saveCart(){localStorage.setItem('pcg_cart',JSON.stringify(cart));updateCartUI();}
function loadCart(){cart=JSON.parse(localStorage.getItem('pcg_cart')||'[]'); updateCartUI();}
function updateCartUI(){
  const box=document.getElementById('cartListSide');
  const countEl=document.getElementById('cartCount');
  if(!cart.length){box.innerHTML='Chưa có sản phẩm.'; countEl.textContent='0';}
  else{
    box.innerHTML=cart.map((it,i)=>`
      <div class="cart-item">
        <img src="${esc(it.img)}">
        <div class="meta">
          <div>${esc(it.id)}</div>
          <div class="text-muted small">${esc(it.details||'')}</div>
          <div>${fmtVND(it.price)} × ${it.qty}</div>
        </div>
        <div class="act d-flex align-items-center gap-1">
          <button data-dec="${i}">-</button>
          <span>${it.qty}</span>
          <button data-inc="${i}">+</button>
          <button class="rm" data-rm="${i}" title="Xóa">✕</button>
        </div>
      </div>`).join('');
    const totalQty = cart.reduce((s,it)=>s+it.qty,0);
    countEl.textContent = String(totalQty);
  }
  document.getElementById('cartTotalSide').textContent =
    fmtVND(cart.reduce((s,it)=>s+(Number(it.price)||0)*it.qty,0));
}
document.getElementById('cartListSide').addEventListener('click',e=>{
  const inc=e.target.closest('[data-inc]'), dec=e.target.closest('[data-dec]'), rm=e.target.closest('[data-rm]');
  if(inc){ cart[inc.dataset.inc].qty++; saveCart(); }
  if(dec){ const i=dec.dataset.dec; cart[i].qty--; if(cart[i].qty<=0) cart.splice(i,1); saveCart(); }
  if(rm){ cart.splice(rm.dataset.rm,1); saveCart(); }
});

/* ---------- CATEGORY ---------- */
let builtCategories=false;
function buildCategoriesOnce(groups){
  if(builtCategories) return;
  const box=document.getElementById('categoryBox'); if(!box) return;
  const all=`<button class="cat-btn ${!state.group?'active':''}" data-group="">Tất cả</button>`;
  const btns=(groups||[]).map(g=>{
    const val=(g||'').trim();
    const act=(state.group||'').toLowerCase()===val.toLowerCase()?'active':'';
    return `<button class="cat-btn ${act}" data-group="${esc(val)}">${esc(val)}</button>`;
  }).join('');
  box.innerHTML=all+btns;
  box.addEventListener('click',e=>{
    const btn=e.target.closest('.cat-btn'); if(!btn) return;
    state.group=(btn.dataset.group||'').trim();
    box.querySelectorAll('.cat-btn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    state.page=1; fetchPage();
  });
  builtCategories=true;
}

/* ---------- SKELETON ---------- */
function renderSkeleton(n){
  const grid=document.getElementById('productGrid');
  grid.innerHTML = Array.from({length:n}).map(()=>`
    <div class="cardx">
      <div class="thumb" style="background:#eee;animation:pulseSk 1.2s infinite;"></div>
      <div class="meta">
        <div class="id" style="height:12px;background:#eee;border-radius:4px"></div>
        <div class="details" style="height:10px;background:#f3f3f3;border-radius:4px;margin-top:6px"></div>
        <div class="row-meta mt-1">
          <div class="price" style="height:12px;background:#eee;border-radius:4px;width:80px"></div>
          <div class="add-btn" style="background:#e0e0e0;color:#e0e0e0">+</div>
        </div>
      </div>
    </div>`).join('');
}

/* ---------- DATA FETCH ---------- */
function fetchPage(){
  renderSkeleton(state.pageSize);
  fetch(`${API_URL}?action=list&page=${state.page}&pageSize=${state.pageSize}&q=${encodeURIComponent(state.q||'')}&group=${encodeURIComponent(state.group||'')}`)
    .then(r=>r.json())
    .then(res=>{ render(res); })
    .catch(err=>{
      console.error(err);
      render({items:[],facets:{groups:[]},page:1,pageSize:state.pageSize,total:0});
    });
}

/* ---------- PRODUCT CARD ---------- */
function productCardHtml(it){
  const img=hiRes(it.img,600);
  const full=it.full||img;
  return `
    <div class="cardx" data-full="${esc(full)}">
      ${it.chuy ? `<span class="note-badge">${esc(it.chuy)}</span>` : ``}
      <img class="thumb" src="${img}" loading="lazy"
           onerror="this.src='https://via.placeholder.com/600x600?text=No+Image'">
      <div class="meta">
        <div class="id">${esc(it.id)}</div>
        <div class="details" title="${esc(it.details)}">${esc(it.details)}</div>
        <div class="type-badge">${esc(it.type||'')}</div>
        <div class="row-meta mt-1">
          <div class="price">${fmtVND(it.price)}</div>
          <button class="add-btn" title="Thêm"
            data-add='${JSON.stringify(it).replace(/'/g,"&apos;")}'>+</button>
        </div>
      </div>
    </div>`;
}
function render(res){
  if(res?.facets?.groups) buildCategoriesOnce(res.facets.groups);
  const grid=document.getElementById('productGrid');
  grid.innerHTML = (res.items||[]).map(it=>productCardHtml(it)).join('') || '<div class="text-muted">Không có sản phẩm.</div>';
}

/* ---------- EVENTS ---------- */
document.getElementById('productGrid').addEventListener('click',e=>{
  const addBtn=e.target.closest('.add-btn');
  if(addBtn){
    e.preventDefault();
    const it=JSON.parse(addBtn.dataset.add.replace(/&apos;/g,"'"));
    const f=cart.find(x=>x.id===it.id);
    if(f) f.qty+=1; else cart.push({id:it.id,details:it.details,type:it.type,price:Number(it.price)||0,img:it.img,qty:1});
    saveCart(); return;
  }
  const card=e.target.closest('.cardx'); if(card){ const full=card.dataset.full; if(full) window.open(full,'_blank'); }
});
document.getElementById('prevBtn').onclick=()=>{ if(state.page>1){state.page--; fetchPage();} };
document.getElementById('nextBtn').onclick=()=>{ state.page++; fetchPage(); };
document.getElementById('searchBtn').onclick=()=>{ state.q=document.getElementById('searchBox').value.trim(); state.page=1; fetchPage(); };
document.getElementById('searchBox').addEventListener('keypress',e=>{ if(e.key==='Enter'){ state.q=e.target.value.trim(); state.page=1; fetchPage(); }});
document.getElementById('clearBtnSide').onclick=()=>{ if(confirm('Xóa toàn bộ giỏ hàng?')){cart=[];saveCart();} };
document.getElementById('sendBtnSide').onclick=()=>{
  if(cart.length===0){ alert('Giỏ hàng trống.'); return; }
  const customer={
    name:document.getElementById('custNameSide').value.trim(),
    phone:document.getElementById('custPhoneSide').value.trim(),
    address:document.getElementById('custAddressSide').value.trim(),
    email:document.getElementById('custEmailSide').value.trim(),
    note:document.getElementById('custNoteSide').value.trim()
  };
  if(!customer.name || !customer.phone){ alert('Vui lòng nhập Họ tên và Số điện thoại.'); return; }
  const order={cart,total:cart.reduce((s,it)=>s+(Number(it.price)||0)*it.qty,0),customer};
  const btn=document.getElementById('sendBtnSide');
  btn.disabled=true; btn.textContent='Đang gửi...';
  fetch(API_URL,{
    method:'POST',
    headers:{'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8'},
    body:`action=order&order=${encodeURIComponent(JSON.stringify(order))}`
  })
  .then(r=>r.json())
  .then(res=>{
    alert(res?.message || 'Đã gửi yêu cầu mua hàng.');
    cart=[]; saveCart();
    btn.disabled=false; btn.textContent='GỬI YÊU CẦU MUA HÀNG';
  })
  .catch(err=>{
    alert('Gửi thất bại: '+ (err?.message||err));
    btn.disabled=false; btn.textContent='GỬI YÊU CẦU MUA HÀNG';
  });
};

/* ---------- INIT ---------- */
document.addEventListener('DOMContentLoaded', () => {
  renderFactories();
  loadCart();
  fetchPage();
});
</script>
</body>
</html>
