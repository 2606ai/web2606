<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>2606AI ‚Äì Lite</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
<style>
/* =====================================
   2606AI LITE ‚Äì styles t·ªëi gi·∫£n, g·ªçn g√†ng
   ===================================== */
:root{
  --main:#e91e63;             /* h·ªìng ch·ªß ƒë·∫°o */
  --main-600:#d81b60;
  --bg:#f5f6fa;
  --text:#1f2937;
  --muted:#6b7280;
  --card:#fff;
  --border:#e7ecf7;
  --grad:linear-gradient(90deg,#ff5aa7 0%,#ff8bd1 100%);
  --shadow-sm:0 1px 2px rgba(0,0,0,.06);
  --shadow-md:0 2px 8px rgba(0,0,0,.08);
}
html,body{height:100%}
body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial; font-size:14px; color:var(--text); background:var(--bg); padding-top:70px}
img{max-width:100%;display:block}
.container-fluid,.wrap{max-width:1200px;margin:0 auto}

/* Header */
.site-header{position:fixed; inset:0 0 auto 0; z-index:1055; background:#fff; border-bottom:1px solid #eee; box-shadow:var(--shadow-sm); padding:10px 15px}
.site-header .wrap{display:flex;align-items:center;gap:12px}
.site-header .logo{width:84px;aspect-ratio:3/2;object-fit:contain}
.header-search .form-control{font-size:13px;padding:6px 10px}

/* Top banner */
.top-banner{position:sticky; top:70px; z-index:1020; height:32px; display:flex; align-items:center; justify-content:center; color:#fff; background:var(--grad); font-weight:700; overflow:hidden}
.top-banner .marquee{white-space:nowrap; animation:marq 40s linear infinite}
@keyframes marq{0%{transform:translateX(100%)}100%{transform:translateX(-100%)}}

/* Sidebar box */
.sidebar-box{background:var(--card); border:1px solid var(--border); border-radius:12px; padding:12px; box-shadow:var(--shadow-sm); margin-bottom:12px}
.sidebar-box h6{font-weight:700;font-size:15px;margin-bottom:8px}

/* Benefits (6) */
.benefits .grid{display:grid;grid-template-columns:1fr;gap:8px}
.benefits .item{background:#fff;border:1px solid var(--border);border-radius:12px;padding:12px;display:flex;gap:10px;align-items:center;box-shadow:var(--shadow-sm)}
.benefits .item .ic{width:36px;height:36px;border-radius:8px;background:#f1f4ff;display:inline-flex;align-items:center;justify-content:center}
.benefits .item .ttl{font-weight:600;font-size:13px}
.benefits .item .sub{font-size:12px;color:var(--muted)}


   
/* Group chips + Category grid */
.category-box{background:#fff;border:1px solid var(--border);border-radius:12px;padding:10px;box-shadow:var(--shadow-sm)}
.group-bar{display:flex;gap:8px;overflow:auto;scrollbar-width:none}
.group-bar::-webkit-scrollbar{display:none}
.group-chip{display:flex;align-items:center;gap:8px;padding:10px 12px;border:1px solid var(--border);border-radius:12px;background:#fff;font-weight:600;color:var(--main);cursor:pointer;transition:.15s}
.group-chip img{width:28px;height:28px;object-fit:contain}
.group-chip:hover{background:#fff0f6;border-color:var(--main)}
.group-chip.active{background:var(--grad);color:#fff;border-color:transparent;box-shadow:var(--shadow-md)}

.category-grid{display:grid;grid-template-columns:repeat(6,1fr);grid-template-rows:repeat(2,auto);gap:12px}
.category-item{display:block;text-align:center;padding:8px;border-radius:10px;border:1px solid transparent;cursor:pointer}
.category-item:hover{background:#f8f9ff}
.category-item.active{background:#fff0f6;border-color:#ffcde1}
.category-item .icon{width:56px;height:56px;border-radius:14px;background:#f2f6ff;display:inline-flex;align-items:center;justify-content:center;margin:0 auto 6px}
.category-item .icon img{width:32px;height:32px;object-fit:contain}
.category-item .label{font-size:12px;color:#111}

/* Stats + pager */
.stats-row{display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap;margin-bottom:8px}
.found-count{display:flex;align-items:center;gap:6px}
.pager .btn{padding:.35rem .6rem; font-size:.875rem; border-radius:.25rem}

/* Product card */
.cardx{border:none;border-radius:12px;background:#fff;overflow:hidden;box-shadow:var(--shadow-sm);transition:.12s;height:100%;display:flex;flex-direction:column}
.cardx:hover{transform:translateY(-2px);box-shadow:var(--shadow-md)}
.cardx .thumb{width:100%;height:170px;object-fit:cover;background:#fff}
.cardx .note{position:absolute;top:8px;right:8px;padding:2px 6px;border-radius:999px;font-size:10px;color:#fff;background:#555}
.cardx .meta{padding:10px;display:flex;flex-direction:column;gap:6px;flex:1}
.cardx .id{font-weight:700;color:var(--main);font-size:13px;line-height:1.2}
.cardx .details{font-size:12px;color:#666;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
.cardx .type{display:inline-block;background:#e0f0ff;color:#0056b3;font-size:11px;font-weight:700;padding:2px 6px;border-radius:12px}
.cardx .price{font-weight:600;color:#d32f2f}
.cardx .actions{display:flex;align-items:center;justify-content:space-between}
.btn-gift{background:#fff;border:1.5px solid var(--main);color:var(--main);font-weight:600;padding:6px 12px;border-radius:999px;font-size:12px;line-height:1;text-decoration:none}
.btn-gift:hover{background:#fff0f6;color:var(--main-600)}
.add-btn{border:none;background:var(--grad);color:#fff;border-radius:50%;width:32px;height:32px;font-size:18px;font-weight:800}

/* Ads box */
.ads-box .link-preview{display:flex;gap:10px;background:#fff;border:1px solid #e3f2fd;border-radius:10px;padding:10px;box-shadow:var(--shadow-sm);text-decoration:none}
.ads-box .thumb{width:48px;height:48px;border-radius:8px;object-fit:cover;background:#f1f4ff}
.ads-box .title{font-weight:700;color:var(--main)}
.ads-box .desc{font-size:12px;color:var(--muted)}

/* FABs */
.fab{position:fixed;right:16px;width:54px;height:54px;border:none;border-radius:50%;color:#fff;font-size:22px;box-shadow:0 6px 16px rgba(0,0,0,.25);z-index:1055;display:flex;align-items:center;justify-content:center}
#filterFab{background:#6c757d;bottom:212px}
#cartFab{background:var(--grad);bottom:148px}
#suppliersFab{background:#0d6efd;bottom:84px}
#zaloFab{background:#25D366;bottom:20px}
.fab .badge{position:absolute;top:-6px;right:-6px;background:#d32f2f;color:#fff;border-radius:999px;padding:2px 6px;font-size:12px;font-weight:700;display:none}

/* Footer */
.site-footer{background:#fff;border-top:1px solid #eee;padding:16px 0;margin-top:20px;font-size:13px;color:#555}
footer.text-light{background:var(--grad);color:#fff}
footer .accent{color:#d4af37}

/* Error toast */
#errbox{position:fixed;left:8px;right:8px;bottom:8px;z-index:3000;background:#ffefef;border:1px solid #e99;border-radius:8px;padding:8px;display:none;white-space:pre-wrap;font-family:ui-monospace,Consolas,monospace}

@media (max-width:1200px){.category-grid{grid-template-columns:repeat(5,1fr)}}
@media (max-width:992px){.category-grid{grid-template-columns:repeat(4,1fr)}}
@media (max-width:768px){.category-grid{grid-template-columns:repeat(3,1fr)}}
@media (max-width:576px){.category-grid{grid-template-columns:repeat(2,1fr)}}

#adsBox { display:block !important; visibility:visible !important; opacity:1 !important; }
   
</style>
</head>
<body>
<header class="site-header">
  <div class="wrap">
    <a id="logoLink" href="#" class="d-flex align-items-center text-decoration-none">
      <img src="https://drive.google.com/thumbnail?id=1e9N6rgsTP5vYtKl4Lwq801dfteYLbx_F&sz=w160" class="logo" alt="2606AI logo">
    </a>
    <form class="header-search d-flex gap-2 m-0" onsubmit="return false;">
      <div class="input-group w-100">
        <input id="searchBox" class="form-control" placeholder="T√¨m s·∫£n ph·∫©m... (ID, m√¥ t·∫£)">
        <button id="searchBtn" class="btn btn-primary" type="button">T√¨m</button>
      </div>
    </form>
  </div>
</header>

<div class="top-banner" role="region" aria-label="Th√¥ng b√°o">
  <div class="wrap"><div class="marquee">Ngu·ªìn thu c·ªßa 2606AI.VN ƒë·∫øn t·ª´ qu·∫£ng c√°o ‚Ä¢ ƒê√£ ch·ªët ƒë∆°n vui l√≤ng th√¥ng b√°o 2606AI.VN ‚Ä¢ T·ª± tin s·∫£n xu·∫•t m·ªçi s·∫£n ph·∫©m</div></div>
</div>

<div class="container-fluid my-3">
  <div class="row g-3">
    <aside class="col-lg-3 col-md-4">
      <div class="sidebar-box benefits">
        <h6 class="mb-2">Ch√∫ng t√¥i c√≥ g√¨ cho b·∫°n...</h6>
        <div class="grid">
          <div class="item"><div class="ic">üß©</div><div><div class="ttl">10,000+ m·∫´u s·∫£n ph·∫©m</div><div class="sub">Kh√¥ng lo thi·∫øu √Ω t∆∞·ªüng</div></div></div>
          <div class="item"><div class="ic">üè≠</div><div><div class="ttl">500+ nh√† cung c·∫•p</div><div class="sub">B√°o gi√° nhanh ‚Äì ƒëa d·∫°ng</div></div></div>
          <div class="item"><div class="ic">üí¨</div><div><div class="ttl">T∆∞ v·∫•n s·∫£n xu·∫•t</div><div class="sub">Mi·ªÖn ph√≠, ph·∫£n h·ªìi nhanh</div></div></div>
          <div class="item"><div class="ic">üé®</div><div><div class="ttl">Thi·∫øt k·∫ø 2D/3D</div><div class="sub">Mi·ªÖn ph√≠ cho ƒë∆°n ƒë√£ ch·ªët</div></div></div>
          <div class="item"><div class="ic">üì¶</div><div><div class="ttl">H·∫≠u c·∫ßn ‚Äì ƒë√≥ng g√≥i</div><div class="sub">C√≥ ph√≠, chuy√™n nghi·ªáp</div></div></div>
          <div class="item"><div class="ic">üõ°Ô∏è</div><div><div class="ttl">H·ªó tr·ª£ tranh ch·∫•p</div><div class="sub">C√≥ ph√≠ khi c·∫ßn</div></div></div>
        </div>
      </div>

      <div id="adsBox" class="sidebar-box ads-box">
        <h6 class="fw-bold mb-2 d-flex align-items-center justify-content-between">
          <span>X∆∞·ªüng ƒë·ªÅ xu·∫•t <span id="adsCount" class="badge rounded-pill text-bg-primary" style="display:none">0</span></span>
        </h6>
        <div id="adsList" class="d-flex flex-column gap-2"></div>
        <div id="adsEmpty" class="small text-muted">ƒêang t·∫£i d·ªØ li·ªáu‚Ä¶</div>
        <div class="mt-2 text-center">
          <a id="adsContactBtn" href="#" target="_blank" rel="noopener" class="btn btn-sm fw-bold px-3" style="border-radius:999px;background:#ffca28;color:#0d47a1;border:none">üì¢ LI√äN H·ªÜ ƒê·∫∂T QU·∫¢NG C√ÅO</a>
        </div>
      </div>
    </aside>

    <main class="col-lg-9 col-md-8">
      <!-- Hero -->
      <div class="row g-2 mb-2">
        <div class="col-md-8">
          <div id="heroMain" class="carousel slide" data-bs-ride="carousel" data-bs-interval="4000">
            <div class="carousel-inner">
              <div class="carousel-item active"><img class="d-block w-100" src="https://picsum.photos/1200/300?random=11" alt="Banner 1"></div>
              <div class="carousel-item"><img class="d-block w-100" src="https://picsum.photos/1200/300?random=12" alt="Banner 2"></div>
              <div class="carousel-item"><img class="d-block w-100" src="https://picsum.photos/1200/300?random=13" alt="Banner 3"></div>
            </div>
            <button class="carousel-control-prev" type="button" data-bs-target="#heroMain" data-bs-slide="prev"><span class="carousel-control-prev-icon"></span></button>
            <button class="carousel-control-next" type="button" data-bs-target="#heroMain" data-bs-slide="next"><span class="carousel-control-next-icon"></span></button>
          </div>
        </div>
        <div class="col-md-4 d-flex flex-column gap-2">
          <img src="https://picsum.photos/600/145?random=21" alt="promo"/>
          <img src="https://picsum.photos/600/145?random=22" alt="promo"/>
        </div>
      </div>

      <!-- Groups + Categories -->
      <section class="category-box mb-3">
        <div id="groupBar" class="group-bar"></div>
        <div class="mt-2">
          <div id="categoryGrid" class="category-grid"></div>
        </div>
      </section>

      <!-- Stats + Pager -->
      <div class="stats-row">
        <div class="found-count">
          <span>T√¨m th·∫•y</span>
          <span id="totalCount" class="badge text-bg-primary">0</span>
          <button id="clearFilters" class="btn btn-sm btn-outline-danger ms-2">X√≥a b·ªô l·ªçc</button>
        </div>
        <div id="pagerTop" class="pager"></div>
      </div>

      <!-- Grid -->
      <div id="productGrid" class="row row-cols-2 row-cols-md-3 row-cols-lg-6 g-2" aria-live="polite"></div>
      <div id="pagerBottom" class="pager mt-3 text-end"></div>

      <!-- Footer ads -->
      <div class="my-3">
        <img src="https://picsum.photos/1200/200?random=91" class="w-100 rounded-3 shadow-sm" alt="ads"/>
      </div>
    </main>
  </div>
</div>

<!-- Offcanvas: Cart -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="cartCanvas">
  <div class="offcanvas-header">
    <h5 class="mb-0">Gi·ªè h√†ng</h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
  </div>
  <div class="offcanvas-body">
    <div id="cartList"></div>
    <div class="d-flex justify-content-between align-items-center border rounded-3 p-2 my-2 bg-light">
      <span>T·ªïng c·ªông</span><span id="cartTotal" class="fw-bold text-danger">0 ƒë</span>
    </div>
    <input id="buyerName" class="form-control mb-2" placeholder="H·ªç v√† t√™n">
    <input id="buyerEmail" class="form-control mb-2" placeholder="Email">
    <input id="buyerPhone" class="form-control mb-2" placeholder="S·ªë ƒëi·ªán tho·∫°i">
    <input id="buyerAddress" class="form-control mb-2" placeholder="ƒê·ªãa ch·ªâ nh·∫≠n h√†ng">
    <textarea id="buyerNote" class="form-control mb-2" placeholder="Ghi ch√∫"></textarea>
    <button class="btn btn-success w-100" id="submitOrderBtn">G·ª≠i ƒë∆°n h√†ng</button>
  </div>
</div>

<!-- Offcanvas: Filters -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="filterPanel">
  <div class="offcanvas-header">
    <h5 class="mb-0">B·ªô l·ªçc</h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
  </div>
  <div class="offcanvas-body">
    <h6>TYPE</h6><div id="typeBox" class="mb-3"></div>
    <h6>LO·∫†I</h6><div id="loaiBox" class="mb-3"></div>
    <h6>CH√ö √ù</h6><div id="noteBox" class="mb-3"></div>
    <h6>DANH M·ª§C</h6><div id="brandBox" class="mb-3"></div>
  </div>
</div>

<!-- Offcanvas: Suppliers (ƒë∆°n gi·∫£n) -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="suppliersCanvas">
  <div class="offcanvas-header">
    <h5 class="mb-0">Danh s√°ch x∆∞·ªüng</h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
  </div>
  <div class="offcanvas-body">
    <div id="suppliersList">Ch∆∞a c√≥ d·ªØ li·ªáu.</div>
  </div>
</div>

<!-- FABs -->
<button id="filterFab" class="fab" title="B·ªô l·ªçc">‚öôÔ∏è</button>
<button id="cartFab" class="fab" title="Gi·ªè h√†ng">üõí <span id="cartFabCount" class="badge">0</span></button>
<button id="suppliersFab" class="fab" title="X∆∞·ªüng">üè≠</button>
<a id="zaloFab" class="fab" title="Zalo" href="#" target="_blank" rel="noopener">üí¨</a>

<div id="errbox" role="alert" aria-live="assertive"></div>

<!-- Footer -->
<footer class="text-light mt-4">
  <div class="container py-4">
    <div class="row g-4">
      <div class="col-md-3 text-center">
        <img src="https://drive.google.com/uc?export=view&id=1e9N6rgsTP5vYtKl4Lwq801dfteYLbx_F" alt="logo" style="max-width:160px" class="mb-2 mx-auto d-block"/>
        <p class="small mb-0">H·ªó tr·ª£ s·∫£n xu·∫•t ·∫•n ph·∫©m th∆∞∆°ng hi·ªáu t·ª´ thi·∫øt k·∫ø ƒë·∫øn th√†nh ph·∫©m.</p>
      </div>
      <div class="col-md-3">
        <h6 class="accent fw-bold text-uppercase mb-2">Li√™n k·∫øt nhanh</h6>
        <ul class="list-unstyled small mb-0">
          <li><a class="link-light text-decoration-none" href="#">V·ªÅ ch√∫ng t√¥i</a></li>
          <li><a class="link-light text-decoration-none" href="#">Danh m·ª•c s·∫£n ph·∫©m</a></li>
          <li><a class="link-light text-decoration-none" href="#">B√°o gi√° nhanh</a></li>
          <li><a class="link-light text-decoration-none" href="#">C√¢u h·ªèi th∆∞·ªùng g·∫∑p</a></li>
        </ul>
      </div>
      <div class="col-md-3">
        <h6 class="accent fw-bold text-uppercase mb-2">Ch√≠nh s√°ch</h6>
        <ul class="list-unstyled small mb-0">
          <li><a class="link-light text-decoration-none" href="#">V·∫≠n chuy·ªÉn</a></li>
          <li><a class="link-light text-decoration-none" href="#">ƒê·ªïi tr·∫£</a></li>
          <li><a class="link-light text-decoration-none" href="#">H∆∞·ªõng d·∫´n ƒë·∫∑t h√†ng</a></li>
          <li><a class="link-light text-decoration-none" href="#">B·∫£o m·∫≠t</a></li>
        </ul>
      </div>
      <div class="col-md-3 small">
        <h6 class="accent fw-bold text-uppercase mb-2">Li√™n h·ªá</h6>
        <div class="mb-2"><i class="bi bi-geo-alt me-1"></i> 123 ƒê∆∞·ªùng ABC, Q1, TP.HCM</div>
        <div class="mb-2"><i class="bi bi-telephone me-1"></i> <a class="link-light text-decoration-none" href="tel:0909123456">0909 123 456</a></div>
        <div class="mb-2"><i class="bi bi-envelope me-1"></i> <a class="link-light text-decoration-none" href="mailto:info@2606ai.vn">info@2606ai.vn</a></div>
      </div>
    </div>
    <hr class="border-light opacity-50 my-3">
    <div class="text-center small">¬© 2025 <span class="accent">2606AI</span>. Ph√°t tri·ªÉn b·ªüi 2606AI.</div>
  </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
/* =====================================
   2606AI LITE ‚Äì JS t·ªëi gi·∫£n, b·ªè ph·∫ßn th·ª´a
   ===================================== */
// ==== Config ====
const API_URL = "https://script.google.com/macros/s/AKfycby2PjYOKiRRphQCOI9eSDo8ShAY-Bugp_gQD7JjgJPaYE7fmaoDjbP4kXGWLpOQxWOh/exec"; // gi·ªØ nguy√™n
const ZALO_URL = "https://zalo.me/123456789";

// ==== State ====
const state = { page:1, pageSize:36, q:"", group:"", type:"", loai:"", note:"", category:"", totalPages:1 };
const products = {}; const cart = [];

// ==== Utils ====
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));
const esc = s => (s??'').toString().replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
const fmtVND = n => (Number(n)||0).toLocaleString('vi-VN') + ' ƒë';
const firstLink = s => { if(!s) return ''; const parts=String(s).split(/[\s,;|\n]+/).filter(Boolean); for(const p of parts) if(/^https?:\/\//i.test(p)) return p; return '' };

// ==== Group & Category config (nh·∫π) ====
const GROUPS = [
  'QU√Ä T·∫∂NG ·∫§N PH·∫®M TH∆Ø∆†NG HI·ªÜU','QU√Ä T·∫∂NG S·∫¢N PH·∫®M TH∆Ø∆†NG HI·ªÜU','QU√Ä T·∫∂NG K·ª∂ NI·ªÜM EVENT','PH·ª§ KI·ªÜN TH∆Ø∆†NG HI·ªÜU','ƒê·ªêI T√ÅC 247 EXPRESS','KH√ÅC'
];
const GROUP_ICONS = {
  'QU√Ä T·∫∂NG ·∫§N PH·∫®M TH∆Ø∆†NG HI·ªÜU':'https://img.icons8.com/fluency/96/advertising.png',
  'QU√Ä T·∫∂NG S·∫¢N PH·∫®M TH∆Ø∆†NG HI·ªÜU':'https://img.icons8.com/fluency/96/product.png',
  'QU√Ä T·∫∂NG K·ª∂ NI·ªÜM EVENT':'https://img.icons8.com/fluency/96/conference-foreground-selected.png',
  'PH·ª§ KI·ªÜN TH∆Ø∆†NG HI·ªÜU':'https://img.icons8.com/fluency/96/electronics.png',
  'ƒê·ªêI T√ÅC 247 EXPRESS':'https://drive.google.com/thumbnail?id=1ixc_p6X925a0JpSG4YIWwpyauVmhRakI&sz=w200',
  'KH√ÅC':'https://img.icons8.com/fluency/96/more.png'
};
const CAT_CONFIG = [
  {label:'Huy ch∆∞∆°ng ph√¥i s·∫µn', category:'Huy ch∆∞∆°ng ph√¥i s·∫µn'},
  {label:'Huy ch∆∞∆°ng ch·∫°y b·ªô', category:'Huy ch∆∞∆°ng s·ª± ki·ªán ch·∫°y b·ªô'},
  {label:'M√≥c kh√≥a cao su', category:'M√≥c kh√≥a cao su'},
  {label:'M√≥c kh√≥a h·ª£p kim', category:'M√≥c kh√≥a h·ª£p kim'},
  {label:'M√≥c kh√≥a T·∫øt 2025', category:'M√≥c kh√≥a t·∫øt 2025'},
  {label:'M√≥c kh√≥a T·∫øt 2026', category:'M√≥c kh√≥a t·∫øt 2026'},
  {label:'M√≥c kh√≥a T·∫øt 2027', category:'M√≥c kh√≥a t·∫øt 2027'},
  {label:'M√≥c kh√≥a T·∫øt 2030', category:'M√≥c kh√≥a t·∫øt 2030'},
  {label:'M√≥c kh√≥a T·∫øt 2031', category:'M√≥c kh√≥a t·∫øt 2031'},
  {label:'M√≥c kh√≥a T·∫øt 2032', category:'M√≥c kh√≥a t·∫øt 2032'},
  {label:'M√≥c kh√≥a T·∫øt 2036', category:'M√≥c kh√≥a t·∫øt 2036'},
  {label:'Kh√°c', category:'Kh√°c'}
];

const FALLBACK_ICON = 'https://placehold.co/64x64?text=%20&bg=E8F5E9&fc=2E7D32';
function toDriveThumb(u){
  if (!u) return FALLBACK_ICON;
  const m = String(u).match(/\/d\/([^/]+)\//);
  if (m && m[1]) return `https://drive.google.com/thumbnail?id=${m[1]}&sz=w200`;
  if (/drive\.google\.com\/thumbnail\?id=/i.test(u)) return u;
  return u;
}
function safeImg(u){
  if (!u) return FALLBACK_ICON;
  const url = toDriveThumb(u);
  return /^https?:\/\//i.test(url) ? url : FALLBACK_ICON;
}

   
// ==== Renderers ====
function renderGroups(){
  const html = GROUPS.map(g=>`<button class="group-chip ${state.group===g?'active':''}" data-action="set-group" data-val="${esc(g)}">\n    <img src="${esc(GROUP_ICONS[g]||GROUP_ICONS['KH√ÅC'])}" alt=""/>\n    <span>${esc(g)}</span>\n  </button>`).join('');
  $('#groupBar').innerHTML = html;
}
function renderCategories(){
  $('#categoryGrid').innerHTML = CAT_CONFIG.map(c=>`
    <a class="category-item ${state.category===c.category?'active':''}" data-action="set-category" data-val="${esc(c.category)}">
      <span class="icon"><img src="https://drive.google.com/thumbnail?id=1e9N6rgsTP5vYtKl4Lwq801dfteYLbx_F&sz=w200" alt=""></span>
      <span class="label">${esc(c.label)}</span>
    </a>`).join('');
}

function productCard(it){
  products[it.id] = it; const gift = firstLink(it.imageClick);
  return `<div class="col"><div class="cardx">\n    <div class="position-relative"><a href="${esc(it.linkFull||it.img||'#')}" target="_blank" rel="noopener"><img class="thumb" src="${esc(it.img)}" alt="${esc(it.id)}" onerror="this.src='https://placehold.co/600x400'"/></a>${it.note?`<span class='note'>${esc(it.note)}</span>`:''}</div>\n    <div class="meta">\n      <div class="id">${esc(it.id)}</div>\n      <div class="details">${esc(it.details||'')}</div>\n      ${it.type?`<div class="type">${esc(it.type)}</div>`:''}\n      <div class="price">${fmtVND(it.price)}</div>\n      <div class="actions">\n        ${gift?`<a class="btn-gift" href="${esc(gift)}" target="_blank" rel="noopener">${esc(it.loai||'Nh·∫≠n qu√†')}</a>`:'<span></span>'}\n        <button class="add-btn" data-action="add-to-cart" data-id="${esc(it.id)}">+</button>\n      </div>\n    </div>\n  </div></div>`;
}

function renderPagination(total){
  const totalPages = Math.max(1, Math.ceil((total||0)/(state.pageSize||1))); state.totalPages = totalPages;
  const block = where => `\n    <div class='d-inline-flex align-items-center gap-1' data-where='${where}'>\n      <button class='btn btn-sm btn-outline-secondary' data-action='page-prev' ${state.page<=1?'disabled':''}>&lsaquo;</button>\n      <select class='form-select form-select-sm page-select' style='width:auto'>\n        ${Array.from({length:totalPages},(_,i)=>{const p=i+1;return `<option value='${p}' ${p===state.page?'selected':''}>Trang ${p}/${totalPages}</option>`}).join('')}\n      </select>\n      <button class='btn btn-sm btn-outline-secondary' data-action='page-next' ${state.page>=totalPages?'disabled':''}>&rsaquo;</button>\n    </div>`;
  $('#pagerTop').innerHTML = block('top');
  $('#pagerBottom').innerHTML = block('bottom');
  $$('#pagerTop .page-select, #pagerBottom .page-select').forEach(sel=> sel.onchange = e=>{ state.page = +e.target.value||1; fetchPage(); });
}

function renderAds(items){
  const list   = document.getElementById('adsList');
  const badge  = document.getElementById('adsCount');
  const empty  = document.getElementById('adsEmpty');
  const adsBox = document.getElementById('adsBox');

  // B·∫£o ƒë·∫£m box lu√¥n hi·ªán
  if (adsBox) adsBox.style.display = 'block';

  // Fallback demo n·∫øu r·ªóng
  const data = (Array.isArray(items) && items.length)
    ? items
    : [
        { title:'X∆∞·ªüng A ‚Äì UV Kim Lo·∫°i', desc:'Nh·∫≠n in UV badge/huy hi·ªáu s·ªë l∆∞·ª£ng nh·ªè', url:'#', img:'https://picsum.photos/96?1' },
        { title:'X∆∞·ªüng B ‚Äì ƒê√∫c H·ª£p Kim', desc:'Huy ch∆∞∆°ng 3D, m·∫° v√†ng/niken', url:'#', img:'https://picsum.photos/96?2' },
      ];

  list.innerHTML = data.map(it => `
    <a class="link-preview text-decoration-none" href="${esc(it.url||'#')}" target="_blank" rel="noopener">
      <img class="thumb" src="${esc(safeImg(it.img))}" alt="">
      <div class="flex-grow-1 small">
        <div class="title">${esc(it.title||'X∆∞·ªüng ƒë·ªÅ xu·∫•t')}</div>
        ${it.desc ? `<div class="desc">${esc(it.desc)}</div>` : ''}
      </div>
    </a>
  `).join('');

  const n = data.length;
  if (badge){ badge.textContent = n; badge.style.display = n ? 'inline-block' : 'none'; }
  if (empty){ empty.style.display = n ? 'none' : 'block'; }
}


// ==== Data fetching ====
let _timer = 0; const DEBOUNCE = 160;
function fetchPage(){ clearTimeout(_timer); _timer = setTimeout(_doFetch, DEBOUNCE); }

async function _doFetch(){
  const qs = new URLSearchParams({
    action:'list', page:state.page, pageSize:state.pageSize,
    q:state.q, group:state.group, type:state.type, loai:state.loai, note:state.note, category:state.category
  });
  try{
    const res = await fetch(API_URL + '?' + qs.toString(), {mode:'cors'});
    const raw = await res.text();
    let json; try{ json = JSON.parse(raw); }catch{ json = JSON.parse(raw.replace(/^\)\]\}'[^\n]*\n?/, '').replace(/^\uFEFF/, '').trim()); }
    const items = json.items || []; const facets = json.facets || {}; const total = json.total || items.length;
    $('#productGrid').innerHTML = items.length ? items.map(productCard).join('') : '<div class="text-muted">Kh√¥ng c√≥ d·ªØ li·ªáu.</div>';
    $('#totalCount').textContent = Number(total).toLocaleString('vi-VN');
    renderPagination(total);
    buildFilterBox('typeBox', facets.types||[], 'type');
    buildFilterBox('loaiBox', facets.loais||[], 'loai');
    buildFilterBox('noteBox', facets.notes||[], 'note');
    buildFilterBox('brandBox', facets.categories||[], 'category');
    // ads theo ng·ªØ c·∫£nh
    fetchAds();
  }catch(err){
    $('#errbox').style.display='block'; $('#errbox').textContent='[ERROR] Kh√¥ng t·∫£i ƒë∆∞·ª£c d·ªØ li·ªáu.';
  }
}

function buildFilterBox(id, items, field){
  const box = document.getElementById(id); if(!box) return;
  box.classList.add('d-flex','flex-wrap','gap-2');
  box.innerHTML = (items||[]).map(val=>`<button class='btn btn-sm ${state[field]===val?'btn-primary':'btn-outline-secondary'}' data-action='set-filter' data-field='${field}' data-val='${esc(val)}'>${esc(val)}</button>`).join('');
}

// ==== Ads ====
async function fetchAds(){
  try{
    const qs = new URLSearchParams({action:'ads', q:state.q, group:state.group, type:state.type, loai:state.loai, note:state.note, category:state.category});
    const r = await fetch(API_URL + '?' + qs.toString(), {mode:'cors'});
    const j = await r.json(); renderAds(j.items||[]);
  }catch{ renderAds([]); }
}

// ==== Cart ====
function updateCart(){
  const list = $('#cartList'); let total=0;
  list.innerHTML = cart.map(it=>{ const sub=it.qty*(+it.price||0); total+=sub; return `
    <div class='d-flex align-items-center gap-2 border-bottom py-2'>
      <img src='${esc(it.img)}' alt='' style='width:50px;height:50px;object-fit:cover;border-radius:6px;border:1px solid #eee'>
      <div class='flex-grow-1'>
        <div class='fw-semibold small text-truncate'>${esc(it.details||it.id)}</div>
        <div class='text-muted small'>${fmtVND(it.price)}</div>
      </div>
      <div class='d-flex align-items-center gap-1'>
        <button class='btn btn-sm btn-outline-secondary' data-action='qty' data-id='${esc(it.id)}' data-delta='-1'>-</button>
        <span>${it.qty}</span>
        <button class='btn btn-sm btn-outline-secondary' data-action='qty' data-id='${esc(it.id)}' data-delta='1'>+</button>
      </div>
      <div style='min-width:90px;text-align:right' class='small'>${fmtVND(sub)}</div>
      <button class='btn btn-sm btn-link text-danger' data-action='remove' data-id='${esc(it.id)}'>&times;</button>
    </div>`; }).join('');
  $('#cartTotal').textContent = fmtVND(total);
  const count = cart.reduce((a,b)=>a+b.qty,0); const b = $('#cartFabCount'); b.textContent = count; b.style.display = count? 'inline-block':'none';
}
function addToCartById(id){ const it=products[id]; if(!it) return; const f=cart.find(p=>p.id===id); if(f) f.qty++; else cart.push({...it,qty:1}); updateCart(); cartCanvas.toggle(); }
function changeQty(id,delta){ const it=cart.find(p=>p.id===id); if(!it) return; it.qty+=delta; if(it.qty<=0) cart.splice(cart.indexOf(it),1); updateCart(); }
function removeItem(id){ const i=cart.findIndex(p=>p.id===id); if(i>=0) cart.splice(i,1); updateCart(); }

async function submitOrder(){
  if(!cart.length){ alert('Gi·ªè h√†ng tr·ªëng!'); return; }
  const name=$('#buyerName').value.trim(), email=$('#buyerEmail').value.trim(), phone=$('#buyerPhone').value.trim(), address=$('#buyerAddress').value.trim(), note=$('#buyerNote').value.trim();
  if(!name||!email||!phone||!address){ alert('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin!'); return; }
  const order={ customer:{name,email,phone,address,note}, items:cart.map(({id,details,type,price,qty,img,linkFull,group,loai,category,note})=>({id,details,type,price,qty,img,linkFull,group,loai,category,note})), total:cart.reduce((a,b)=>a+b.qty*(+b.price||0),0) };
  try{
    const r = await fetch(API_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({action:'order', data:order}) });
    const j = await r.json(); if(j && (j.ok||j.success)){ alert('ƒê√£ g·ª≠i ƒë∆°n h√†ng th√†nh c√¥ng!'); cart.length=0; updateCart(); } else { alert('G·ª≠i ƒë∆°n h√†ng th·∫•t b·∫°i.'); }
  }catch{ alert('Kh√¥ng th·ªÉ g·ª≠i ƒë∆°n h√†ng. Ki·ªÉm tra API_URL.'); }
}

// ==== Events (delegation) ====
const cartCanvas = bootstrap.Offcanvas.getOrCreateInstance(document.getElementById('cartCanvas'));
const filterCanvas = bootstrap.Offcanvas.getOrCreateInstance(document.getElementById('filterPanel'));
const suppliersCanvas = bootstrap.Offcanvas.getOrCreateInstance(document.getElementById('suppliersCanvas'));

document.addEventListener('click', e=>{
  const el = e.target;
  if(el.matches('#searchBtn')){ state.q = $('#searchBox').value.trim(); state.page=1; fetchPage(); }
  if(el.matches('[data-action="page-prev"]')){ if(state.page>1){ state.page--; fetchPage(); } }
  if(el.matches('[data-action="page-next"]')){ if(state.page<state.totalPages){ state.page++; fetchPage(); } }
  if(el.matches('[data-action="set-group"]')){ state.group = el.dataset.val || ''; state.page=1; renderGroups(); fetchPage(); }
  if(el.closest('[data-action="set-category"]')){ const x=el.closest('[data-action="set-category"]'); state.category=x.dataset.val||''; state.page=1; renderCategories(); fetchPage(); }
  if(el.matches('[data-action="set-filter"]')){ const f=el.dataset.field; state[f] = el.dataset.val||''; state.page=1; fetchPage(); }
  if(el.matches('[data-action="add-to-cart"]')){ addToCartById(el.dataset.id); }
  if(el.matches('[data-action="qty"]')){ changeQty(el.dataset.id, +(el.dataset.delta||0)); }
  if(el.matches('[data-action="remove"]')){ removeItem(el.dataset.id); }
  if(el.matches('#clearFilters')){ Object.assign(state,{q:'',group:'',type:'',loai:'',note:'',category:'',page:1}); $('#searchBox').value=''; renderGroups(); renderCategories(); fetchPage(); }
  if(el.matches('#submitOrderBtn')){ submitOrder(); }
  if(el.matches('#cartFab')){ cartCanvas.toggle(); }
  if(el.matches('#filterFab')){ filterCanvas.toggle(); }
  if(el.matches('#suppliersFab')){ suppliersCanvas.show(); }
});

// Keyboard: Enter to search
$('#searchBox').addEventListener('keydown',e=>{ if(e.key==='Enter'){ e.preventDefault(); $('#searchBtn').click(); }});

// Init
$('#zaloFab').href = ZALO_URL; $('#adsContactBtn').href = ZALO_URL;
$('#logoLink').addEventListener('click', e=>{ e.preventDefault(); window.scrollTo({top:0,behavior:'smooth'}); setTimeout(()=>location.reload(),150); });
renderGroups(); renderCategories(); fetchPage();
</script>
</body>
</html>
